<a href="card_cudax.cu" style="font-family: monospace;">Raw source</a>
<hr/> 

<pre style="color:#000000;background:#ffffff;"><span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">math.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdio.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdlib.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">windows.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">sysinfoapi.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#696969; ">// #include "cpu_bitmap.h"</span>

<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> DIM 512</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> BPP 3</span>

<span style="color:#800000; font-weight:bold; ">struct</span> v <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> x<span style="color:#808030; ">,</span> y<span style="color:#808030; ">,</span> z<span style="color:#800080; ">;</span>
 __device__  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">+</span><span style="color:#808030; ">(</span>v r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>x <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> y <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
 __device__  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">*</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">,</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
 __device__  <span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">%</span><span style="color:#808030; ">(</span>v r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
 __device__  v<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span><span style="color:#800080; ">}</span>
 __device__  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">^</span><span style="color:#808030; ">(</span>v r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z <span style="color:#808030; ">-</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">-</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">-</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  __device__ v<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> a<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> b<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> c<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    x <span style="color:#808030; ">=</span> a<span style="color:#800080; ">;</span>
    y <span style="color:#808030; ">=</span> b<span style="color:#800080; ">;</span>
    z <span style="color:#808030; ">=</span> c<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  __device__ v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">!</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">/</span> <span style="color:#603000; ">sqrt</span><span style="color:#808030; ">(</span><span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">%</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>

__device__ <span style="color:#800000; font-weight:bold; ">int</span> G<span style="color:#808030; ">[</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> <span style="color:#800080; ">{</span><span style="color:#008c00; ">247570</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">280596</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">280600</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">249748</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18578</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18577</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">231184</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>

__shared__ <span style="color:#800000; font-weight:bold; ">int</span> g_seed<span style="color:#800080; ">;</span>
__device__ <span style="color:#800000; font-weight:bold; ">float</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  g_seed <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">214013</span><span style="color:#808030; ">*</span>g_seed<span style="color:#808030; ">+</span><span style="color:#008c00; ">2531011</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>g_seed<span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span><span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span><span style="color:#808030; ">&amp;</span><span style="color:#008000; ">0x7FFF</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">/</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span><span style="color:#808030; ">)</span><span style="color:#008c00; ">66635</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">//The intersection test for line [o,v].</span>
<span style="color:#696969; ">// Return 2 if a hit was found (and also return distance t and bouncing ray n).</span>
<span style="color:#696969; ">// Return 0 if no hit was found but ray goes upward</span>
<span style="color:#696969; ">// Return 1 if no hit was found but ray goes downward</span>
__device__ <span style="color:#800000; font-weight:bold; ">int</span> TraceRay<span style="color:#808030; ">(</span>v origin<span style="color:#808030; ">,</span> v destination<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#808030; ">&amp;</span>t<span style="color:#808030; ">,</span> v <span style="color:#808030; ">&amp;</span>normal<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  t <span style="color:#808030; ">=</span> <span style="color:#008000; ">1e9</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> m <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">float</span> p <span style="color:#808030; ">=</span> <span style="color:#808030; ">-</span>origin<span style="color:#808030; ">.</span>z <span style="color:#808030; ">/</span> destination<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#008000; ">.01</span> <span style="color:#808030; ">&lt;</span> p<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      t <span style="color:#808030; ">=</span> p<span style="color:#800080; ">;</span>
      normal <span style="color:#808030; ">=</span> v<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      m <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> k <span style="color:#808030; ">=</span> <span style="color:#008c00; ">19</span><span style="color:#800080; ">;</span> k<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> j <span style="color:#808030; ">=</span> <span style="color:#008c00; ">9</span><span style="color:#800080; ">;</span> j<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>G<span style="color:#808030; ">[</span>j<span style="color:#808030; ">]</span> <span style="color:#808030; ">&amp;</span> <span style="color:#008c00; ">1</span> <span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span> k<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
        v p <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> v<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span>k<span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>j <span style="color:#808030; ">-</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
        <span style="color:#800000; font-weight:bold; ">float</span> b <span style="color:#808030; ">=</span> p <span style="color:#808030; ">%</span> destination<span style="color:#800080; ">;</span>
        <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> p <span style="color:#808030; ">%</span> p <span style="color:#808030; ">-</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
        <span style="color:#800000; font-weight:bold; ">float</span> q <span style="color:#808030; ">=</span> b <span style="color:#808030; ">*</span> b <span style="color:#808030; ">-</span> c<span style="color:#800080; ">;</span>

          <span style="color:#696969; ">//Does the ray hit the sphere ?</span>
        <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>q <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
          <span style="color:#800000; font-weight:bold; ">float</span> s <span style="color:#808030; ">=</span> <span style="color:#808030; ">-</span>b <span style="color:#808030; ">-</span> <span style="color:#603000; ">sqrt</span><span style="color:#808030; ">(</span>q<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
            <span style="color:#696969; ">//It does, compute the distance camera-sphere</span>
          <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>s <span style="color:#808030; ">&lt;</span> t <span style="color:#808030; ">&amp;</span><span style="color:#808030; ">&amp;</span> s <span style="color:#808030; ">&gt;</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
              t <span style="color:#808030; ">=</span> s<span style="color:#800080; ">;</span>
              normal <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>p <span style="color:#808030; ">+</span> destination <span style="color:#808030; ">*</span> t<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
              m <span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">;</span>
          <span style="color:#800080; ">}</span>
        <span style="color:#800080; ">}</span>
      <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> m<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

__device__ v Sample<span style="color:#808030; ">(</span>v origin<span style="color:#808030; ">,</span> v destination<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> attenuation <span style="color:#808030; ">=</span> <span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
  v pixel_color<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> r<span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span> <span style="color:#800080; ">;</span> r <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">4</span> <span style="color:#800080; ">;</span> r<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">,</span> attenuation <span style="color:#808030; ">/</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">float</span> t<span style="color:#800080; ">;</span>
    v normal<span style="color:#800080; ">;</span>

    <span style="color:#800000; font-weight:bold; ">int</span> match <span style="color:#808030; ">=</span> TraceRay<span style="color:#808030; ">(</span>origin<span style="color:#808030; ">,</span> destination<span style="color:#808030; ">,</span> t<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">!</span>match<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
        <span style="color:#696969; ">//No sphere found and the ray goes upward: Generate a sky color</span>
        <span style="color:#800000; font-weight:bold; ">return</span>  pixel_color <span style="color:#808030; ">+</span> v<span style="color:#808030; ">(</span><span style="color:#008000; ">.7</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.6</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#603000; ">pow</span><span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">-</span> destination<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> attenuation<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>

    <span style="color:#696969; ">//A sphere was maybe hit.</span>
    v intersection <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> destination <span style="color:#808030; ">*</span> t<span style="color:#800080; ">;</span>
    v light_dir <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>v<span style="color:#808030; ">(</span><span style="color:#008c00; ">9</span> <span style="color:#808030; ">+</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">9</span> <span style="color:#808030; ">+</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> intersection <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    v half_vec <span style="color:#808030; ">=</span> destination <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>normal <span style="color:#808030; ">%</span> destination <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

    <span style="color:#696969; ">//Calculated the lambertian factor</span>
    <span style="color:#800000; font-weight:bold; ">float</span> lamb_f <span style="color:#808030; ">=</span> light_dir <span style="color:#808030; ">%</span> normal<span style="color:#800080; ">;</span>

    <span style="color:#696969; ">//Calculate illumination factor (lambertian coefficient &gt; 0 or in shadow)?</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>lamb_f <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">0</span> <span style="color:#808030; ">|</span><span style="color:#808030; ">|</span> TraceRay<span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">,</span> light_dir<span style="color:#808030; ">,</span> t<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
        lamb_f <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>


    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>match <span style="color:#808030; ">&amp;</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      <span style="color:#696969; ">//No sphere was hit and the ray was going downward: Generate a floor color</span>
      intersection <span style="color:#808030; ">=</span> intersection <span style="color:#808030; ">*</span> <span style="color:#008000; ">.2</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
      v c <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span><span style="color:#808030; ">(</span><span style="color:#603000; ">ceil</span><span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> <span style="color:#603000; ">ceil</span><span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&amp;</span> <span style="color:#008c00; ">1</span> <span style="color:#800080; ">?</span>
                  v<span style="color:#808030; ">(</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">:</span>
                  v<span style="color:#808030; ">(</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>lamb_f <span style="color:#808030; ">*</span> <span style="color:#008000; ">.2</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">+</span> <span style="color:#008000; ">.1</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">return</span> pixel_color <span style="color:#808030; ">+</span> c <span style="color:#808030; ">*</span> attenuation<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>

    <span style="color:#800000; font-weight:bold; ">float</span> color <span style="color:#808030; ">=</span> <span style="color:#603000; ">pow</span><span style="color:#808030; ">(</span>light_dir <span style="color:#808030; ">%</span> half_vec <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>lamb_f <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">99</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    pixel_color <span style="color:#808030; ">=</span> pixel_color <span style="color:#808030; ">+</span> v<span style="color:#808030; ">(</span>color<span style="color:#808030; ">,</span> color<span style="color:#808030; ">,</span> color<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> attenuation<span style="color:#800080; ">;</span>
    <span style="color:#696969; ">//m == 2 A sphere was hit. Cast an ray bouncing from the sphere surface.</span>
    <span style="color:#696969; ">//Attenuate color by 50% since it is bouncing (* .5)</span>
    origin <span style="color:#808030; ">=</span> intersection<span style="color:#800080; ">;</span>
    destination <span style="color:#808030; ">=</span> half_vec<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> pixel_color<span style="color:#800080; ">;</span>
  <span style="color:#696969; ">// return v(color, color, color);// + Sample(intersection, half_vec) * .5;</span>
<span style="color:#800080; ">}</span>


__global__ <span style="color:#800000; font-weight:bold; ">void</span> GetColor<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">unsigned</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span>img<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span> blockIdx<span style="color:#808030; ">.</span>x<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> threadIdx<span style="color:#808030; ">.</span>x<span style="color:#800080; ">;</span>
v cam_dir <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span>v<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">6</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">16</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
v cam_up <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>v<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">^</span> cam_dir<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.002</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
v cam_right <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>cam_dir <span style="color:#808030; ">^</span> cam_up<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.002</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
v eye_offset <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span>cam_up <span style="color:#808030; ">+</span> cam_right<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">256</span> <span style="color:#808030; ">+</span> cam_dir<span style="color:#800080; ">;</span>
  v color<span style="color:#808030; ">(</span><span style="color:#008c00; ">13</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">13</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">13</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> r <span style="color:#808030; ">=</span> <span style="color:#008c00; ">64</span><span style="color:#800080; ">;</span> r<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
        v delta <span style="color:#808030; ">=</span> cam_up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">.5</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">99.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">+</span> cam_right <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">0.5</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">99</span><span style="color:#800080; ">;</span>
        color <span style="color:#808030; ">=</span> Sample<span style="color:#808030; ">(</span>v<span style="color:#808030; ">(</span><span style="color:#008c00; ">17</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> delta<span style="color:#808030; ">,</span>
                <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>delta <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">+</span> <span style="color:#808030; ">(</span>cam_up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> x<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> cam_right <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>y <span style="color:#808030; ">+</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> eye_offset<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">3.5</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">+</span> color<span style="color:#800080; ">;</span>
      <span style="color:#800080; ">}</span>
      img<span style="color:#808030; ">[</span>DIM <span style="color:#808030; ">*</span> y <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> x <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#808030; ">.</span>x<span style="color:#800080; ">;</span>
      img<span style="color:#808030; ">[</span>DIM <span style="color:#808030; ">*</span> y <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> x <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#808030; ">.</span>y<span style="color:#800080; ">;</span>
      img<span style="color:#808030; ">[</span>DIM <span style="color:#808030; ">*</span> y <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> x <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>


<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> gpuErrchk</span><span style="color:#808030; ">(</span><span style="color:#004a43; ">ans</span><span style="color:#808030; ">)</span><span style="color:#004a43; "> </span><span style="color:#808030; ">{</span><span style="color:#004a43; "> gpuAssert</span><span style="color:#808030; ">(</span><span style="color:#808030; ">(</span><span style="color:#004a43; ">ans</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span><span style="color:#004a43; "> __FILE__</span><span style="color:#808030; ">,</span><span style="color:#004a43; "> __LINE__</span><span style="color:#808030; ">)</span><span style="color:#808030; ">;</span><span style="color:#004a43; "> </span><span style="color:#808030; ">}</span>
<span style="color:#800000; font-weight:bold; ">inline</span> <span style="color:#800000; font-weight:bold; ">void</span> gpuAssert<span style="color:#808030; ">(</span>cudaError_t code<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">const</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span>file<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">int</span> line<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">bool</span> <span style="color:#603000; ">abort</span><span style="color:#808030; ">=</span><span style="color:#800000; font-weight:bold; ">true</span><span style="color:#808030; ">)</span>
<span style="color:#800080; ">{</span>
   <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>code <span style="color:#808030; ">!</span><span style="color:#808030; ">=</span> cudaSuccess<span style="color:#808030; ">)</span> 
   <span style="color:#800080; ">{</span>
      <span style="color:#603000; ">fprintf</span><span style="color:#808030; ">(</span><span style="color:#603000; ">stderr</span><span style="color:#808030; ">,</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">GPUassert: </span><span style="color:#007997; ">%s</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%s</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%d</span><span style="color:#0f69ff; ">\n</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> cudaGetErrorString<span style="color:#808030; ">(</span>code<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> file<span style="color:#808030; ">,</span> line<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#603000; ">abort</span><span style="color:#808030; ">)</span> <span style="color:#603000; ">exit</span><span style="color:#808030; ">(</span>code<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
   <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span>

<span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#400000; ">main</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#603000; ">DWORD</span> start_time <span style="color:#808030; ">=</span> <span style="color:#400000; ">GetTickCount</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#696969; ">// CPUBitmap bitmap( DIM, DIM );</span>
  <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">*</span> bitmap <span style="color:#808030; ">=</span> <span style="color:#800000; font-weight:bold; ">new</span> <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">[</span>DIM <span style="color:#808030; ">*</span> DIM <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">unsigned</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span>dev_bitmap<span style="color:#800080; ">;</span>

  <span style="color:#696969; ">// cudaMalloc( (void**)&amp;dev_bitmap, bitmap.image_size() );</span>
  cudaMalloc<span style="color:#808030; ">(</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span><span style="color:#808030; ">*</span><span style="color:#808030; ">)</span><span style="color:#808030; ">&amp;</span>dev_bitmap<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>DIM <span style="color:#808030; ">*</span> DIM <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  gpuErrchk<span style="color:#808030; ">(</span> cudaPeekAtLastError<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  GetColor<span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span>DIM<span style="color:#808030; ">,</span>DIM<span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span><span style="color:#808030; ">(</span>dev_bitmap<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> 
  gpuErrchk<span style="color:#808030; ">(</span> cudaDeviceSynchronize<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#696969; ">// cudaMemcpy( bitmap.get_ptr(), dev_bitmap, bitmap.image_size(), cudaMemcpyDeviceToHost );</span>
  cudaMemcpy<span style="color:#808030; ">(</span> bitmap<span style="color:#808030; ">,</span> dev_bitmap<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>DIM <span style="color:#808030; ">*</span> DIM <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> cudaMemcpyDeviceToHost <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  gpuErrchk<span style="color:#808030; ">(</span> cudaPeekAtLastError<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
 
  <span style="color:#603000; ">DWORD</span> elapsed_ms <span style="color:#808030; ">=</span> <span style="color:#400000; ">GetTickCount</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> start_time<span style="color:#800080; ">;</span>
  <span style="color:#603000; ">fprintf</span><span style="color:#808030; ">(</span><span style="color:#603000; ">stderr</span><span style="color:#808030; ">,</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">Time: </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; ">ms</span><span style="color:#0f69ff; ">\n</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> elapsed_ms<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">P6 512 512 255 </span><span style="color:#800000; ">"</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">*</span> c <span style="color:#808030; ">=</span> bitmap<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> DIM<span style="color:#800080; ">;</span> y<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span> DIM<span style="color:#800080; ">;</span> x<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      c <span style="color:#808030; ">=</span> <span style="color:#808030; ">&amp;</span>bitmap<span style="color:#808030; ">[</span>y <span style="color:#808030; ">*</span> DIM <span style="color:#808030; ">*</span> BPP  <span style="color:#808030; ">+</span> x <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
      <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> c<span style="color:#808030; ">[</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> c<span style="color:#808030; ">[</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> c<span style="color:#808030; ">[</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      c <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> BPP<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">delete</span> bitmap<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">return</span> EXIT_SUCCESS<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>
</pre>
