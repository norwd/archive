<a href="multi_thard.cpp" style="font-family: monospace;">Raw source</a>
<hr/> 

<pre style="color:#000000;background:#ffffff;"><span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">math.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdio.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdlib.h</span><span style="color:#800000; ">&gt;</span><span style="color:#004a43; "> </span><span style="color:#696969; ">// card &gt; aek.ppm</span>
<span style="color:#800000; font-weight:bold; ">typedef</span> <span style="color:#800000; font-weight:bold; ">int</span> i<span style="color:#800080; ">;</span>
<span style="color:#800000; font-weight:bold; ">typedef</span> <span style="color:#800000; font-weight:bold; ">float</span> f<span style="color:#800080; ">;</span>
<span style="color:#800000; font-weight:bold; ">struct</span> v <span style="color:#800080; ">{</span>
  f x<span style="color:#808030; ">,</span> y<span style="color:#808030; ">,</span> z<span style="color:#800080; ">;</span>
  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">+</span><span style="color:#808030; ">(</span>v r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>x <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> y <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">*</span><span style="color:#808030; ">(</span>f r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">,</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
  f <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">%</span><span style="color:#808030; ">(</span>v r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
  v<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span><span style="color:#800080; ">}</span>
  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">^</span><span style="color:#808030; ">(</span>v r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z <span style="color:#808030; ">-</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">-</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">-</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  v<span style="color:#808030; ">(</span>f a<span style="color:#808030; ">,</span> f b<span style="color:#808030; ">,</span> f c<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    x <span style="color:#808030; ">=</span> a<span style="color:#800080; ">;</span>
    y <span style="color:#808030; ">=</span> b<span style="color:#800080; ">;</span>
    z <span style="color:#808030; ">=</span> c<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  v <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">!</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">/</span> <span style="color:#603000; ">sqrt</span><span style="color:#808030; ">(</span><span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">%</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
i G<span style="color:#808030; ">[</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> <span style="color:#800080; ">{</span><span style="color:#008c00; ">247570</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">280596</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">280600</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">249748</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18578</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18577</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">231184</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>

thread_local <span style="color:#800000; font-weight:bold; ">int</span> seed <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
<span style="color:#800000; font-weight:bold; ">float</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  seed <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span> <span style="color:#008c00; ">214013</span> <span style="color:#808030; ">*</span> seed <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2531011</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>seed <span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&amp;</span> <span style="color:#008000; ">0xFFFF</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">/</span> <span style="color:#008000; ">66635.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">//The intersection test for line [o,v].</span>
<span style="color:#696969; ">// Return 2 if a hit was found (and also return distance t and bouncing ray n).</span>
<span style="color:#696969; ">// Return 0 if no hit was found but ray goes upward</span>
<span style="color:#696969; ">// Return 1 if no hit was found but ray goes downward</span>
<span style="color:#800000; font-weight:bold; ">int</span> TraceRay<span style="color:#808030; ">(</span>v origin<span style="color:#808030; ">,</span> v destination<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#808030; ">&amp;</span>t<span style="color:#808030; ">,</span> v <span style="color:#808030; ">&amp;</span>normal<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  t <span style="color:#808030; ">=</span> <span style="color:#008000; ">1e9</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> m <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">float</span> p <span style="color:#808030; ">=</span> <span style="color:#808030; ">-</span>origin<span style="color:#808030; ">.</span>z <span style="color:#808030; ">/</span> destination<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#008000; ">.01</span> <span style="color:#808030; ">&lt;</span> p<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      t <span style="color:#808030; ">=</span> p<span style="color:#800080; ">;</span>
      normal <span style="color:#808030; ">=</span> v<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      m <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> k <span style="color:#808030; ">=</span> <span style="color:#008c00; ">19</span><span style="color:#800080; ">;</span> k<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> j <span style="color:#808030; ">=</span> <span style="color:#008c00; ">9</span><span style="color:#800080; ">;</span> j<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>G<span style="color:#808030; ">[</span>j<span style="color:#808030; ">]</span> <span style="color:#808030; ">&amp;</span> <span style="color:#008c00; ">1</span> <span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span> k<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
        v p <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> v<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span>k<span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>j <span style="color:#808030; ">-</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
        <span style="color:#800000; font-weight:bold; ">float</span> b <span style="color:#808030; ">=</span> p <span style="color:#808030; ">%</span> destination<span style="color:#800080; ">;</span>
        <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> p <span style="color:#808030; ">%</span> p <span style="color:#808030; ">-</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
        <span style="color:#800000; font-weight:bold; ">float</span> q <span style="color:#808030; ">=</span> b <span style="color:#808030; ">*</span> b <span style="color:#808030; ">-</span> c<span style="color:#800080; ">;</span>

        <span style="color:#696969; ">//Does the ray hit the sphere ?</span>
        <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>q <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
          <span style="color:#800000; font-weight:bold; ">float</span> s <span style="color:#808030; ">=</span> <span style="color:#808030; ">-</span>b <span style="color:#808030; ">-</span> <span style="color:#603000; ">sqrt</span><span style="color:#808030; ">(</span>q<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
          <span style="color:#696969; ">//It does, compute the distance camera-sphere</span>
          <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>s <span style="color:#808030; ">&lt;</span> t <span style="color:#808030; ">&amp;</span><span style="color:#808030; ">&amp;</span> s <span style="color:#808030; ">&gt;</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
              t <span style="color:#808030; ">=</span> s<span style="color:#800080; ">;</span>
              normal <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>p <span style="color:#808030; ">+</span> destination <span style="color:#808030; ">*</span> t<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
              m <span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">;</span>
          <span style="color:#800080; ">}</span>
        <span style="color:#800080; ">}</span>
      <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> m<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

v Sample<span style="color:#808030; ">(</span>v origin<span style="color:#808030; ">,</span> v destination<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> t<span style="color:#800080; ">;</span>
  v normal<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> match <span style="color:#808030; ">=</span> TraceRay<span style="color:#808030; ">(</span>origin<span style="color:#808030; ">,</span> destination<span style="color:#808030; ">,</span> t<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">!</span>match<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      <span style="color:#696969; ">//No sphere found and the ray goes upward: Generate a sky color</span>
      <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span><span style="color:#008000; ">.7</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.6</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#603000; ">pow</span><span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">-</span> destination<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#696969; ">//A sphere was maybe hit.</span>
  v intersection <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> destination <span style="color:#808030; ">*</span> t<span style="color:#800080; ">;</span>
  v light_dir <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>v<span style="color:#808030; ">(</span><span style="color:#008c00; ">9</span> <span style="color:#808030; ">+</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">9</span> <span style="color:#808030; ">+</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> intersection <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  v half_vec <span style="color:#808030; ">=</span> destination <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>normal <span style="color:#808030; ">%</span> destination <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#696969; ">//Calculate the lambertian factor</span>
  <span style="color:#800000; font-weight:bold; ">float</span> lamb_f <span style="color:#808030; ">=</span> light_dir <span style="color:#808030; ">%</span> normal<span style="color:#800080; ">;</span>

  <span style="color:#696969; ">//Calculate illumination factor (lambertian coefficient &gt; 0 or in shadow)?</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>lamb_f <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">0</span> <span style="color:#808030; ">|</span><span style="color:#808030; ">|</span> TraceRay<span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">,</span> light_dir<span style="color:#808030; ">,</span> t<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      lamb_f <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">float</span> color <span style="color:#808030; ">=</span> <span style="color:#603000; ">pow</span><span style="color:#808030; ">(</span>light_dir <span style="color:#808030; ">%</span> half_vec <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>lamb_f <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">99</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>match <span style="color:#808030; ">&amp;</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#696969; ">//No sphere was hit and the ray was going downward: Generate a floor color</span>
    intersection <span style="color:#808030; ">=</span> intersection <span style="color:#808030; ">*</span> <span style="color:#008000; ">.2</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span><span style="color:#808030; ">(</span><span style="color:#603000; ">ceil</span><span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> <span style="color:#603000; ">ceil</span><span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&amp;</span> <span style="color:#008c00; ">1</span> <span style="color:#800080; ">?</span>
                  v<span style="color:#808030; ">(</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">:</span>
                  v<span style="color:#808030; ">(</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>lamb_f <span style="color:#808030; ">*</span> <span style="color:#008000; ">.2</span> <span style="color:#808030; ">+</span> <span style="color:#008000; ">.1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#696969; ">//m == 2 A sphere was hit. Cast an ray bouncing from the sphere surface.</span>
  <span style="color:#696969; ">//Attenuate color by 50% since it is bouncing (* .5)</span>
  <span style="color:#800000; font-weight:bold; ">return</span> v<span style="color:#808030; ">(</span>color<span style="color:#808030; ">,</span> color<span style="color:#808030; ">,</span> color<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> Sample<span style="color:#808030; ">(</span>intersection<span style="color:#808030; ">,</span> half_vec<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">// -------------------------------------------------------------------------------</span>
<span style="color:#696969; ">// No change before this.</span>

<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">pthread.h</span><span style="color:#800000; ">&gt;</span>
pthread_t threadIds<span style="color:#808030; ">[</span><span style="color:#008c00; ">512</span><span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
v img<span style="color:#808030; ">[</span><span style="color:#008c00; ">512</span><span style="color:#808030; ">*</span><span style="color:#008c00; ">512</span><span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
v cam_dir <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span>v<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">6</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">16</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
v cam_up <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>v<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">^</span> cam_dir<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.002</span><span style="color:#800080; ">;</span>
v cam_right <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>cam_dir <span style="color:#808030; ">^</span> cam_up<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.002</span><span style="color:#800080; ">;</span>
v eye_offset <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span>cam_up <span style="color:#808030; ">+</span> cam_right<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">256</span> <span style="color:#808030; ">+</span> cam_dir<span style="color:#800080; ">;</span>

<span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span> plotPixel<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span> <span style="color:#400000; ">arg</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">(</span><span style="color:#603000; ">size_t</span><span style="color:#808030; ">)</span><span style="color:#400000; ">arg</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span>i x <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> x<span style="color:#808030; ">&lt;</span><span style="color:#008c00; ">512</span><span style="color:#800080; ">;</span>x<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    v color<span style="color:#808030; ">(</span><span style="color:#008c00; ">13</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">13</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">13</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> r <span style="color:#808030; ">=</span> <span style="color:#008c00; ">64</span><span style="color:#800080; ">;</span> r<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
        v delta <span style="color:#808030; ">=</span> cam_up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">.5</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">99</span> <span style="color:#808030; ">+</span> cam_right <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">.5</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">99</span><span style="color:#800080; ">;</span>
        color <span style="color:#808030; ">=</span> Sample<span style="color:#808030; ">(</span>v<span style="color:#808030; ">(</span><span style="color:#008c00; ">17</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> delta<span style="color:#808030; ">,</span>
                <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>delta <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">+</span> <span style="color:#808030; ">(</span>cam_up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> x<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> cam_right <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>y <span style="color:#808030; ">+</span> R<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> eye_offset<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">3.5</span> <span style="color:#808030; ">+</span> color<span style="color:#800080; ">;</span>
      <span style="color:#800080; ">}</span>
    img<span style="color:#808030; ">[</span>y <span style="color:#808030; ">*</span> <span style="color:#008c00; ">512</span> <span style="color:#808030; ">+</span> x<span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#7d0045; ">NULL</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

i <span style="color:#400000; ">main</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span>i y <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> y<span style="color:#808030; ">&lt;</span><span style="color:#008c00; ">512</span><span style="color:#800080; ">;</span>y<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    pthread_create<span style="color:#808030; ">(</span><span style="color:#808030; ">&amp;</span>threadIds<span style="color:#808030; ">[</span>y<span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> <span style="color:#7d0045; ">NULL</span><span style="color:#808030; ">,</span> plotPixel<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span><span style="color:#808030; ">)</span>y<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span>i y <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> y<span style="color:#808030; ">&lt;</span><span style="color:#008c00; ">512</span><span style="color:#800080; ">;</span>y<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    pthread_join<span style="color:#808030; ">(</span>threadIds<span style="color:#808030; ">[</span>y<span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> <span style="color:#7d0045; ">NULL</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">P6 512 512 255 </span><span style="color:#800000; ">"</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span>i y <span style="color:#808030; ">=</span> <span style="color:#008c00; ">511</span><span style="color:#800080; ">;</span> y <span style="color:#808030; ">&gt;</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">;</span> y<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#808030; ">)</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span>i x <span style="color:#808030; ">=</span> <span style="color:#008c00; ">511</span><span style="color:#800080; ">;</span> x <span style="color:#808030; ">&gt;</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> x<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      v<span style="color:#808030; ">*</span> p<span style="color:#800080; ">;</span>
      p <span style="color:#808030; ">=</span> <span style="color:#808030; ">&amp;</span>img<span style="color:#808030; ">[</span><span style="color:#008c00; ">512</span> <span style="color:#808030; ">*</span> y <span style="color:#808030; ">+</span> x<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>  
      <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>i<span style="color:#808030; ">)</span>p<span style="color:#808030; ">-</span><span style="color:#808030; ">&gt;</span>x<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>i<span style="color:#808030; ">)</span>p<span style="color:#808030; ">-</span><span style="color:#808030; ">&gt;</span>y<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>i<span style="color:#808030; ">)</span>p<span style="color:#808030; ">-</span><span style="color:#808030; ">&gt;</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>

<span style="color:#800080; ">}</span>
</pre>
