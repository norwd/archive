<html>
<head>
  <link rel="alternate" type="application/rss+xml"  title="RSS Feed for fabiensanglard.net" href="../rss.xml" />
  <style type="text/css">

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono.woff2');
      font-display: block;
    }

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono-Bold.woff2');
      font-weight: bold;
      font-display: block;
    }

    * {
       font-size: 16px;
    }

    html {
      font-family: fabfont,  monospace;
      max-width: 900px;  /* For Desktop PC (see @media for Tablets/Phones) */
      padding-left: 2%;
      padding-right: 3%;
      margin: 0 auto;
      background: #F5F5F0;
  	} 
    


  	a {
      color: black;
      font-weight: bold;
    }

    img {
      border: none; 
    }

    p {
      margin-top: 0px;
      text-align: justify;
    }
    sup {
      vertical-align: 0.3em;
      font-size: 0.65em;
    }   

    pre {
      font-family: fabfont, monospace;
      background-color: white; 
      border: 1px solid Black; 
      padding-left: 2%;
      padding-top: 1ch;
      padding-bottom: 1ch;
      /* Only take care of X overflow since this is the only part that can be too wide.
         The Y axis will never overflow.
      */
      overflow: hidden;
    }

    div.heading {
      font-weight: bold;      
      text-transform: uppercase;
      margin-top: 4ch;
    }

    /** {
      font-size: 16px;
    }*/
    @media (max-width: 500px) { /* For small screen decices */
      * {
        font-size: 12px; 
      }
    }   
    .title {
      text-decoration: none;
    }

    img.pixel, canvas.pixel {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

  code {
    /*font-size: 110%;*/
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
  }

  .trivia {
    border-left: 1px black solid;
    padding-left: 1ch;
  }

  .trivia::before {
  font-weight: bold;
  text-decoration: underline;
  padding-right: 1ch;
  content: "Trivia:";

  </style>
  <title>Deciphering the Postcard Sized PathTracer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=12.0, minimum-scale=1.0, user-scalable=yes">
</head>  
  <body><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="../index.html" class="title"><b>FABIEN SANGLARD'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<!-- <a class="title" href="/about/index.html">ABOUT</a> &nbsp;<a class="title" href="/contact/index.html">EMAIL</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">DONATE</a></div></div> -->
<a class="title" href="../about/index.html">ABOUT</a> &nbsp;<a class="title" href="../contact/index.html">CONTACT</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">GIVE</a></div></div>

</center><br><br>
<div style="margin-bottom: 2ch;text-transform: none;">
Dec 24, 2018</div>
<div class='heading'>Deciphering the Postcard Sized PathTracer</div><hr/><style type="text/css">
  img {
    border: black 1px solid;
  }
</style>
<p>
   <picture>
    <source srcset="rendered.webp" type="image/webp">
    <img loading="lazy" src="rendered.jpg" width="960" height="540" style="width: 40%; height: auto; float:right;margin-bottom: 2ch; margin-left: 2ch;"/>  </picture>

  "He's done it again!" was my first thought as I looked at the back of a postcard sized Pixar flier<a name="back_1" style="text-decoration: none;" href="index.html#footnote_1"><sup>[1]</sup></a> which was covered in code. In the lower right corner, the blob of statements and expressions had been signed by none other than Andrew Kensler. For those who are not familiar with him, Andrew is the programmer who came up with the 1337 bytes <a href="../rayTracing_back_of_business_card/index.html">Business Card Raytracer</a> around 2009.<br/> 
  <br/> 
  This time Andrew produced something a little bit more verbose but with a much more interesting visual result. Since I was done with my Game Engine Black Books about <a href="../gebbwolf3d/index.html">Wolf3D</a> and <a href="../gebbdoom/index.html">DOOM</a>, I had the time to take a deep look at the internals of his mysterious code. I rapidly found myself mesmerized by the techniques I discovered. They diverged drastically from Andrew's previous work based on a "standard" raytracer. It was an interesting experience to learn about ray marching, constructive solid geometry functions, montecarlo/path tracing rendering, and the many tricks he used to pack everything within such a small area.<br/>
</p>
  <div style="clear:both;"></div>


<div class='heading'>Source Code</div><hr/><p>
	The front of the flier is an advertisement for Pixar recruitment team. The back features 2,037 bytes of C++ code which have been obfuscated to use as little surface as possible. 	
	<pre>#include &lt;stdlib.h> // card > pixar.ppm
#include &lt;stdio.h>
#include &lt;math.h>
#define R return
#define O operator
typedef float F;typedef int I;struct V{F x,y,z;V(F v=0){x=y=z=v;}V(F a,F b,F
c=0){x=a;y=b;z=c;}V O+(V r){R V(x+r.x,y+r.y,z+r.z);}V O*(V r){R V(x*r.x,y*r.
y,z*r.z);}F O%(V r){R x*r.x+y*r.y+z*r.z;}V O!(){R*this*(1/sqrtf(*this%*this)
);}};F L(F l,F r){R l&lt;r?l:r;}F U(){R(F)rand()/RAND_MAX;}F B(V p,V l,V h){l=p
+l*-1;h=h+p*-1;R-L(L(L(l.x,h.x),L(l.y,h.y)),L(l.z,h.z));}F S(V p,I&m){F d=1\
e9;V f=p;f.z=0;char l[]="5O5_5W9W5_9_COC_AOEOA_E_IOQ_I_QOUOY_Y_]OWW[WaOa_aW\
eWa_e_cWiO";for(I i=0;i&lt;60;i+=4){V b=V(l[i]-79,l[i+1]-79)*.5,e=V(l[i+2]-79,l
[i+3]-79)*.5+b*-1,o=f+(b+e*L(-L((b+f*-1)%e/(e%e),0),1))*-1;d=L(d,o%o);}d=sq\
rtf(d);V a[]={V(-11,6),V(11,6)};for(I i=2;i--;){V o=f+a[i]*-1;d=L(d,o.x>0?f\
absf(sqrtf(o%o)-2):(o.y+=o.y>0?-2:2,sqrtf(o%o)));}d=powf(powf(d,8)+powf(p.z,
8),.125)-.5;m=1;F r=L(-L(B(p,V(-30,-.5,-30),V(30,18,30)),B(p,V(-25,17,-25),V
(25,20,25))),B(V(fmodf(fabsf(p.x),8),p.y,p.z),V(1.5,18.5,-25),V(6.5,20,25)))
;if(r&lt;d)d=r,m=2;F s=19.9-p.y;if(s&lt;d)d=s,m=3;R d;}I M(V o,V d,V&h,V&n){I m,s=
0;F t=0,c;for(;t&lt;100;t+=c)if((c=S(h=o+d*t,m))<.01||++s>99)R n=!V(S(h+V(.01,0
),s)-c,S(h+V(0,.01),s)-c,S(h+V(0,0,.01),s)-c),m;R 0;}V T(V o,V d){V h,n,r,t=
1,l(!V(.6,.6,1));for(I b=3;b--;){I m=M(o,d,h,n);if(!m)break;if(m==1){d=d+n*(
n%d*-2);o=h+d*.1;t=t*.2;}if(m==2){F i=n%l,p=6.283185*U(),c=U(),s=sqrtf(1-c),
g=n.z&lt;0?-1:1,u=-1/(g+n.z),v=n.x*n.y*u;d=V(v,g+n.y*n.y*u,-n.y)*(cosf(p)*s)+V(
1+g*n.x*n.x*u,g*v,-g*n.x)*(sinf(p)*s)+n*sqrtf(c);o=h+d*.1;t=t*.2;if(i>0&&M(h
+n*.1,l,h,n)==3)r=r+t*V(500,400,100)*i;}if(m==3){r=r+t*V(50,80,100);break;}}
R r;}I main(){I w=960,h=540,s=16;V e(-22,5,25),g=!(V(-3,4,0)+e*-1),l=!V(g.z,
0,-g.x)*(1./w),u(g.y*l.z-g.z*l.y,g.z*l.x-g.x*l.z,g.x*l.y-g.y*l.x);printf("P\
6 %d %d 255 ",w,h);for(I y=h;y--;)for(I x=w;x--;){V c;for(I p=s;p--;)c=c+T(e
,!(g+l*(x-w/2+U())+u*(y-h/2+U())));c=c*(1./s)+14./241;V o=c+1;c=V(c.x/o.x,c.
y/o.y,c.z/o.z)*255;printf("%c%c%c",(I)c.x,(I)c.y,(I)c.z);}}// Andrew Kensler</pre>
</p>

<div class='heading'>Does it even work?</div><hr/><p>The code comes with instructions on how to run it. The idea is to redirect the standard output to a file. The extension suggests the output format is the text-based image format known as NetPBM<a name="back_2" style="text-decoration: none;" href="index.html#footnote_2"><sup>[2]</sup></a>. 
	<pre>$ clang -o card -O3 raytracer.cpp
$ time ./card > pixar.ppm

real	2m58.524s
user	2m57.567s
sys	0m0.415s		
	</pre>
	<p>
	Within two minutes and fifty eight seconds<a name="back_3" style="text-decoration: none;" href="index.html#footnote_3"><sup>[3]</sup></a>, the following image is generated. It is astonishing given how little code is involved.<br/>
   <picture>
    <source srcset="vanilla16.webp" type="image/webp">
    <img loading="lazy" src="vanilla16.png" width="960" height="540" style="width: 100%; height: auto; margin-bottom: 2ch; margin-top: 2ch;"/>  </picture>


There is a lot to extract from the image above. The grainy aspect is the unmistakable fingerprint of a "path tracer". This type of renderer differs from raytracing in that rays are not backtracked towards the light sources. Instead thousand of rays per pixel are cast and followed forward, hoping they will find a light source. It is an interesting technique which is superior to raytracing when it comes to rendering ambient occlusion, soft shadows, caustics, and radiosity.<br/>
</p>





<div class='heading'>Breaking it down into sections</div><hr/><p>
	Feeding the input to CLion formats the code (output <a href="formatted.html">here</a>) and breaks it down into smaller sections/problems.
<pre><div style="display:inline;text-transform:none;color:LightGray;">#include &lt;stdlib.h> // card > pixar.ppm
#include &lt;stdio.h>
#include &lt;math.h>
<div style="display:inline;text-transform:none;color:fuchsia;">#define R return
#define O operator
typedef float F;typedef int I;<div style="display:inline;text-transform:none;color:blue;">struct V{F x,y,z;V(F v=0){x=y=z=v;}V(F a,F b,F
c=0){x=a;y=b;z=c;}V O+(V r){R V(x+r.x,y+r.y,z+r.z);}V O*(V r){R V(x*r.x,y*r.
y,z*r.z);}F O%(V r){R x*r.x+y*r.y+z*r.z;}V O!(){R*this*(1/sqrtf(*this%*this)
);}};<div style="display:inline;text-transform:none;color:orange;">F L(F l,F r){R l&lt;r?l:r;}F U(){R(F)rand()/RAND_MAX;}F B(V p,V l,V h){l=p
+l*-1;h=h+p*-1;R-L(L(L(l.x,h.x),L(l.y,h.y)),L(l.z,h.z));}</div><div style="display:inline;text-transform:none;color:LimeGreen      ;">F S(V p,I&m){F d=1\
e9;V f=p;f.z=0;char l[]="5O5_5W9W5_9_COC_AOEOA_E_IOQ_I_QOUOY_Y_]OWW[WaOa_aW\
eWa_e_cWiO";for(I i=0;i&lt;60;i+=4){V b=V(l[i]-79,l[i+1]-79)*.5,e=V(l[i+2]-79,l
[i+3]-79)*.5+b*-1,o=f+(b+e*L(-L((b+f*-1)%e/(e%e),0),1))*-1;d=L(d,o%o);}d=sq\
rtf(d);V a[]={V(-11,6),V(11,6)};for(I i=2;i--;){V o=f+a[i]*-1;d=L(d,o.x>0?f\
absf(sqrtf(o%o)-2):(o.y+=o.y>0?-2:2,sqrtf(o%o)));}d=powf(powf(d,8)+powf(p.z,
8),.125)-.5;m=1;F r=L(-L(B(p,V(-30,-.5,-30),V(30,18,30)),B(p,V(-25,17,-25),V
(25,20,25))),B(V(fmodf(fabsf(p.x),8),p.y,p.z),V(1.5,18.5,-25),V(6.5,20,25)))
;if(r&lt;d)d=r,m=2;F s=19.9-p.y;if(s&lt;d)d=s,m=3;R d;}<div style="display:inline;text-transform:none;color:black   ;">I M(V o,V d,V&h,V&n){I m,s=
0;F t=0,c;for(;t&lt;100;t+=c)if((c=S(h=o+d*t,m))<.01||++s>99)R n=!V(S(h+V(.01,0
),s)-c,S(h+V(0,.01),s)-c,S(h+V(0,0,.01),s)-c),m;R 0;}<div style="display:inline;text-transform:none;color:SkyBlue;">V T(V o,V d){V h,n,r,t=
1,l(!V(.6,.6,1));for(I b=3;b--;){I m=M(o,d,h,n);if(!m)break;if(m==1){d=d+n*(
n%d*-2);o=h+d*.1;t=t*.2;}if(m==2){F i=n%l,p=6.283185*U(),c=U(),s=sqrtf(1-c),
g=n.z&lt;0?-1:1,u=-1/(g+n.z),v=n.x*n.y*u;d=V(v,g+n.y*n.y*u,-n.y)*(cosf(p)*s)+V(
1+g*n.x*n.x*u,g*v,-g*n.x)*(sinf(p)*s)+n*sqrtf(c);o=h+d*.1;t=t*.2;if(i>0&&M(h
+n*.1,l,h,n)==3)r=r+t*V(500,400,100)*i;}if(m==3){r=r+t*V(50,80,100);break;}}
R r;}<div style="display:inline;text-transform:none;color:red;">I main(){I w=960,h=540,s=16;V e(-22,5,25),g=!(V(-3,4,0)+e*-1),l=!V(g.z,
0,-g.x)*(1./w),u(g.y*l.z-g.z*l.y,g.z*l.x-g.x*l.z,g.x*l.y-g.y*l.x);printf("P\
6 %d %d 255 ",w,h);for(I y=h;y--;)for(I x=w;x--;){V c;for(I p=s;p--;)c=c+T(e
,!(g+l*(x-w/2+U())+u*(y-h/2+U())));c=c*(1./s)+14./241;V o=c+1;c=V(c.x/o.x,c.
y/o.y,c.z/o.z)*255;printf("%c%c%c",(I)c.x,(I)c.y,(I)c.z);}}<div style="display:inline;text-transform:none;color:LightGray;">// Andrew Kensler</div></pre>
<p>
Each section is described in detail in the rest of the article: 
<table  style="display:inline;background-color:fuchsia; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> usual tricks,
<table  style="display:inline;background-color:blue; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> Vector class, 
<table  style="display:inline;background-color:orange; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> Utils, 
<table  style="display:inline;background-color:LimeGreen      ; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> Database, 
<table  style="display:inline;background-color:black ; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> Ray marching, 
<table  style="display:inline;background-color:SkyBlue; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> Sampling, 
<table  style="display:inline;background-color:red; width: 1ch; height: 1ch; border: 1px solid black;"><tr><td>&nbsp;</td></tr></table> main.
</p>






<div class='heading'>Usual #define and typedef tricks</div><hr/><p>
  The usual tricks are the usage of #define and typedef to drastically shorten the notation. Here, we have F=float, I=int, R=return, and O=operator. These are trivial to reverse.
</p>








<div class='heading'>V class</div><hr/><p>
Next is the V class which I renamed Vec (even though it is also used to store RGB float channels as we will see later). 

<pre style="color:#000000;background:#ffffff;"><span style="color:#800000; font-weight:bold; ">struct</span> Vec <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">float</span> x<span style="color:#808030; ">,</span> y<span style="color:#808030; ">,</span> z<span style="color:#800080; ">;</span>

    Vec<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> v <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> x <span style="color:#808030; ">=</span> y <span style="color:#808030; ">=</span> z <span style="color:#808030; ">=</span> v<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
    Vec<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> a<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> b<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> x <span style="color:#808030; ">=</span> a<span style="color:#800080; ">;</span> y <span style="color:#808030; ">=</span> b<span style="color:#800080; ">;</span> z <span style="color:#808030; ">=</span> c<span style="color:#800080; ">;</span><span style="color:#800080; ">}</span>

    Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">+</span><span style="color:#808030; ">(</span>Vec r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> Vec<span style="color:#808030; ">(</span>x <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> y <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
    Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">*</span><span style="color:#808030; ">(</span>Vec r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> Vec<span style="color:#808030; ">(</span>x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
    <span style="color:#696969; ">// dot product</span>
    <span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">%</span><span style="color:#808030; ">(</span>Vec r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
    <span style="color:#696969; ">// inverse square root</span>
    Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">!</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span><span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">/</span> sqrtf<span style="color:#808030; ">(</span><span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">%</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span><span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
</pre>

<p>
Notice the absence of subtraction (-) operator so instead of writing "X = A - B", we will see "X = A + B * -1". The inverse square root is useful to normalize vectors later.
</p>









<div class='heading'>Main function</div><hr/><p>
main() is the one symbol that cannot be obfuscated since it is called by libc's _start function. It is usually a good place to start working and a low hanging fruit. It took a bit of guessing from the first letter of the symbols, and a bit of fuzzing but I was able to get something readable.
<pre style="color:#000000;background:#ffffff;"><span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#400000; ">main</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> w <span style="color:#808030; ">=</span> <span style="color:#008c00; ">960</span><span style="color:#808030; ">,</span> h <span style="color:#808030; ">=</span> <span style="color:#008c00; ">540</span><span style="color:#808030; ">,</span> samplesCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">16</span><span style="color:#800080; ">;</span>
  Vec position<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">22</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  Vec goal <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> position <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  Vec left <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span>goal<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>goal<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">.</span> <span style="color:#808030; ">/</span> w<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#696969; ">// Cross-product to get the up vector</span>
  Vec up<span style="color:#808030; ">(</span>goal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>z <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span>
         goal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>x <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span>
         goal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>y <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">P6 </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; "> 255 </span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> w<span style="color:#808030; ">,</span> h<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> h<span style="color:#800080; ">;</span> y<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span> w<span style="color:#800080; ">;</span> x<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      Vec color<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> p <span style="color:#808030; ">=</span> samplesCount<span style="color:#800080; ">;</span> p<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
        color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> Trace<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>goal <span style="color:#808030; ">+</span> left <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>x <span style="color:#808030; ">-</span> w <span style="color:#808030; ">/</span> <span style="color:#008c00; ">2</span> <span style="color:#808030; ">+</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">+</span> 
        up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>y <span style="color:#808030; ">-</span> h <span style="color:#808030; ">/</span> <span style="color:#008c00; ">2</span> <span style="color:#808030; ">+</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

      <span style="color:#696969; ">// Reinhard tone mapping</span>
      color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">.</span> <span style="color:#808030; ">/</span> samplesCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> <span style="color:#008c00; ">14</span><span style="color:#808030; ">.</span> <span style="color:#808030; ">/</span> <span style="color:#008c00; ">241</span><span style="color:#800080; ">;</span>
      Vec o <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
      color <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>color<span style="color:#808030; ">.</span>x <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> color<span style="color:#808030; ">.</span>y <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> color<span style="color:#808030; ">.</span>z <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">255</span><span style="color:#800080; ">;</span>
      <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span> color<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span> color<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span> color<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span>
</pre>
<p>
Notice how the float type literals have no "f" and how the fractional part is omitted in order to save space. The same trick is used later where the integer part is omitted (float x = .5). The "for" statement is also unusual with the iteration expression blended inside the stop condition.<br/>
<br/>
This is a pretty standard main function for a raytracer/pathtracer. Camera vectors are defined and for each pixel, rays are cast. The difference between a raytracer and a path tracer is that in a path tracer, several rays are cast per pixel and they are slightly nudged at random. Then the color retrieved for each ray in a pixel is accumulated in three float R,B,G channels. At the end, the result is tone-mapped with Reinhard's method.<br/>
<br/>
The most important part is the sampleCount which can be set to 1 to speedup rendition and iterate faster on hypothesis. Here are renditions with sample values ranging from 1 to 2048.<br/>
<script type="text/javascript">
  function setSampleCountTest(e) {
    document.getElementById('sampleCountTestImage.png').src='vanilla' + e.value + '.png';
    document.getElementById('sampleCountTestImage.webp').srcset='vanilla' + e.value + '.webp';
  }
</script>
   <picture>
    <source srcset="vanilla2048.webp" id="sampleCountTestImage.webp" type="image/webp">
    <img loading="lazy" src="vanilla2048.png" width="960" height="540" id="sampleCountTestImage.png" style="width: 100%; height: auto; float:right;margin-bottom: 1ch; margin-top: 2ch;"/>  </picture>


<p style="margin-top: 0px;">
  <form >
    <div style="width: 100%; display: inline-block; margin-top: 0px;">
      <center>
  <label><input type="radio" name="sampleCountTest" value="1" onclick="setSampleCountTest(this);">1</label>
  <label><input type="radio" name="sampleCountTest" value="2" onclick="setSampleCountTest(this);">2</label>
  <label><input type="radio" name="sampleCountTest" value="4" onclick="setSampleCountTest(this);">4</label>
  <label><input type="radio" name="sampleCountTest" value="8" onclick="setSampleCountTest(this);">8</label>
  <label><input type="radio" name="sampleCountTest" value="16" onclick="setSampleCountTest(this);">16</label>
  <label><input type="radio" name="sampleCountTest" value="32" onclick="setSampleCountTest(this);">32</label>
  <label><input type="radio" name="sampleCountTest" value="64" onclick="setSampleCountTest(this);">64</label>
  <label><input type="radio" name="sampleCountTest" value="128" onclick="setSampleCountTest(this);">128</label>  
  <label><input type="radio" name="sampleCountTest" value="256" onclick="setSampleCountTest(this);" >256</label>  
  <label><input type="radio" name="sampleCountTest" value="512" onclick="setSampleCountTest(this);">512</label>  
  <label><input type="radio" name="sampleCountTest" value="1024" onclick="setSampleCountTest(this);">1024</label>  
  <label><input type="radio" name="sampleCountTest" value="2048" onclick="setSampleCountTest(this);" checked="checked">2048</label>  
  </center>
</div>
</form>
</p>









<div class='heading'>Utils</div><hr/><p>
  Another set of low hanging fruits are the utility functions. In this occurrence we have a trivial min() function, a random value [0,1] generator, and a much more interesting boxTest() which is part of the Constructive Solid Geometry (CSG) system used to carve the world. CSG is explained in the next section.

<pre style="color:#000000;background:#ffffff;"><span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> l<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> l <span style="color:#808030; ">&lt;</span> r <span style="color:#800080; ">?</span> l <span style="color:#800080; ">:</span> r<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
<span style="color:#800000; font-weight:bold; ">float</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span><span style="color:#808030; ">)</span> <span style="color:#603000; ">rand</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">/</span> RAND_MAX<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>

<span style="color:#696969; ">// Rectangle CSG equation. Returns minimum signed distance from </span>
<span style="color:#696969; ">// space carved by lowerLeft vertex and opposite rectangle</span>
<span style="color:#696969; ">// vertex upperRight.</span>
<span style="color:#800000; font-weight:bold; ">float</span> BoxTest<span style="color:#808030; ">(</span>Vec position<span style="color:#808030; ">,</span> Vec lowerLeft<span style="color:#808030; ">,</span> Vec upperRight<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  lowerLeft <span style="color:#808030; ">=</span> position <span style="color:#808030; ">+</span> lowerLeft <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  upperRight <span style="color:#808030; ">=</span> upperRight <span style="color:#808030; ">+</span> position <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>
    <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>
      <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> 
      <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span>
    <span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> 
    <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>
</pre>

</p>











<div class='heading'>Constructive Solid Geometry functions</div><hr/><p>
  There are no vertices in the code. Everything is done with CSG functions. If you are unfamiliar with them, let's just say that they are functions describing if a coordinate is inside or outside an object. If a function returns a positive distance, the point is inside the object. A negative distance indicates that the point is outside the object. There are many functions to describe many objects but for the sake of simplicity, let's take the example of a sphere and two points A and B.<br/>
</p>

   <img src="sphereTest.svg" 
         style="height:29ch; width:29ch; float:left;margin-right: 2ch;">
   <pre style="height:29ch; margin: 0; padding: 0;color:#000000;background:#ffffff;"> <span style="color:#696969; "> // Signed distance point(p) to sphere(c,r)</span>
  <span style="color:#800000; font-weight:bold; ">float</span> testSphere<span style="color:#808030; ">(</span>Vec p<span style="color:#808030; ">,</span> Vec c<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec delta <span style="color:#808030; ">=</span> c <span style="color:#808030; ">-</span> p<span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">float</span> distance <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span>delta<span style="color:#808030; ">%</span>delta<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">return</span> radius <span style="color:#808030; ">-</span> distance<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>  

  Vec A <span style="color:#800080; ">{</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> 
  Vec B <span style="color:#800080; ">{</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> 
  Vec C <span style="color:#800080; ">{</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> 
  <span style="color:#800000; font-weight:bold; ">float</span> r <span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">.</span><span style="color:#800080; ">;</span>

  testSphere<span style="color:#808030; ">(</span>A<span style="color:#808030; ">,</span> C<span style="color:#808030; ">,</span> r<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// == -1 (outside)</span>
  testSphere<span style="color:#808030; ">(</span>B<span style="color:#808030; ">,</span> C<span style="color:#808030; ">,</span> r<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// ==  1 (inside)</span>
</pre>
</div></div>

<p style="margin-top:2ch;">
The function testSphere() returns -1 for A (so it is outside) and 1 for B (so it is inside). Signing the distance is just a trick to provide two information instead of one with one value. The same type of function can be written to describe a 2D box (this is what is done in function BoxTest). Notice that to gain speed, an approximated distance is generated.<br/>
</p>
<img src="boxTest.svg"/ 
       style="height:29ch; width:29ch; float:left;margin-right: 2ch;">  
<pre style="height:29ch; margin: 0; padding: 0;color:#000000;background:#ffffff;"><span style="color:#696969; ">  // Signed distance point(p) to Box(c1,c2)</span>
  <span style="color:#800000; font-weight:bold; ">float</span> testRectangle2D<span style="color:#808030; ">(</span>Vec p<span style="color:#808030; ">,</span> Vec c1<span style="color:#808030; ">,</span> Vec c2<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>

    c1 <span style="color:#808030; ">=</span> p <span style="color:#808030; ">+</span> c1 <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    c2 <span style="color:#808030; ">=</span> c2 <span style="color:#808030; ">+</span> p <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>

    <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>      
        <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>c1<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> c2<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> 
         <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>c1<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> c2<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>  

  Vec A  <span style="color:#800080; ">{</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> Vec B  <span style="color:#800080; ">{</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  Vec C1 <span style="color:#800080; ">{</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> Vec C2 <span style="color:#800080; ">{</span><span style="color:#008c00; ">5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  testRectangle2D<span style="color:#808030; ">(</span>A<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">//  1.0 (inside)</span>
  testRectangle2D<span style="color:#808030; ">(</span>B<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// -2.0 (outside)</span>
</pre>

<br/>
<p>Now look what happens if we reverse the sign of the return value.</p>
<img src="carveTest.svg"/ 
       style="height:29ch; width:29ch; float:left;margin-right: 2ch;">
<pre style="height:29ch; margin: 0; padding: 0;color:#000000;background:#ffffff;"> <span style="color:#696969; "> // Signed distance point(p) to carved box(c1,c2)</span>
  <span style="color:#800000; font-weight:bold; ">float</span> testCarveBox2D<span style="color:#808030; ">(</span>Vec p<span style="color:#808030; ">,</span> Vec c1<span style="color:#808030; ">,</span> Vec c2<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>

    c1 <span style="color:#808030; ">=</span> p <span style="color:#808030; ">+</span> c1 <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    c2 <span style="color:#808030; ">=</span> c2 <span style="color:#808030; ">+</span> p <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>

    <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>
        <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>c1<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> c2<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> 
        <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>c1<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> c2<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>  

  Vec A  <span style="color:#800080; ">{</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> Vec B  <span style="color:#800080; ">{</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  Vec C1 <span style="color:#800080; ">{</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> Vec C2 <span style="color:#800080; ">{</span><span style="color:#008c00; ">5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  testCarveBox2D<span style="color:#808030; ">(</span>A<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// == -1.0 (outside)</span>
  testCarveBox2D<span style="color:#808030; ">(</span>B<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// ==  2.0 (inside)</span>
</pre>

  <br/>
<p>
Instead of describing a solid object, we have declared the whole world solid and instead carved a space inside it. Functions can be used as building blocks which once combined together describe more complex forms. With union operation (min function) we can carve two rectangles on top of each others and the result looks as follows.
</p>
<img src="roomTest.svg"/ 
       style="height:29ch; width:29ch; float:left;margin-right: 2ch;">
<pre style="height:29ch; margin: 0; padding: 0;color:#000000;background:#ffffff;"><span style="color:#696969; ">  // Signed distance point to room    </span>
  <span style="color:#800000; font-weight:bold; ">float</span> testRoom2D<span style="color:#808030; ">(</span>Vec p<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec C1 <span style="color:#800080; ">{</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> Vec C2 <span style="color:#800080; ">{</span><span style="color:#008c00; ">5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Lower room</span>
    Vec C3 <span style="color:#800080; ">{</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">5</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> Vec C4 <span style="color:#800080; ">{</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Upper room</span>

    <span style="color:#696969; ">// min() is the union of the two carved volumes.</span>
    <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>testCarvedBox2D<span style="color:#808030; ">(</span>p<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
               testCarvedBox2D<span style="color:#808030; ">(</span>p<span style="color:#808030; ">,</span> C3<span style="color:#808030; ">,</span> C4<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  Vec A  <span style="color:#800080; ">{</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">3</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span> 
  Vec B  <span style="color:#800080; ">{</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  testRoom2D<span style="color:#808030; ">(</span>A<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// == -1.0 (outside)</span>
  testRoom2D<span style="color:#808030; ">(</span>B<span style="color:#808030; ">,</span> C1<span style="color:#808030; ">,</span> C2<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// ==  1.0 (inside)</span>
</pre>

<p>

<br/>
If you start to think this looks like the room we are studying, it is because this is the way the lower room is expressed: with two simple carving boxes. 
Now armed with expert knowledge of CSG, we can go back to the code and take a look at the database function which is the heaviest part to digest.<br/>

<pre style="color:#000000;background:#ffffff;"><span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_NONE 0</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_LETTER 1</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_WALL 2</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_SUN 3</span>

<span style="color:#696969; ">// Sample the world using Signed Distance Fields.</span>
<span style="color:#800000; font-weight:bold; ">float</span> QueryDatabase<span style="color:#808030; ">(</span>Vec position<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#808030; ">&amp;</span>hitType<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> distance <span style="color:#808030; ">=</span> <span style="color:#008000; ">1e9</span><span style="color:#800080; ">;</span>
  Vec f <span style="color:#808030; ">=</span> position<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Flattened position (z=0)</span>
  f<span style="color:#808030; ">.</span>z <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">char</span> letters<span style="color:#808030; ">[</span><span style="color:#008c00; ">15</span><span style="color:#808030; ">*</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">+</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span>               <span style="color:#696969; ">// 15 two points lines</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5O5_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5W9W</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5_9_</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// P (without curve)</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">AOEO</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">COC_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">A_E_</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// I</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">IOQ_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">I_QO</span><span style="color:#800000; ">"</span>                <span style="color:#696969; ">// X</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">UOY_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">Y_]O</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">WW[W</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// A</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">aOa_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">aWeW</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">a_e_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">cWiO</span><span style="color:#800000; ">"</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// R (without curve)</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">&lt;</span> <span style="color:#008c00;">60</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec begin <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>letters<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">,</span> letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span><span style="color:#800080; ">;</span>
    Vec e <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">,</span> letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span> <span style="color:#808030; ">+</span> begin <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    Vec o <span style="color:#808030; ">=</span> f <span style="color:#808030; ">+</span> <span style="color:#808030; ">(</span>begin <span style="color:#808030; ">+</span> e <span style="color:#808030; ">*</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>begin <span style="color:#808030; ">+</span> f <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">%</span> e <span style="color:#808030; ">/</span> <span style="color:#808030; ">(</span>e <span style="color:#808030; ">%</span> e<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                                      <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                                 <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span>
                <span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    distance <span style="color:#808030; ">=</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// compare squared distance.</span>
  <span style="color:#800080; ">}</span>
  distance <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Get real distance, not square distance.</span>

  <span style="color:#696969; ">// Two curves (for P and R in PixaR) with hard-coded locations.</span>
  Vec curves<span style="color:#808030; ">[</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> <span style="color:#800080; ">{</span>Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">11</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">11</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#808030; ">)</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">;</span> i<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec o <span style="color:#808030; ">=</span> f <span style="color:#808030; ">+</span> curves<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    distance <span style="color:#808030; ">=</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span>
                   o<span style="color:#808030; ">.</span>x <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> fabsf<span style="color:#808030; ">(</span>sqrtf<span style="color:#808030; ">(</span>o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span>
                           <span style="color:#800080; ">:</span> <span style="color:#808030; ">(</span>o<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> o<span style="color:#808030; ">.</span>y <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span> <span style="color:#800080; ">:</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">,</span> sqrtf<span style="color:#808030; ">(</span>o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span>
               <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  distance <span style="color:#808030; ">=</span> powf<span style="color:#808030; ">(</span>powf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> powf<span style="color:#808030; ">(</span>position<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.125</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">.5</span><span style="color:#800080; ">;</span>
  hitType <span style="color:#808030; ">=</span> HIT_LETTER<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">float</span> roomDist <span style="color:#800080; ">;</span>
  roomDist <span style="color:#808030; ">=</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#696969; ">// min(A,B) = Union with Constructive solid geometry</span>
               <span style="color:#696969; ">//-min carves an empty space</span>
                <span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#696969; ">// Lower room</span>
                     BoxTest<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008000; ">.5</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">30</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                     <span style="color:#696969; ">// Upper room</span>
                     BoxTest<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">17</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">20</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span>
                <span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                BoxTest<span style="color:#808030; ">(</span> <span style="color:#696969; ">// Ceiling "planks" spaced 8 units apart.</span>
                  Vec<span style="color:#808030; ">(</span>fmodf<span style="color:#808030; ">(</span>fabsf<span style="color:#808030; ">(</span>position<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                      position<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span>
                      position<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                  Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">1.5</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">18.5</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                  Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">6.5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">20</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span>
                <span style="color:#808030; ">)</span>
  <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>roomDist <span style="color:#808030; ">&lt;</span> distance<span style="color:#808030; ">)</span> distance <span style="color:#808030; ">=</span> roomDist<span style="color:#808030; ">,</span> hitType <span style="color:#808030; ">=</span> HIT_WALL<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">float</span> sun <span style="color:#808030; ">=</span> <span style="color:#008000; ">19.9</span> <span style="color:#808030; ">-</span> position<span style="color:#808030; ">.</span>y <span style="color:#800080; ">;</span> <span style="color:#696969; ">// Everything above 19.9 is light source.</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>sun <span style="color:#808030; ">&lt;</span> distance<span style="color:#808030; ">)</span>distance <span style="color:#808030; ">=</span> sun<span style="color:#808030; ">,</span> hitType <span style="color:#808030; ">=</span> HIT_SUN<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">return</span> distance<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>
</pre>

<p>
We recognize the "carving" box function which uses only two rectangles to build the whole room (our brain does the rest and imagines these are walls). The horizontal ladder is a slightly more complex CSG function involving a modulo. Finally the PIXAR letters are made of 15 lines with an origin/delta pair and two special cases for the curves in the P and R of PixaR.
</p>






















<div class='heading'>Ray Marching</div><hr/><p>
  With a database of CSG functions describing the world, all that has to be done is to march all the rays cast in main(). The ray marching is distance function assigned. This mean the sample position moves forward by the distance of the closest obstacle.
</p>  

<pre style="color:#000000;background:#ffffff;"><span style="color:#696969; ">// Perform signed sphere marching</span>
<span style="color:#696969; ">// Returns hitType 0, 1, 2, or 3 and update hit position/normal</span>
<span style="color:#800000; font-weight:bold; ">int</span> RayMarching<span style="color:#808030; ">(</span>Vec origin<span style="color:#808030; ">,</span> Vec direction<span style="color:#808030; ">,</span> Vec <span style="color:#808030; ">&amp;</span>hitPos<span style="color:#808030; ">,</span> Vec <span style="color:#808030; ">&amp;</span>hitNorm<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> hitType <span style="color:#808030; ">=</span> HIT_NONE<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> noHitCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">float</span> d<span style="color:#800080; ">;</span> <span style="color:#696969; ">// distance from closest object in world.</span>

  <span style="color:#696969; ">// Signed distance marching</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> total_d<span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> total_d <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">100</span><span style="color:#800080; ">;</span> total_d <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> d<span style="color:#808030; ">)</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>d <span style="color:#808030; ">=</span> QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> total_d<span style="color:#808030; ">,</span> hitType<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&lt;</span> <span style="color:#008000; ">.01</span>
            <span style="color:#808030; ">|</span><span style="color:#808030; ">|</span> <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span>noHitCount <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">99</span><span style="color:#808030; ">)</span>
      <span style="color:#800000; font-weight:bold; ">return</span> hitNorm <span style="color:#808030; ">=</span>
         <span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span>QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">.01</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">,</span>
              QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">,</span>
              QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">)</span>
         <span style="color:#808030; ">,</span> hitType<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Weird return statement where a variable is also updated.</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>
</pre>
  <p>
  The idea behind distance assisted ray marching is to move forward by the distance of the closest object. Ultimately the ray gets close enough to a surface that a hit point is declared.<br/>
  <br/>

  <img loading="lazy" src="distance_assisted_marching.svg" width="106.14499mm" height="56.76862mm" style="width: 100%; height: auto; margin-bottom: 2ch; margin-top: 2ch;"/>  <p>
    Notice how ray marching does not returns an exact intersection with the surface but rather an approximation. This is why in the code we see marching stop when d < 0.01f.
</p>

<div class='heading'>Putting it all together: Sampling</div><hr/><p>
  We are almost done exploring the path tracer. We are missing the bridge which connects the main() function to the ray marcher. This last section which I renamed "Trace" is the "brain" where rays bounce or stop based on what they hit.<br/>
</p>

<pre style="color:#000000;background:#ffffff;">  Vec Trace<span style="color:#808030; ">(</span>Vec origin<span style="color:#808030; ">,</span> Vec direction<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  Vec sampledPosition<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">,</span> color<span style="color:#808030; ">,</span> attenuation <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  Vec lightDirection<span style="color:#808030; ">(</span><span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">.6</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.6</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Directional light</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> bounceCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">3</span><span style="color:#800080; ">;</span> bounceCount<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">int</span> hitType <span style="color:#808030; ">=</span> RayMarching<span style="color:#808030; ">(</span>origin<span style="color:#808030; ">,</span> direction<span style="color:#808030; ">,</span> sampledPosition<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_NONE<span style="color:#808030; ">)</span> <span style="color:#800000; font-weight:bold; ">break</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// No hit. This is over, return color.</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_LETTER<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">// Specular bounce on a letter. No color acc.</span>
      direction <span style="color:#808030; ">=</span> direction <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span> normal <span style="color:#808030; ">%</span> direction <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      origin <span style="color:#808030; ">=</span> sampledPosition <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.1</span><span style="color:#800080; ">;</span>
      attenuation <span style="color:#808030; ">=</span> attenuation <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.2</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Attenuation via distance traveled.</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_WALL<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">// Wall hit uses color yellow?</span>
      <span style="color:#800000; font-weight:bold; ">float</span> incidence <span style="color:#808030; ">=</span> normal <span style="color:#808030; ">%</span> lightDirection<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> p <span style="color:#808030; ">=</span> <span style="color:#008000; ">6.283185</span> <span style="color:#808030; ">*</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> s <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">-</span> c<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> g <span style="color:#808030; ">=</span> normal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#800080; ">:</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> u <span style="color:#808030; ">=</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">/</span> <span style="color:#808030; ">(</span>g <span style="color:#808030; ">+</span> normal<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> v <span style="color:#808030; ">=</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> u<span style="color:#800080; ">;</span>
      direction <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>v<span style="color:#808030; ">,</span>
                      g <span style="color:#808030; ">+</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> u<span style="color:#808030; ">,</span>
                      <span style="color:#808030; ">-</span>normal<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>cosf<span style="color:#808030; ">(</span>p<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> s<span style="color:#808030; ">)</span>
                  <span style="color:#808030; ">+</span>
                  Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">+</span> g <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> u<span style="color:#808030; ">,</span>
                      g <span style="color:#808030; ">*</span> v<span style="color:#808030; ">,</span>
                      <span style="color:#808030; ">-</span>g <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>sinf<span style="color:#808030; ">(</span>p<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> s<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> sqrtf<span style="color:#808030; ">(</span>c<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      origin <span style="color:#808030; ">=</span> sampledPosition <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> <span style="color:#008000; ">.1</span><span style="color:#800080; ">;</span>
      attenuation <span style="color:#808030; ">=</span> attenuation <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.2</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>incidence <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#808030; ">&amp;</span><span style="color:#808030; ">&amp;</span>
          RayMarching<span style="color:#808030; ">(</span>sampledPosition <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#008000; ">.1</span><span style="color:#808030; ">,</span>
                      lightDirection<span style="color:#808030; ">,</span>
                      sampledPosition<span style="color:#808030; ">,</span>
                      normal<span style="color:#808030; ">)</span> <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_SUN<span style="color:#808030; ">)</span>
        color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> attenuation <span style="color:#808030; ">*</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">500</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">400</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">100</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> incidence<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_SUN<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">//</span>
      color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> attenuation <span style="color:#808030; ">*</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">50</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">80</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">100</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800000; font-weight:bold; ">break</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Sun Color</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> color<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>
</pre>

<p>
  I played a little with this function to change the maximum number of allowed ray bounce. A value of "2" gives an oddly good looking varnished Vantablack<a name="back_4" style="text-decoration: none;" href="index.html#footnote_4"><sup>[4]</sup></a> look to the letters.<br/>
  <script type="text/javascript">
  function setBouncingImage(e) {
    document.getElementById('bouncingImage.png').src='vanilla512_bouce' + e.value + '.png';
    document.getElementById('bouncingImage.webp').srcset='vanilla512_bouce' + e.value + '.webp';
  }
</script>

  

     <picture>
    <source srcset="vanilla512_bouce2.webp" id="bouncingImage.webp" type="image/webp">
    <img loading="lazy" src="vanilla512_bouce2.png" width="960" height="540" id="bouncingImage.png" style="width: 100%; height: auto; border: solid 1px; margin-top: 2ch; margin-bottom: 1ch;"/>  </picture>

<p style="margin-top: 0px;">
  <form >
    <div style="width: 100%; display: inline-block; margin-top: 0px;">
      <center>
  <label><input type="radio" name="bounceCount" value="1" onclick="setBouncingImage(this);">1</label>
  <label><input type="radio" name="bounceCount" value="2" onclick="setBouncingImage(this);" checked="checked" >2</label>
  <label><input type="radio" name="bounceCount" value="3" onclick="setBouncingImage(this);">3</label>
  <label><input type="radio" name="bounceCount" value="4" onclick="setBouncingImage(this);">4</label>
  </center>
</div>
</form>
</p>

<div class='heading'>Full cleaned up source code</div><hr/><p>
  To put it all together, here is the fully cleaned up source code <a href="formatted_full.html">here</a>.
</p>
<style type='text/css'>td.ref {  padding-bottom: 0ch; width:0;}</style><div class='heading'>References</div><hr/><p id='paperbox' style='text-align:left;'><table><tbody style='vertical-align: top;'><tr><td class='ref' style='width:1ch;'><a name="footnote_1"></a><a href="index.html#back_1">^</a></td><td  class='ref' style='width:4ch;'> [1]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://twitter.com/lexfrench/status/1049196936161415169">Twitter post by lexfrench on Oct 8, 2018</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_2"></a><a href="index.html#back_2">^</a></td><td  class='ref' style='width:4ch;'> [2]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://en.wikipedia.org/wiki/Netpbm_format.">Wikipedia: NetPBM image format</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_3"></a><a href="index.html#back_3">^</a></td><td  class='ref' style='width:4ch;'> [3]</td><td style='width:100%;text-align:left;' class='ref'><a href="index.html">Rendition performed on a maxed out MacBook Pro, 2017</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_4"></a><a href="index.html#back_4">^</a></td><td  class='ref' style='width:4ch;'> [4]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://en.wikipedia.org/wiki/Vantablack">Wikipedia: Vantablack</a></td></tr></tbody></table></p> <hr>
 <center>*