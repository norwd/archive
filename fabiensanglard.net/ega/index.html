<html>
<head>
  <link rel="alternate" type="application/rss+xml"  title="RSS Feed for fabiensanglard.net" href="https://fabiensanglard.net/rss.xml" />
  <style type="text/css">

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono.woff2');
      font-display: block;
    }

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono-Bold.woff2');
      font-weight: bold;
      font-display: block;
    }

    * {
       font-size: 16px;
    }

    html {
      font-family: fabfont,  monospace;
      max-width: 900px;  /* For Desktop PC (see @media for Tablets/Phones) */
      padding-left: 2%;
      padding-right: 3%;
      margin: 0 auto;
      background: #F5F5F0;
  	} 
    


  	a {
      color: black;
      font-weight: bold;
    }

    img {
      border: none; 
    }

    p {
      margin-top: 0px;
      text-align: justify;
    }
    sup {
      vertical-align: 0.3em;
      font-size: 0.65em;
    }   

    pre {
      font-family: fabfont, monospace;
      background-color: white; 
      border: 1px solid Black; 
      padding-left: 2%;
      padding-top: 1ch;
      padding-bottom: 1ch;
      /* Only take care of X overflow since this is the only part that can be too wide.
         The Y axis will never overflow.
      */
      overflow: hidden;
    }

    div.heading {
      font-weight: bold;      
      text-transform: uppercase;
      margin-top: 4ch;
    }

    /** {
      font-size: 16px;
    }*/
    @media (max-width: 500px) { /* For small screen decices */
      * {
        font-size: 12px; 
      }
    }   
    .title {
      text-decoration: none;
    }

    img.pixel, canvas.pixel {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

  code {
    /*font-size: 110%;*/
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
  }

  .trivia {
    border-left: 1px black solid;
    padding-left: 1ch;
  }

  .trivia::before {
  font-weight: bold;
  text-decoration: underline;
  padding-right: 1ch;
  content: "Trivia:";

  </style>
  <title>Commander Keen's Adaptive Tile Refresh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=12.0, minimum-scale=1.0, user-scalable=yes">
</head>  
  <body><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="https://fabiensanglard.net/" class="title"><b>FABIEN SANGLARD'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<!-- <a class="title" href="/about/index.html">ABOUT</a> &nbsp;<a class="title" href="/contact/index.html">EMAIL</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">DONATE</a></div></div> -->
<a class="title" href="https://fabiensanglard.net/about/index.html">ABOUT</a> &nbsp;<a class="title" href="https://fabiensanglard.net/contact/index.html">CONTACT</a> &nbsp;<a class="title" href="https://fabiensanglard.net/rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">GIVE</a></div></div>

</center><br><br>
<div style="margin-bottom: 2ch;text-transform: none;">
Jul 27, 2023</div>
<div class='heading'>Commander Keen's Adaptive Tile Refresh</div><hr/>
<style type="text/css">
   blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

</style>

<p>I have been reading <a href="https://amzn.to/43DLW2U">Doom Guy</a> by John Romero. It is an excellent book which I highly recommend. In the ninth chapter, John describes being hit by lightning upon seeing Adaptive Tile Refresh (ATR). That made me realize I never took the time to understand how this crucial piece of tech powers the Commander Keen (CK) series.</p>

<p> During my research I was surprised to learn that ATR only powered the first CK trilogy. The second trilogy turned out to use something far better.</p>


<div class='heading'>EGA 101</div><hr/><p>Commander Keen ran at its best on a PC equipped with a Enhanced Graphic Adapter (EGA) card. On these machines, graphic programming is done through a set of registers for configuration and a window of 64KiB memory mapped<a name="back_1" style="text-decoration: none;" href="index.html#footnote_1"><sup>[1]</sup></a> to the Video RAM (VRAM) to plot pixels. Internally the EGA stores data in four planes named C0, C1, C2, and C3<a name="back_2" style="text-decoration: none;" href="index.html#footnote_2"><sup>[2]</sup></a>. From the banks, bytes are picked up by the screen controller and sent to the monitor.
</p>



<img loading="lazy" src="ega_arch_sc.svg" width="361.24442mm" height="89.605553mm" style="width: 100%; height: auto; margin-bottom:2ch;"/>

<p>This design involving four banks may seem bizarre but this was the only way to reach the bandwidth necessary to keep with the screen (CRT). No chip was fast enough so IBM designers made the controller (CRTC) read four bytes in parallel.</p>




<div class='heading'>EGA Mode 0xD</div><hr/><p>The EGA CRTC does not expect RGB values to generate pixels. Instead it is based on a palette system. Several modes offer various resolutions and colors. In its mode <code>Dh</code><a name="back_3" style="text-decoration: none;" href="index.html#footnote_3"><sup>[3]</sup></a>, which is what CK uses, the resolution is 320x200 16 colors<a name="back_4" style="text-decoration: none;" href="index.html#footnote_4"><sup>[4]</sup></a>.</p>

<style type="text/css">
table.lines , table.lines th, table.lines td {
  border: 1px solid black;
  border-collapse: collapse;
}
table.lines  td {
  padding-right: 1ch;
  padding-top: 0.8ch;
  padding-bottom: 0.8ch;
  text-align: right;
}

table.lines th {
  font-weight: bold;
  background-color: #FFF;
}
</style>

<table class="lines" style="width:100%;">
   <tr>
    <td>0x0</td>
    <td>0x1</td>
    <td>0x2</td>
    <td>0x3</td>
    <td>0x4</td>
    <td>0x5</td>
    <td>0x6</td>
    <td>0x7</td>
    <td>0x8</td>
    <td>0x9</td>
    <td>0xA</td>
    <td>0xB</td>
    <td>0xC</td>    
    <td>0xD</td>    
    <td>0xE</td>    
    <td>0xF</td>    
  </tr>
  <tr>
    <td style="background-color: #000000">M</td>
    <td style="background-color: #0000AA"></td>
    <td style="background-color: #00AA00"></td>
    <td style="background-color: #00AAAA"></td>
    <td style="background-color: #AA0000"></td>
    <td style="background-color: #AA00AA"></td>
    <td style="background-color: #AA5500"></td>
    <td style="background-color: #AAAAAA"></td>
    <td style="background-color: #555555"></td>
    <td style="background-color: #5555FF"></td>
    <td style="background-color: #55FF55"></td>
    <td style="background-color: #55FFFF"></td>
    <td style="background-color: #FF5555"></td>
    <td style="background-color: #FF55FF"></td>
    <td style="background-color: #FFFF55"></td>
    <td style="background-color: #FFFFFF"></td>    
  </tr>
</table>


<span style="text-align: center; display: block; margin-top: 1ch;margin-bottom: 2ch;"><i><small>The default EGA palette of CK</small></i></span>

<p>In mode <code>10h</code>, which CK does NOT use, the palette indices (pens) can be reconfigured to use different colors (inks). Each pen can point to an ink from a set of 64 predefined values.</p>



<table class="lines" style="width:100%;">
    <td></td>
    <td>0x0</td>
    <td>0x1</td>
    <td>0x2</td>
    <td>0x3</td>
    <td>0x4</td>
    <td>0x5</td>
    <td>0x6</td>
    <td>0x7</td>
    <td>0x8</td>
    <td>0x9</td>
    <td>0xA</td>
    <td>0xB</td>
    <td>0xC</td>    
    <td>0xD</td>    
    <td>0xE</td>    
    <td>0xF</td>    
  </tr>
  <tr>
    <td>0x00</td>
    <td style="background-color: #000000">M</td>
    <td style="background-color: #0000AA"></td>
    <td style="background-color: #00AA00"></td>
    <td style="background-color: #00AAAA"></td>
    <td style="background-color: #AA0000"></td>
    <td style="background-color: #AA00AA"></td>
    <td style="background-color: #aaaa00"></td>
    <td style="background-color: #aaaaaa"></td>
    <td style="background-color: #000055"></td>
    <td style="background-color: #0000ff"></td>
    <td style="background-color: #00aa55"></td>
    <td style="background-color: #00aaFF"></td>
    <td style="background-color: #aa0055"></td>
    <td style="background-color: #aa00ff"></td>
    <td style="background-color: #aaaa55"></td>
    <td style="background-color: #aaaaff"></td>    
  </tr>
    <tr>
    <td>0x10</td>
    <td style="background-color: #005500; color:#005500;">M</td>
    <td style="background-color: #0055AA"></td>
    <td style="background-color: #00ff00"></td>
    <td style="background-color: #00ffAA"></td>
    <td style="background-color: #AA5500"></td>
    <td style="background-color: #AA55AA"></td>
    <td style="background-color: #AAff00"></td>
    <td style="background-color: #AAffAA"></td>
    <td style="background-color: #005555"></td>
    <td style="background-color: #0055FF"></td>
    <td style="background-color: #00FF55"></td>
    <td style="background-color: #00FFFF"></td>
    <td style="background-color: #aa5555"></td>
    <td style="background-color: #aa55FF"></td>
    <td style="background-color: #aaFF55"></td>
    <td style="background-color: #aaFFFF"></td>    
  </tr>
  <tr>
    <td>0x20</td>
    <td style="background-color: #550000; color:#550000;">M</td>
    <td style="background-color: #5500AA"></td>
    <td style="background-color: #55AA00"></td>
    <td style="background-color: #55AAAA"></td>
    <td style="background-color: #ff0000"></td>
    <td style="background-color: #ff00AA"></td>
    <td style="background-color: #ffaa00"></td>
    <td style="background-color: #ffaAAA"></td>
    <td style="background-color: #550055"></td>
    <td style="background-color: #5500FF"></td>
    <td style="background-color: #55aa55"></td>
    <td style="background-color: #55aaFF"></td>
    <td style="background-color: #FF0055"></td>
    <td style="background-color: #FF00FF"></td>
    <td style="background-color: #FFaa55"></td>
    <td style="background-color: #FFaaFF"></td>    
  </tr>  
    <tr>
    <td>0x30</td>
    <td style="background-color: #555500; color:#555500;">M</td>
    <td style="background-color: #5555AA"></td>
    <td style="background-color: #55ff00"></td>
    <td style="background-color: #55ffAA"></td>
    <td style="background-color: #ff5500"></td>
    <td style="background-color: #ff55AA"></td>
    <td style="background-color: #ffff00"></td>
    <td style="background-color: #ffffAA"></td>
    <td style="background-color: #555555"></td>
    <td style="background-color: #5555FF"></td>
    <td style="background-color: #55FF55"></td>
    <td style="background-color: #55FFFF"></td>
    <td style="background-color: #FF5555"></td>
    <td style="background-color: #FF55FF"></td>
    <td style="background-color: #FFFF55"></td>
    <td style="background-color: #FFFFFF"></td>    
  </tr>
</table>
<span style="text-align: center; display: block; margin-top: 1ch;margin-bottom: 2ch;"><i><small>EGA color space (64 values from 0x00 to 0x3F)</small></i></span>

<p><u><b>Trivia:</b></u> In mode <code>Dh</code>, the palette colors can still be reconfigured but only from the default 16 colors. This is how CK implements its crude fade in/out effect.</p>

<div class='heading'>EGA Planar Mode</div><hr/><p>Each bank stores a plane of a nibble (4-bit). <code>C0</code> stores all LSB of each nibble. <code>C3</code> stores all MSB of each nibble. And so on... As an example, the first byte in <code>C0</code> stores the LSB of the eight first pixel on the screen.</p>
</p>
<img loading="lazy" src="ega_palette_sc.svg" width="262.46667mm" height="75.935417mm" style="width: 100%; height: auto; margin-bottom:2ch;"/>
<p>A full screen requires 320x200/2= 32,000 bytes of VRAM. Each bank/plane stores 200 lines made of 40 bytes each.</p>

<!-- <p>This arrangement looks tedious to plot a single pixel because the operation involves, for each bank, reading what is there, OR it with the new value, and write it back. To help developer keep their sanity, the EGA has a mask allowing to pick which planes to write to, a latch that is loaded when the CPU reads, and a way to program how to combine incoming value with latch.</p> -->






<div class='heading'>The problem Adaptive Tile Refresh solves</div><hr/><p>At its heart the problem ATR solves is bandwidth. Writing 320x200 nibbles (32 KiB) per frame is too much for the ISA bus. There is no way to maintain a 60Hz framerate while refreshing the whole screen. If we were to run the following code, which simply fills all banks, it would run at 5 frames per seconds.
  </p>

<pre class="code_syntax" style="color:#000000;background:#ffffff;"><span class="line_wrapper">byte<span style="color:#808030; ">*</span> vram <span style="color:#808030; ">=</span> <span style="color:#008000; ">0xA0000000</span><span style="color:#006600; ">L</span><span style="color:#800080; ">;</span>  </span>
<span class="line_wrapper"></span>
<span class="line_wrapper"><span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> bank_id <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">;</span> bank_id <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">4</span> <span style="color:#800080; ">;</span> bank_id<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span></span>
<span class="line_wrapper">  select_bank<span style="color:#808030; ">(</span>bank_id<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span></span>
<span class="line_wrapper">  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">40</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">200</span><span style="color:#800080; ">;</span> i<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span></span>
<span class="line_wrapper">    vram<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> <span style="color:#008000; ">0x0</span><span style="color:#800080; ">;</span></span>
<span class="line_wrapper">  <span style="color:#800080; ">}</span></span>
<span class="line_wrapper"><span style="color:#800080; ">}</span></span></pre>

<p><b><u>Trivia:</u></b> Connoisseurs will point out there are ways for the EGA to write to all four banks simulaneously. These can help to clear the screen or in the case of Wolfenstein 3D duplicate columns. They don't help for Commander Keen.</p>

<div class='heading'>How Adaptive Tile Refresh Works</div><hr/><p>The best way to understand ATR is to build it from scratch, introducing EGA registers as we need them. Let's start by displaying a static image. We set the EGA in mode <code>Dh</code>, pick an address in VRAM, fill it with nibbles, and then use the "CRTC Start" register so the CRTC knows where to start reading from.</p>

<img loading="lazy" src="no_scroll_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:2ch;"/>
<p><b><u>Trivia:</u></b> There is no single CRTC start address register. Instead a developer must use two registers named "Start Address High" (<code>0CH</code>), and "Start Address Low" (<code>0DH</code>). For simplicity, we treat it as if it was a single one and call it <code>CRTC_START</code>.</p>

<div class='heading'>Smooth vertical scrolling</div><hr/><p>Now we are going to add smooth scrolling. The goal is to create a system where the image displayed on the screen can be shifted with an EGA register (cheap) without plotting a single pixel (expensive).</p>

<p>Let's start with smooth vertical scrolling. If we allocate more memory than is displayed, we create a virtual screen in VRAM. We can add 16 lines above and 16 lines below. Instead of 40x200 = 8,000 bytes per plane, we now used 40 x 232 = 9,280 bytes per plane.</p>

<img loading="lazy" src="v_scroll_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:2ch;"/> 
<p>To move the displayed image up by a line, we can just increase the <code>CRTC_START</code> register by 40 bytes.</p>
<img loading="lazy" src="v_scroll_up_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:2ch;"/>
<p>To move the displayed image down by a line, we can just decrease the <code>CRTC_START</code> register by 40 bytes.</p>

<img loading="lazy" src="v_scroll_down_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:2ch;"/>

<p>The renderer now needs to write a few more lines to VRAM but the cost is amortized. The gain is that we can update the <code>CRTC_START</code> address up or down in the virtual screen to smoothly move the displayed image up or down.</p>



<div class='heading'>Smooth horizontal scrolling</div><hr/><p>The previous trick allows smooth vertical scrolling. However the truly impressive part, the one John Romero raves about in his book, is smooth horizontal scrolling.</p>

<p>At first sight, it does not look like we can use the same trick since all lines are contiguous in VRAM (there is no space between them). But the EGA has a register to allow padding between lines. With the <code>OFFSET</code> register set to 2 we add 16 bytes of padding which results in 16 extra pixels on the left and 16 extra pixels on the right in the virtual screen<a name="back_5" style="text-decoration: none;" href="index.html#footnote_5"><sup>[5]</sup></a>. 
</p>

<img loading="lazy" src="x_scroll_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:2ch;"/>
<p>However this is not enough for the scrolling to be smooth. If we change the CRTC start address, we have to remember that nibbles are stored in planes. Increasing <code>CRTC_START</code> by 1 moves the screen horizontally by 8 pixels (four banks each containing 2 pixels per byte). This is coarse, not smooth.</p>

<p>The last register involved in ATR is called "Horizontal Pel Panning" (we will call is <code>PEL</code>). It accepts 4 bits  to tell the CRTC to skip up to 7 bits from <code>CRTC_START</code> before using nibbles. This is exactly what we need for smooth horizontal scrolling.</p>

<p>Each movement left or right is done with a <code>CRTC_START</code> register update (for coordinate / 8). Then the move is fine tuned with the <code>PEL</code> register (for coordinate % 8).</p>









<div class='heading'>Running out of virtual screen -> jolt</div><hr/><p>So far, we have built a virtual screen in VRAM allowing 16 smooth one pixel moves in both axes using only EGA registers. But what happens when we reach an edge? That's where the innovation, and what left John Romero speechless for 30 minutes, starts.</p>

<p>As John Carmack explained<a name="back_6" style="text-decoration: none;" href="index.html#footnote_6"><sup>[6]</sup></a>, once it reaches an edge, the virtual screen must be reset. And it cannot be a full screen redraw because it would take 200ms and drop framerate to 5fps. This operation, coined "jolt" by knolo in their excellent explanation<a name="back_7" style="text-decoration: none;" href="index.html#footnote_7"><sup>[7]</sup></a>, involves collaboration from the game designers.
</p>


<p>CK levels are built with tiles of dimension 16x16. Upon being drawn by artists, the build system give them an unique ID. A level design creates a map by placing tile IDs in a 2D editor. CK engine keeps track of which tile IDs are in the virtual screen. Since the engine only jolts at tiles size granularity, it can determine extremely fast what has changed on the screen by comparing IDs.</p>

<img loading="lazy" src="before_jolt_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:1ch;"/>
<span style="text-align: center; display: block; margin-top: 1ch;margin-bottom: 2ch;"><i><small>Before the jolt</small></i></span>

<p>Notice how, before the jolt, the CRTC starts at the botton of the virtual screen. The image displayed on the screen has not changed between before and after. However the virtual screen has been "re-centered".</p>


<img loading="lazy" src="after_jolt_sc.svg" width="886.88336mm" height="304.79999mm" style="width: 100%; height: auto; margin-bottom:1ch;"/><span style="text-align: center; display: block; margin-top: 1ch;margin-bottom: 2ch;"><i><small>After the jolt</small></i></span>



<div class='heading'>Map Designer help needed</div><hr/><p>To jolt, the engine compares each tile ID in the virtual screen current state and the desired, re-centered, state. For matching tiles there is nothing to do and they are skipped entirely. Only mismatch incur a CPU penalty because these need to be overwritten in VRAM.</p>

<p>This is the part where CK game designer had to help the engine with. The jolt efficiency is inversely proportional to the number of tiles to redraw. To avoid costy jolts, designers built tile-maps so there would be a lot of reperating tiles.</p>

<p>In the following screenshot of Commander Keen 1, the player smoothly moved to the right until it ran out of virtual screen. A 16 pixels left jolt occurs. We can see the small number of tiles which were overwritten.</p>

<p style="margin-bottom: 1ch;"> 
  <script type="text/javascript">
  function setCK(e) {
    document.getElementById('ck_diff').src= e.value;

  }
</script>
  
<img loading="lazy" src="before.webp" width="2240" height="1400" id="ck_diff" style="width: 100%; height: auto; "/>  </p>

<form>
    <div style="width: 100%; display: inline-block; margin-top: 0px;">
      <center>
  <label><input type="radio" name="ck_diff" value="before.webp" onclick="setCK(this);" checked="checked">Before</label>
  <label><input type="radio" name="ck_diff" value="after.webp" onclick="setCK(this);">After</label>
  <label><input type="radio" name="ck_diff" value="diff.webp" onclick="setCK(this);">Diff</label>
  </center>
</div>
</form>

<p>Only 40 tiles have changed (in pink) out of 250. The amount of redraw is just 16% of the whole screen.

<div class='heading'>Sprites</div><hr/><p>So far we have only discussed how the background (made of tiles) is rendered and smoothly scrolled. CK draws a layer of sprites on top of it. While it renders the sprites layer over the background tile layer, the engine maintains a list of dirty (overwritten) tile coordinates. Each new frame, the dirty list is traversed, the background tiles are restored, and then the sprites are drawn again. Rinse, repeat.
</p>


<div class='heading'>Double buffering / Doing the math</div><hr/><p>To avoid visual artifacts, the whole system is duplicated via two framebuffers. While an image is read by the CRTC, another can be written elsewhere in VRAM. Each buffer uses (320 + 32) * (200 + 32) * 4 / 8  = 40,832 bytes. With double buffer, the total is 40,832 * 2 = 81,664 bytes. This is way past the capacity of the standard set by IBM original EGA graphic card. But it was not a problem.</p>


  <blockquote>
Only the original IBM EGA board ever shipped with 64KiB,
and it was a clunky beast full of discrete components, which required
daughter-boards for VRAM expansion.<br/>
<br/>  The EGA clones that started
coming along in ~1986-7 were based on integrated chipsets (like the
one from Chips & Technologies), and the vast majority of them came
with 256K on board.  When Commander Keen came out, the headcount of
EGA cards with less than 256K 'in the wild' would've been practically
negligible.<br/>
        <br/>
        <div>- VileR (sources<a name="back_8" style="text-decoration: none;" href="index.html#footnote_8"><sup>[8]</sup></a><a name="back_9" style="text-decoration: none;" href="index.html#footnote_9"><sup>[9]</sup></a>)</div>
    </blockquote> 

<!-- <p>In CK source code<a name="back_10" style="text-decoration: none;" href="#footnote_10"><sup>[10]</sup></a> we can see that register <code>12h</code> is not even consulted to check how much VRAM is installed.</p> -->


<p><b><u>Trivia:</u></b> How to manage 256 KiB of VRAM with only a 64 KiB window? Not a problem since the banks contain 64 KiB each. The CPU can still "see" everything via the plane mask (selection) register.</p>

<div class='heading'>Better than Adaptive Tile Refresh: Drifting</div><hr/><p>Knowing how ATR works, and how it depends on repeating tiles, we should be surprised to see the difference between the first and second trilogy screenshots.</p>

<table style="width:100%;margin-bottom: 0;">
  <tr>
    <td style="width:28%;">
<a href="keen1.gif"><img loading="lazy" src="keen1.gif" width="960" height="800" style="width: 100%; height: auto;  border: 1px solid black;"/></a>    </td>
    <td style="width:28%;">
<a href="keen2.gif"><img loading="lazy" src="keen2.gif" width="960" height="800" style="width: 100%; height: auto; border: 1px solid black;"/></a></td>
<td style="width:28%;">
<a href="keen3.gif"><img loading="lazy" src="keen3.gif" width="960" height="800" style="width: 100%; height: auto; border: 1px solid black;"/></a></td>
</tr>
</table>
<span style="text-align: center; display: block; margin-top: 1ch;margin-bottom: 2ch;"><i><small>Commander Keen 1, 2, and 3</small></i></span>


<p>If Commander Keen 1, 2, and 3 show the characteristic repeating patterns required by ATR, the second trilogy, made of Commander Keen 4, 5, and 6, does not. It is most apparent with the starting forest of CK 4 where next to nothing is repeating except for the marginal underground.
</p>

<table style="width:100%; margin-bottom: 0;">
  <tr>
    <td style="width:28%;">
<a href="keen4.gif"><img loading="lazy" src="keen4.gif" width="960" height="800" style="width: 100%; height: auto; border: 1px solid black;"/></a>    </td>
    <td style="width:28%;">
<a href="keen5.gif"><img loading="lazy" src="keen5.gif" width="960" height="800" style="width: 100%; height: auto; border: 1px solid black;"/></a></td>
<td style="width:28%;">
<a href="keen6.gif"><img loading="lazy" src="keen6.gif" width="960" height="800" style="width: 100%; height: auto; border: 1px solid black;"/></a></td>
</tr>
</table>
<span style="text-align: center; display: block; margin-top: 1ch;margin-bottom: 2ch;"><i><small>Commander Keen 4, 5, and 6</small></i></span>

<p>How did they pull that off? John Carmack alluded to the answer on his Twitter account in 2020<a name="back_11" style="text-decoration: none;" href="index.html#footnote_11"><sup>[11]</sup></a>.
</p>  

  <blockquote>
The second Keen trilogy used a better trick -- just keep panning and redrawing the leading edge, letting the screen wrap around at the 64k aperture edge.<br/>
        <br/>
        <div>- John Carmack</div>
    </blockquote> 

<p>An explanation further elaborated during an interview with Lex Fridman in 2022<a name="back_12" style="text-decoration: none;" href="index.html#footnote_12"><sup>[12]</sup></a>.</p>

  <blockquote>I finally asked what actually happens if you just go off the edge [OF THE VRAM]? 
<br/><br/>
If you take your [CRTC] start and you say
OK, I can move over and I get to what should be the bottom of the memory window.
[...] What happens if I start at 0xFFFE at the very end of the 64k block? It
turns out it just wraps back around to the top of
the block.

<br/><br/>
I'm like oh well this makes everything easy. You can just
scroll the screen everywhere and all you
have to draw is just one new line of
tiles. 
<br/><br/>
It just works. We no longer had the problem of having fields of similar colors. It doesn't matter what you're
doing, you could be having a completely unique world and you're just drawing the new strip.
<br/>
        <br/>
        <div>- John Carmack</div>
    </blockquote> 

<p>So there we have the explanation. ATR was improved upon not by adding a feature but by removing one. Without the jolt, the CRTC start address drift in VRAM space until it wraps around the 64KiB space of the banks. Since it happens with both elements of the double buffer, they drift at the same speed and never overlap. It worked well most of the time.</p>

  <blockquote>
This is so simple, it
just works and it's faster. It
seemed like there was no downside.<br/>
<br/>
Funny thing was it turned out, after we
shipped titles with this, there were super vga cards, allowing higher resolutions and
different features that the
standard ones didn't.
<br/>
<br/>On some of those cards
there was a weird compatibility quirk
again because nobody thought this was what it was designed to do and some
of those cards had more memory.  They had more than just 256k and four planes they
had 512k or a megabyte and on some of
those cards I scroll my window down and then it goes
into uninitialized memory that actually
exists instead of wrapping back
around at the top!<br/>
        <br/>

I was in a tough position. Do I
have to track every single one of these [SUPER VGA CARDS]
and it was a madhouse back then with 20 different video card
vendors with all slightly different
implementations of their non-standard
functionality. Either I needed to
natively program all of the 
cards or I kind of
punt. I took the easy solution of
when you finally did run to the edge of
the screen I accepted a hitch and just
copied the whole screen up.


        <div>- John Carmack</div>
    </blockquote> 

<p>This technique likely prevented tiles and sprites to be stored in VRAM (to use the fast 32-bit at a time VRAM to VRAM copy method popularized by Michael Abrash). But since very little has to be drawn each frame, it probably did not matter.</p>
<style type='text/css'>td.ref {  padding-bottom: 0ch; width:0;}</style><div class='heading'>References</div><hr/><p id='paperbox' style='text-align:left;'><table><tbody style='vertical-align: top;'><tr><td class='ref' style='width:1ch;'><a name="footnote_1"></a><a href="index.html#back_1">^</a></td><td  class='ref' style='width:4ch;'> [ 1]</td><td style='width:100%;text-align:left;' class='ref'>EGA memory map [0xA000:0000, 0xA000:FFFF].</td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_2"></a><a href="index.html#back_2">^</a></td><td  class='ref' style='width:4ch;'> [ 2]</td><td style='width:100%;text-align:left;' class='ref'><a href="IBM_Enhanced_Graphics_Adapter.pdf">IBM, Enhanced Graphics Adapter: 16/64 Color Graphics Modes (Mode 10)</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_3"></a><a href="index.html#back_3">^</a></td><td  class='ref' style='width:4ch;'> [ 3]</td><td style='width:100%;text-align:left;' class='ref'><code>Dh</code> == <code>0xD</code> but it feels more oldschool to write with the <code>H></code> prefix.</td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_4"></a><a href="index.html#back_4">^</a></td><td  class='ref' style='width:4ch;'> [ 4]</td><td style='width:100%;text-align:left;' class='ref'><a href="http://www.techhelpmanual.com/89-video_memory_layouts.html#:~:text=EGA%20320x200%2C%2016%2Dcolor">EGA: Video Memory Layouts</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_5"></a><a href="index.html#back_5">^</a></td><td  class='ref' style='width:4ch;'> [ 5]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://www.phatcode.net/res/224/files/html/ch23/23-04.html">Michael Abrash's Graphics Programming Black Book, Chapter 23</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_6"></a><a href="index.html#back_6">^</a></td><td  class='ref' style='width:4ch;'> [ 6]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://twitter.com/id_aa_carmack/status/1282010053881597952">The trick behind the scrolling in the first Commander Keen...</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_7"></a><a href="index.html#back_7">^</a></td><td  class='ref' style='width:4ch;'> [ 7]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://retrocomputing.stackexchange.com/questions/22175/what-is-adaptive-tile-refresh-in-the-context-of-commander-keen">What is 'Adaptive Tile Refresh' in the context of Commander Keen?</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_8"></a><a href="index.html#back_8">^</a></td><td  class='ref' style='width:4ch;'> [ 8]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://archive.org/details/PC_Tech_Journal_V4N10/page/n85/mode/2up">PC Tech Journal Oct 1986, part 1</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_9"></a><a href="index.html#back_9">^</a></td><td  class='ref' style='width:4ch;'> [ 9]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://archive.org/details/PC_Tech_Journal_vol04_n11/page/n151/mode/2up">PC Tech Journal Nov 1986, part 2</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_10"></a><a href="index.html#back_10">^</a></td><td  class='ref' style='width:4ch;'> [10]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://github.com/keendreams/keen">Commander Keen in Keen Dreams source code</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_11"></a><a href="index.html#back_11">^</a></td><td  class='ref' style='width:4ch;'> [11]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://twitter.com/ID_AA_Carmack/status/1282010053881597952">The second Keen trilogy used a better trick</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_12"></a><a href="index.html#back_12">^</a></td><td  class='ref' style='width:4ch;'> [12]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://www.youtube.com/watch?v=jDF3_GH-kpM">The secret to Commander Keen: Side scrolling explained</a></td></tr></tbody></table></p> <hr>
 <center>*