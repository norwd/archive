<html>
<head>
  <link rel="alternate" type="application/rss+xml"  title="RSS Feed for fabiensanglard.net" href="https://fabiensanglard.net/rss.xml" />
  <style type="text/css">

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono.woff2');
      font-display: block;
    }

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono-Bold.woff2');
      font-weight: bold;
      font-display: block;
    }

    * {
       font-size: 16px;
    }

    html {
      font-family: fabfont,  monospace;
      max-width: 900px;  /* For Desktop PC (see @media for Tablets/Phones) */
      padding-left: 2%;
      padding-right: 3%;
      margin: 0 auto;
      background: #F5F5F0;
  	} 
    


  	a {
      color: black;
      font-weight: bold;
    }

    img {
      border: none; 
    }

    p {
      margin-top: 0px;
      text-align: justify;
    }
    sup {
      vertical-align: 0.3em;
      font-size: 0.65em;
    }   

    pre {
      font-family: fabfont, monospace;
      background-color: white; 
      border: 1px solid Black; 
      padding-left: 2%;
      padding-top: 1ch;
      padding-bottom: 1ch;
      /* Only take care of X overflow since this is the only part that can be too wide.
         The Y axis will never overflow.
      */
      overflow: hidden;
    }

    div.heading {
      font-weight: bold;      
      text-transform: uppercase;
      margin-top: 4ch;
    }

    /** {
      font-size: 16px;
    }*/
    @media (max-width: 500px) { /* For small screen decices */
      * {
        font-size: 12px; 
      }
    }   
    .title {
      text-decoration: none;
    }

    img.pixel, canvas.pixel {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

  code {
    /*font-size: 110%;*/
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
  }

  .trivia {
    border-left: 1px black solid;
    padding-left: 1ch;
  }

  .trivia::before {
  font-weight: bold;
  text-decoration: underline;
  padding-right: 1ch;
  content: "Trivia:";

  </style>
  <title>A Linux evening</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=12.0, minimum-scale=1.0, user-scalable=yes">
</head>  
  <body><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="https://fabiensanglard.net/" class="title"><b>FABIEN SANGLARD'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<!-- <a class="title" href="/about/index.html">ABOUT</a> &nbsp;<a class="title" href="/contact/index.html">EMAIL</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">DONATE</a></div></div> -->
<a class="title" href="https://fabiensanglard.net/about/index.html">ABOUT</a> &nbsp;<a class="title" href="https://fabiensanglard.net/contact/index.html">CONTACT</a> &nbsp;<a class="title" href="https://fabiensanglard.net/rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">GIVE</a></div></div>

</center><br><br>
<div style="margin-bottom: 2ch;text-transform: none;">
December 16, 2022</div>
<div class='heading'>A Linux evening</div><hr/>
<style type="text/css">
pre {
  color: white;
  background: rgb(48, 10, 36);
}  
</style>
<style>
    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

</style>
  

<p>
I love to have Linux as my main OS. For someone who spends most of his time programming, writing HTML, writing LaTeX, and browsing the net, it is nearly a perfect tool. Packages are one "apt install" away. Mounting my website is one sshfs away and with private key authentication I don't even have to type my password. Sublime Text and the Jetbrains IDE suite work like a charm. I could go on and on.
</p>
<p>Yet, occasionally, my system malfunctions to a point it requires a significant effort to fix it. Really bad occurrences result in disheartening hours googling in the hope that someone more qualified ran into the same issue. The latest episode involved a Fantom 2TB eXtreme Thunderbolt 3 External SSD.</p>


<img loading="lazy" src="fantom.webp" width="970" height="600" style="width: 100%; height: auto; margin-bottom:2ch; border:solid black 1px;"/>   

<div class='heading'>The SSD of discord</div><hr/><p>
I have vouched to avoid USB and its undecipherable specs. Therefore, when I can, I go Thunderbolt. For backup purposes I got a Fantom 2TB eXtreme Thunderbolt 3 External SSD.
</p>
  
<ul> 
  <li>Plug it in my Thinkpad Carbon Gen 9 running Ubuntu. It <span style="color:green;">works</span>.</li>
    <li>Plug it in my MacBook Pro laptop. It <span style="color:green;">works</span>.</li>
      <li>Plug it in my <a href="https://fabiensanglard.net/d2r/">DA2</a> running Windows (I play Diablo 2 resurrected a lot :P). It <span style="color:green;">works</span>. </li>
        <li>Dual boot the same <a href="https://fabiensanglard.net/d2r/">DA2</a> to Ubuntu. It does <span style="color:red;">not work</span>.</li>
</ul>
<p>There goes my evening....</p>



<div class='heading'>The problem</div><hr/><p>
When I connect the drive with a Thunderbolt cable, the OS detects it. But nothing gets mounted. It does not show in Disk application either. I can't even mount it using the UUID. Like a Schrödinger SSD, it is there but it is not.
</p>

<pre>$ boltctl
 <font color="#26A269">●</font> Micronet Technology Fantom Drives eXtreme
   ├─ type:          peripheral
   ├─ name:          Fantom Drives eXtreme
   ├─ vendor:        Micronet Technology
   ├─ uuid:          00ca782d-dcfa-3e02-ffff-ffffffffffff
   ├─ generation:    Thunderbolt 3
   ├─ status:        authorized
   │  ├─ domain:     0deb8780-00cc-9858-ffff-ffffffffffff
   │  ├─ rx speed:   40 Gb/s = 2 lanes * 20 Gb/s
   │  ├─ tx speed:   40 Gb/s = 2 lanes * 20 Gb/s
   │  └─ authflags:  none
   ├─ authorized:    Fri 16 Dec 2022 08:18:22 AM UTC
   ├─ connected:     Fri 16 Dec 2022 08:18:22 AM UTC
   └─ stored:        Thu 15 Dec 2022 07:02:21 AM UTC
      ├─ policy:     iommu
      └─ key:        no
</pre>


<div class='heading'>The search game</div><hr/><p> I gather the specs of my machine. I can't remember what motherboard I used to build the DA2. neofetch won't tell me but CPU-X does.</p>

<a href="cpux1.png"><img loading="lazy" src="cpux1.webp" width="1034" height="1162" style="width: 32%; height: auto; margin-bottom:2ch;"/></a>
<a href="cpux2.png"><img loading="lazy" src="cpux2.webp" width="1034" height="1162" style="width: 32%; height: auto; margin-bottom:2ch; "/> </a>
<a href="cpux3.png"><img loading="lazy" src="cpux3.webp" width="1034" height="1162" style="width: 32%; height: auto; margin-bottom:2ch; "/> </a>

<p>
I google variations of "z590 TB3 SSD not working" for a while, even going down to page three as my despair deepens, and find nothing relevant. A <a href="https://twitter.com/g051051/status/1603540238500040704">kind soul</a> on Twitter reminds me of dmesg outputs. I notice a <span style="color:red;">red line</span> which may be related.
</p>

<pre>$ sudo dmesg 
<font color="#26A269">[   45.573575] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: pciehp: Slot(1): Card present
<font color="#26A269">[   45.573584] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: pciehp: Slot(1): Link Up
<font color="#26A269">[   45.709870] </font><font color="#A2734C">pci 0000:06:00.0</font>: [8086:15da] type 01 class 0x060400
<font color="#26A269">[   45.709964] </font><font color="#A2734C">pci 0000:06:00.0</font>: enabling Extended Tags
<font color="#26A269">[   45.710179] </font><font color="#A2734C">pci 0000:06:00.0</font>: supports D1 D2
<font color="#26A269">[   45.710180] </font><font color="#A2734C">pci 0000:06:00.0</font>: PME# supported from D0 D1 D2 D3hot D3cold
<font color="#26A269">[   45.710343] </font><font color="#A2734C">pci 0000:06:00.0</font>: 8.000 Gb/s available PCIe bandwidth, limited by 2.5 GT/s PCIe x4 link at 0000:04:01.0 (capable of 31.504 Gb/s with 8.0 GT/s PCIe x4 link)
<font color="#26A269">[   45.721928] </font><font color="#A2734C">pci 0000:06:00.0</font><font color="#C01C28">: No bus number available for hot-added bridge</font>
<font color="#26A269">[   45.721931] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: bridge window [mem 0x00100000-0x000fffff 64bit pref] to [bus 06] add_size 200000 add_align 100000
<font color="#26A269">[   45.721934] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: bridge window [mem 0x00100000-0x000fffff] to [bus 06] add_size 200000 add_align 100000
<font color="#26A269">[   45.721936] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 14: no space for [mem size 0x00200000]
<font color="#26A269">[   45.721938] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 14: failed to assign [mem size 0x00200000]
<font color="#26A269">[   45.721939] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 15: no space for [mem size 0x00200000 64bit pref]
<font color="#26A269">[   45.721940] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 15: failed to assign [mem size 0x00200000 64bit pref]
<font color="#26A269">[   45.721941] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 14: no space for [mem size 0x00200000]
<font color="#26A269">[   45.721941] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 14: failed to assign [mem size 0x00200000]
<font color="#26A269">[   45.721942] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 15: no space for [mem size 0x00200000 64bit pref]
<font color="#26A269">[   45.721943] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: BAR 15: failed to assign [mem size 0x00200000 64bit pref]
<font color="#26A269">[   45.721944] </font><font color="#A2734C">pcieport 0000:04:01.0</font>: PCI bridge to [bus 06]
<font color="#26A269">[   45.721956] </font><font color="#A2734C">pcieport 0000:04:01.0</font>:   bridge window [io  0x6000-0x6fff]
</pre>

<p>
I google it and end up <a href="https://forum.level1techs.com/t/asrock-x570-phantom-tb3-itx-and-linux-no-bus-number-available-for-hot-added-bridge/156951/2">here</a>. I don't understand any of the described solution. It looks like the kernel needs a parameter to set the bus size for a pci channel. After several hours in, I'll try anything.
 </p> 

<pre>
# vi /etc/default/grub 
<span style="color:gray;">// add "pci=realloc,assign-busses,hpbussize=0x33" to GRUB_CMDLINE_LINUX_DEFAULT</span>
# update-grub
$ reboot
</pre>  

<p>The machine reboots. And to my amazement, it <span style="color:green;">works</span>.</p>


<p>
I pause and wonder how many hours one must have invested to become so highly skilled on such an esoteric topic. I find comfort in user <i>zxmth</i>'s question, asserting I was not alone left in awe.</p>

<blockquote>
  Out of curiosity, how did you come up with this solution?
    <br>
<br>
        <div>- zxmth</div>
    </blockquote>
<p>The author,  <i>dkozel</i>, never came back to answer. I imagine they typed the solution on a 40% keyboard featuring unmarked keys and then rolled into the sunset on a Segway for which they had compiled the kernel themselves. Completely oblivious of their awesomeness and of how many people would later find solace in their prose.</p>


<div class='heading'>Take away 1</div><hr/><p>
When I emerge from these "Linux evenings", I wonder if the real problem is my attitude. After all, if I elect to use Linux, a niche market by all means, shouldn't I be ready for these kinds of quests?  "I just want a tool that works!" feels entitled and I don't have an answer to this question.
</p>

<div class='heading'>Take away 2</div><hr/><p>
I spent several hours fixing a problem and I learned next to nothing in the process. This trick is unlikely to be useful again. By the time I encounter something similar, it is likely I will have forgotten about the solution.
</p>

<p> Even worse is to feel like I could have invested hundreds of hours in research and may not have been able to fix it on my own anyway.  
</p>

<div class='heading'>Take away 3</div><hr/><p>
Despite these kinds of annoyances, I don't want to switch to Mac or Windows. Linux is just too good for my usage.
</p>

<div class='heading'>Take away 4</div><hr/><p>
<p>When I think of 20 years ago, when it was hard to even get a Debian to display a GUI, it is obvious the community has come a long way. Linux evenings are pretty rare and it seems that all is missing is to reach a critical mass of users so companies invest in better Linux drivers and firmware.
</p>
<p>In the meantime, the best I can think of is to pay for my distro, report bugs, and email manufacturers for Linux support. 
</p>

<div class='heading'>Take away 5</div><hr/><p>I still wish I knew what was wrong.</p>

<div class='heading'>Take away 6</div><hr/><p><i>dkozel</i> and your kind, whoever you are, wherever you are, and whatever you are doing right now, you are legend.</p>


<div class='heading'>Post-Mortem (Dec 17, 2022)</div><hr/><p>
After publication of this article <a href="https://news.ycombinator.com/item?id=34013195">on Hacker News</a>, the world was able to put a name on the hero of this story. Derek Kozel came back <a href="https://news.ycombinator.com/item?id=34016094">to explain</a> how he came up with the solution and why he chose the value 0x33.

</p>
 <hr>
 <center>*