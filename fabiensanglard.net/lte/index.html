<html>
<head>
  <link rel="alternate" type="application/rss+xml"  title="RSS Feed for fabiensanglard.net" href="../rss.xml" />
  <style type="text/css">

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono.woff2');
      font-display: block;
    }

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono-Bold.woff2');
      font-weight: bold;
      font-display: block;
    }

    * {
       font-size: 16px;
    }

    html {
      font-family: fabfont,  monospace;
      max-width: 900px;  /* For Desktop PC (see @media for Tablets/Phones) */
      padding-left: 2%;
      padding-right: 3%;
      margin: 0 auto;
      background: #F5F5F0;
  	} 
    


  	a {
      color: black;
      font-weight: bold;
    }

    img {
      border: none; 
    }

    p {
      margin-top: 0px;
      text-align: justify;
    }
    sup {
      vertical-align: 0.3em;
      font-size: 0.65em;
    }   

    pre {
      font-family: fabfont, monospace;
      background-color: white; 
      border: 1px solid Black; 
      padding-left: 2%;
      padding-top: 1ch;
      padding-bottom: 1ch;
      /* Only take care of X overflow since this is the only part that can be too wide.
         The Y axis will never overflow.
      */
      overflow: hidden;
    }

    div.heading {
      font-weight: bold;      
      text-transform: uppercase;
      margin-top: 4ch;
    }

    /** {
      font-size: 16px;
    }*/
    @media (max-width: 500px) { /* For small screen decices */
      * {
        font-size: 12px; 
      }
    }   
    .title {
      text-decoration: none;
    }

    img.pixel, canvas.pixel {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

  code {
    /*font-size: 110%;*/
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
  }

  .trivia {
    border-left: 1px black solid;
    padding-left: 1ch;
  }

  .trivia::before {
  font-weight: bold;
  text-decoration: underline;
  padding-right: 1ch;
  content: "Trivia:";

  </style>
  <title>Observing my cellphone switch towers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=12.0, minimum-scale=1.0, user-scalable=yes">
</head>  
  <body><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="../index.html" class="title"><b>FABIEN SANGLARD'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<!-- <a class="title" href="/about/index.html">ABOUT</a> &nbsp;<a class="title" href="/contact/index.html">EMAIL</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">DONATE</a></div></div> -->
<a class="title" href="../about/index.html">ABOUT</a> &nbsp;<a class="title" href="../contact/index.html">CONTACT</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">GIVE</a></div></div>

</center><br><br>
<div style="margin-bottom: 2ch;text-transform: none;">
May 15, 2021</div>
<div class='heading'>Observing my cellphone switch towers</div><hr/><style type="text/css">
    img {
        border: 1px black solid;
    }
 
.w td, .w th, .w tr {
  border: 1px solid black;
  padding: 1ch;
}

.w {
  border: 1px solid black;
  padding: 1ch;
  width: 100%;
  border-collapse: collapse;
  background-color: #fff;
}
</style>
  
</style>
<p style="margin-bottom: 2ch;">
One of my favorite books is 2013 <i>"High Performance Browser Networking"</i> by Ilya Grigorik. Besides a wealth of actionable advice, the book is illustrated with captivating real life stories.  
<br/> 
<blockquote>
46% of Battery Consumption to Transfer 0.2% of Total Bytes<br/>
==========================================================
<br/>
<br/>
Whenever a Pandora user plays a song, the entire music file is streamed by the application from the network in one shot, which is the correct behavior: burst as much data
as you can, then turn off the radio for as long as possible.
<br/>
<br/>
However, following the music
transfer, the application would conduct periodic audience measurements by sending
intermittent analytics pings every 60 seconds. The net effect? The analytics beacons
accounted for 0.2% of the total transferred bytes and 46% of the total power consumption of the application!
<br/>
<br/>
<div>- Ilya Grigorik, <i>High Performance Browser Networking</i></div>
</blockquote>

<p style="margin-bottom: 2ch;">
Ilya takes the time to go deep to make his points across. To enlighten readers on the topic of cellphone battery life, he dedicates a whole chapter to detail the GSM, UMTS, and LTE radio modem. It is fascinating to realize that problems at one level can find their roots several layers below.
<br/> 
<br/>
By exploring the whole stack, <i>High Performance Browser Networking</i> does more than providing facts. It advocates a philosophy.
<br/>
<blockquote>
&nbsp;Good developers know how things work.<br/> 
Great developers know why things work.<br/>
  <br/>
  <div>- Steve Souders, <i>High Performance Browser Networking</i> Forewords</div>
</blockquote>
</p>

<div class='heading'>An old idea is new again</div><hr/><p>
Back when I read it, in 2013, I thought it would have been cool to do my own exploration and visualize how the radio jumped from one cell to another while the phone traveled.
<br/>
<br/>
The idea was not doable with my 2013 iOS phone since it did not expose the data I needed but my current Pixel does not have this issue. LocationManager can provide a GPS location (lat,long) every second. Meanwhile, TelephonyManager gives the cellID=(mmc,mcc,lac,cid) the radio is currently camping on.
<br/>
<br/>
A cellID database<a name="back_1" style="text-decoration: none;" href="index.html#footnote_1"><sup>[1]</sup></a>, allows to know the (lat,long) of each CellID. What is left is to draw the itinerary (in red) and, for each second, a cellID-color-coded connection to the cell.
<br/>
<br/>
<a href="short_trip.png">
<img loading="lazy" src="short_trips.webp" width="1000" height="574" style="width: 100%; height: auto; "/></a>
<span style="text-align: center; display: block; margin-top: 1ch; margin-bottom: 2ch;"><i><small>A drive from Sunnyvale to downtown Mountain View.</small></i></span>

The result above shows a 7 minutes drive covering 2.3 miles (3.7 km) with an LTE capable phone (a.k.a UE for User Equipment). Along the way, five towers and nine cells (a.k.a eNB for Evolved NodeB) were encountered.<br/> 
</p> 





<div class='heading'>Analysis</div><hr/><p>
    <a href="column.png">
<img loading="lazy" src="columns.webp" width="901" height="1578" style="width: 40%; height: auto; float:right; margin-bottom: 2ch; margin-left: 2ch;"/></a>
   Combining the map, Google StreetView, and Wikipedia allowed to understand a lot of things.
    <br/>
<br/>
    - Several cellIDs map to the same eNB lat/long coordinates. That's because the antennas mounted on an eNB don't have 360&deg; coverage. The angle and range of each antenna carves the space into pizza slice shaped cells.
<br/>
<br/>
    - Antennas are positioned and oriented strategically. In the map on the right, towers are posted along highway 85 and antennas pointed parallel to it. Some antennas seem to have exceptionally narrow and long range. Possibly to accommodate the high density during traffic jams.
    <br/>
<br/>
- eNBs have a much higher density than I thought. Googling about "cellphone tower range" returned a 45 miles figure. That may be true in rural areas but in a city, population density and eNB density are correlated. That means there were towers every mile in Sunnyvale. 
    <br/>
<br/>
- Sites are not necessarily shared among operators. The accuracy of the CellID database (CellMapper) is so high that I was able to go on Google StreetView and see the actual towers. I expected to see huge monoliths with large arrays of antenna for each operators but most of the time it looked like a single one was there. 
<br/>
<br/>
- eNB antennas can be found on many things besides <a href="https://www.google.com/maps/@37.4124115,-122.0767249,3a,75y,8.76h,106.96t/data=!3m6!1e1!3m4!1sPtIcI4FsiLCl9enaaJ-dFw!2e0!7i16384!8i8192">masts</a><a name="back_2" style="text-decoration: none;" href="index.html#footnote_2"><sup>[2]</sup></a>. Some of the locations include <a href="https://www.google.com/maps/@37.3734952,-122.0479617,3a,75y,331.1h,104.11t/data=!3m6!1e1!3m4!1sVg7P2Z7buC-iDMR4937mjA!2e0!7i16384!8i8192">churches</a><a name="back_3" style="text-decoration: none;" href="index.html#footnote_3"><sup>[3]</sup></a>, <a href="https://www.google.com/maps/@37.3691327,-122.0525092,3a,75y,329.25h,107.14t/data=!3m6!1e1!3m4!1shTiSDRwqbbH4jFeNwIj9oA!2e0!7i13312!8i6656">electric pylons</a><a name="back_4" style="text-decoration: none;" href="index.html#footnote_4"><sup>[4]</sup></a>, and even commercial buildings. 
<br/>
<br/>
- Once you are in the habit of looking for them, these once invisible cell towers become impossible to ignore.
<br/>
<br/>
- The UE's LTE radio is able to jump from cells back and forth. Several times within a minute seems to be a common occurrence within a city to palliate to building obstruction. 
<br/>
<br/>

- Tower pairing (a.k.a camping) looks deterministic. In the two previous maps, the tower usage looks similar in the shared portion of the trip. The selection happens according to a state-machine configured by each cell via broadcast SIB messages. The state transition happens based on multiple factors such a previous cell signal strength threshold or next cell signal strength threshold. 
<br/> 
<br/> 
- On a "long" (10 miles) driving session I saw that the LAC (Location Area Code) part of the CellID remained the same. According to the LTE specs, cell-towers don't have to perform UE hand-overs when a phone remains in the LAC. The phone starts camping on the next tower while remaining in RCC_IDLE mode without emitting data. Not only does this save battery, it also means operators don't really know where the phone is as long as it remains in the same LAC (although the accuracy of cell-based geolocation has been disputed ever since GSM<a name="back_5" style="text-decoration: none;" href="index.html#footnote_5"><sup>[5]</sup></a>).
<br/>
<br/>

- Each tower seems to use three 120&deg; antennas. It is pretty obvious when circling around one.<br/>
<a href="radius.png">
<img loading="lazy" src="radiuss.webp" width="1000" height="505" style="width: 100%; height: auto; margin-bottom: 0ch; margin-top: 2ch;"/></a>
<span style="text-align: center; display: block; margin-top: 1.5ch; margin-bottom: 2ch;"><i><small>Traveling around a tower reveals the 120&deg; radius of each cells.</small></i></span>

</p>

<div class='heading'>Further down the rabbit hole</div><hr/> 
<p>
Drawing maps was fun. It made me want to learn more about the field. I found it to not only be deep but also quite broad. Even drawing a minimal table to summarize it required a substantial amount of acronym research.
<br/>



    <table class="w" style="margin-top:  2ch;">
    	<tr><th>Generation</th><th>Technology</th><th>Marketing</th><th>Notes</th></tr>


        <tr><td rowspan="1">0G</td><td colspan="2">Car Phones</td><td>Phillip  Drummond's phone</td></tr>	

    	<tr><td rowspan="1">1G</td><td colspan="2">DynaTAC</td><td>Gordon Gekko's phone</td></tr>	
    	

    	<tr><td rowspan="4">2G</td><td rowspan="3">GSM</td><td>GSM</td><td>Nokia 3310 (The Brick). SMS capable</td></tr>	
        <tr><td>GPRS</td><td>Voice OR data (no simultaneous)</td></tr>	
        <tr><td>EDGE</td><td>iPhone 1</td></tr>	
        <tr><td>cdmaOne</td><td>CDMA</td><td></td></tr>	

    	<tr><td rowspan="3">3G</td><td rowspan="2">UMTS</td><td>HSPA</td><td>iPhone 3GS. Simultaneous voice and data</td></tr>
        <tr>                                                <td>HSPA+</td><td></td></tr>
        <tr>                       <td>CDMA2000</td><td>C2K</td><td></td></tr>	

    	<tr><td rowspan="3">4G</td><td>LTE</td><td>LTE</td><td>iPhone 5 / Pixel 1</td></tr>
    	<tr>                       <td>LTE Advanced</td>    <td>LTE+</td><td></td></tr>
    	<tr>                       <td>LTE Advanced Pro</td><td>LTE Pro<td></td></tr>
     	

    	<tr><td rowspan="2">5G</td><td>5G</td><td>5G</td><td>iPhone 12 / Pixel 4a 5g</td></tr>	
    	<tr>                       <td>5G mmWave</td><td>5G mmWave</td><td>iPhone 12 Pro Max /Pixel 5G</td></tr>	
    </table>



<div class='heading'>An esoteric world</div><hr/> 
<p style="margin-bottom: 2ch;">
Starting in 1998 with 2G (GSM), all tech-stacks were standardized and documented by 3GPP. These specs span over hundreds of documents. Understanding them seems like a lifetime achievement.
           <br/>
    <br/>    
There are no open source LTE stack to learn from<a name="back_6" style="text-decoration: none;" href="index.html#footnote_6"><sup>[6]</sup></a> and even if there was, emitting on cellphone bands is highly regulated in order to make sure frequencies are not polluted with buggy modems.
    <br/>
<br/>

The few books in the fields are very expensive. My "genuine window of interest" was fueled by these three.
        <ul>
            <li>
                An introduction to LTE by Christopher Cox.
            </li>
            <li>
LTE Advanced by Sassan Ahmadi.
</li>
            <li>
Long Term Evolution In Bullets, 2nd Edition by Chris Johnnson.
</li>
</ul>
<p>
Finally, there are apps that allow to peek under the hood to show the modem state and messages. I elected not to use them since not only they are expensive, they also require to root the phone.
</p>





<div class='heading'>The other side of the Pandora story</div><hr/><p>
After the publication of this article, I was contacted by developer Neil Mix who developed the Pandora app on iOS. He shared some interesting insight and reminded us that there are often two sides to a story.
</p>
<blockquote>
 I was the developer of Pandora's iPhone app during the time that the behavior Ilya Grigorik describes was implemented. 
<br/>
<br/>
 I was well aware of the negative battery impact caused by the analytics pings. Those pings were required by the business to support metrics for advertisers to gauge Pandora's usage and reach, which in-turn underpinned the advertising revenue that supported the company. Without those pings, it's possible the company would have been unable to stay financially solvent!
<br/>
<br/>

  I would have much preferred that the analytics be delivered in batch at the same time we loaded audio, thereby minimizing antenna usage. But, the nature of the analytics required we use a 3rd-party partner to collect and verify. We collaborated with the 3rd-party on a project to implement a batch protocol, but for reasons that were never quite clear to me they were unable or unwilling to complete the project during my tenure at the company. I remember being quite frustrated by it.
<br/>
<br/>

I find it fascinating how the promise of technology is so often inhibited by the circumstances of real-world issues that have nothing at all to do with technology.
<br/>
<br/>

  <div>- Neil Mix</div>
</blockquote>











































<!-- <p style="margin-bottom: 2ch;">
People have reverse engineered Qualcomm and MediaTek chipsets protocol to peek into the modem.
    <ul>
        <li>
            Network Signal Guru
        </li>
        <li>
Mobile Insight
        </li>
        <li>
CellMapper
        </li>
    </ul>
</p>


 -->
















<style type='text/css'>td.ref {  padding-bottom: 0ch; width:0;}</style><div class='heading'>References</div><hr/><p id='paperbox' style='text-align:left;'><table><tbody style='vertical-align: top;'><tr><td class='ref' style='width:1ch;'><a name="footnote_1"></a><a href="index.html#back_1">^</a></td><td  class='ref' style='width:4ch;'> [1]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://en.wikipedia.org/wiki/GSM_Cell_ID">Wikipedia list of CellID databases</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_2"></a><a href="index.html#back_2">^</a></td><td  class='ref' style='width:4ch;'> [2]</td><td style='width:100%;text-align:left;' class='ref'><a href="cell_mast.png">Cell tower on a mast</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_3"></a><a href="index.html#back_3">^</a></td><td  class='ref' style='width:4ch;'> [3]</td><td style='width:100%;text-align:left;' class='ref'><a href="cell_church.png">Cell tower on a church</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_4"></a><a href="index.html#back_4">^</a></td><td  class='ref' style='width:4ch;'> [4]</td><td style='width:100%;text-align:left;' class='ref'><a href="cell_power.png">Cell tower on an electric pylon</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_5"></a><a href="index.html#back_5">^</a></td><td  class='ref' style='width:4ch;'> [5]</td><td style='width:100%;text-align:left;' class='ref'><a href="Viewpoint_J-F.pdf">Cell tower junk science</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_6"></a><a href="index.html#back_6">^</a></td><td  class='ref' style='width:4ch;'> [6]</td><td style='width:100%;text-align:left;' class='ref'>...at least none that will work on iOS or Android. There are however projects such as <a href=' https://osmocom.org/projects'>Osmocom</a> and <a href='https://www.srsran.com/'>srsRAN</a>.</td></tr></tbody></table></p> <hr>
 <center>*