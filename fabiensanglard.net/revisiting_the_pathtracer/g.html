<a href="g.cu" style="font-family: monospace;">Raw source</a>
<hr/> 




<pre style="color:#000000;background:#ffffff;"><span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">math.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdio.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdint.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">float.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">limits.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdlib.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">windows.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">sysinfoapi.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">curand_kernel.h</span><span style="color:#800000; ">&gt;</span>

<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> w  960</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> h  540</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> BPP 3</span>

<span style="color:#800000; font-weight:bold; ">struct</span> Vec <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> x<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">float</span> y<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">float</span> z<span style="color:#800080; ">;</span>

  __device__ Vec<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> v <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    x <span style="color:#808030; ">=</span> y <span style="color:#808030; ">=</span> z <span style="color:#808030; ">=</span> v<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  __device__ Vec<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> a<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> b<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    x <span style="color:#808030; ">=</span> a<span style="color:#800080; ">;</span>
    y <span style="color:#808030; ">=</span> b<span style="color:#800080; ">;</span>
    z <span style="color:#808030; ">=</span> c<span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  __device__  Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">+</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">const</span> Vec r<span style="color:#808030; ">)</span> <span style="color:#800000; font-weight:bold; ">const</span>  <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> Vec<span style="color:#808030; ">(</span>x <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">,</span> y <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">,</span> z <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
  __device__ Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">*</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">const</span> Vec r<span style="color:#808030; ">)</span> <span style="color:#800000; font-weight:bold; ">const</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span>   Vec<span style="color:#808030; ">(</span>x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">,</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
  __device__  <span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">%</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">const</span> Vec r<span style="color:#808030; ">)</span> <span style="color:#800000; font-weight:bold; ">const</span> <span style="color:#800080; ">{</span><span style="color:#800000; font-weight:bold; ">return</span>     x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span><span style="color:#800080; ">}</span>
  __device__ Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">!</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">*</span> rsqrtf<span style="color:#808030; ">(</span><span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">%</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>

__shared__ curandState_t states<span style="color:#808030; ">[</span>w<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
__device__ <span style="color:#800000; font-weight:bold; ">float</span> randomVal2<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
   <span style="color:#800000; font-weight:bold; ">return</span> curand_uniform<span style="color:#808030; ">(</span><span style="color:#808030; ">&amp;</span>states<span style="color:#808030; ">[</span>threadIdx<span style="color:#808030; ">.</span>x<span style="color:#808030; ">]</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span> 

__device__ <span style="color:#800000; font-weight:bold; ">int</span> g_seed<span style="color:#808030; ">=</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
__device__ <span style="color:#800000; font-weight:bold; ">float</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  g_seed <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">214013</span><span style="color:#808030; ">*</span>g_seed<span style="color:#808030; ">+</span><span style="color:#008c00; ">2531011</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>g_seed<span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span><span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span><span style="color:#808030; ">&amp;</span><span style="color:#008000; ">0x7FFF</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">/</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span><span style="color:#808030; ">)</span><span style="color:#008c00; ">66635</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>


<span style="color:#696969; ">// Rectangle CSG equation. Returns minimum signed distance from</span>
<span style="color:#696969; ">// space carved by</span>
<span style="color:#696969; ">// lowerLeft vertex and opposite rectangle vertex upperRight.</span>
__device__ <span style="color:#800000; font-weight:bold; ">float</span> BoxTest<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">const</span> Vec<span style="color:#808030; ">&amp;</span> position<span style="color:#808030; ">,</span> Vec lowerLeft<span style="color:#808030; ">,</span> Vec upperRight<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  lowerLeft <span style="color:#808030; ">=</span> position <span style="color:#808030; ">+</span> lowerLeft <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
  upperRight <span style="color:#808030; ">=</span> upperRight <span style="color:#808030; ">+</span> position <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">-</span>fminf<span style="color:#808030; ">(</span>
      fminf<span style="color:#808030; ">(</span>fminf<span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> fminf<span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
      fminf<span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_NONE 0</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_LETTER 1</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_WALL 2</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_SUN 3</span>

<span style="color:#696969; ">// Sample the world using Signed Distance Fields.</span>
__device__ <span style="color:#800000; font-weight:bold; ">float</span> QueryDatabase<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">const</span> Vec<span style="color:#808030; ">&amp;</span> position<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#808030; ">&amp;</span>hitType<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> distance <span style="color:#808030; ">=</span> <span style="color:#008000; ">1e9</span><span style="color:#800080; ">;</span><span style="color:#696969; ">//FLT_MAX;</span>
  Vec f <span style="color:#808030; ">=</span> position<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Flattened position (z=0)</span>
  f<span style="color:#808030; ">.</span>z <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  
  
  <span style="color:#800000; font-weight:bold; ">char</span> letters<span style="color:#808030; ">[</span><span style="color:#008c00; ">15</span><span style="color:#808030; ">*</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">+</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span>               <span style="color:#696969; ">// 15 two points lines</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5O5_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5W9W</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5_9_</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// P (without curve)</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">AOEO</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">COC_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">A_E_</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// I</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">IOQ_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">I_QO</span><span style="color:#800000; ">"</span>                <span style="color:#696969; ">// X</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">UOY_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">Y_]O</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">WW[W</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// A</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">aOa_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">aWeW</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">a_e_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">cWiO</span><span style="color:#800000; ">"</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// R (without curve)</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">&lt;</span> <span style="color:#800000; font-weight:bold; ">sizeof</span><span style="color:#808030; ">(</span>letters<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec begin <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>letters<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">,</span> letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span><span style="color:#800080; ">;</span>
    Vec e <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">,</span> letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span> <span style="color:#808030; ">+</span> begin <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    Vec o <span style="color:#808030; ">=</span> f <span style="color:#808030; ">+</span> <span style="color:#808030; ">(</span>begin <span style="color:#808030; ">+</span> e <span style="color:#808030; ">*</span> fminf<span style="color:#808030; ">(</span>
                                  <span style="color:#808030; ">-</span>fminf<span style="color:#808030; ">(</span>__fdividef<span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>begin <span style="color:#808030; ">+</span> f <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">%</span> e <span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>e <span style="color:#808030; ">%</span> e<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                                   <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span>
                             <span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    distance <span style="color:#808030; ">=</span> fminf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// compare squared distance.</span>
  <span style="color:#800080; ">}</span>
  distance <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Get real distance, not square distance.</span>
  

  <span style="color:#696969; ">// Two curves (for P and R in PixaR) with hard-coded locations.</span>
  Vec curves<span style="color:#808030; ">[</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> <span style="color:#800080; ">{</span>Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">11</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">11</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#808030; ">)</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">;</span> i<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec o <span style="color:#808030; ">=</span> f <span style="color:#808030; ">+</span> curves<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    distance <span style="color:#808030; ">=</span> fminf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> o<span style="color:#808030; ">.</span>x <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> fabsf<span style="color:#808030; ">(</span>sqrtf<span style="color:#808030; ">(</span>o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span>
                                     <span style="color:#800080; ">:</span> <span style="color:#808030; ">(</span>o<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> o<span style="color:#808030; ">.</span>y <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span> <span style="color:#800080; ">:</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">,</span> sqrtf<span style="color:#808030; ">(</span>o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  distance <span style="color:#808030; ">=</span> __powf<span style="color:#808030; ">(</span>
    <span style="color:#696969; ">// distance * distance * distance  * distance * </span>
    <span style="color:#696969; ">// distance * distance *</span>
    <span style="color:#696969; ">// distance  * distance  </span>
    powf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span>
    <span style="color:#808030; ">+</span> 
    <span style="color:#696969; ">// position.z * position.z * position.z * position.z *</span>
    <span style="color:#696969; ">// position.z * position.z * </span>
    <span style="color:#696969; ">// position.z * position.z</span>
    powf<span style="color:#808030; ">(</span>position<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span>
    <span style="color:#808030; ">,</span> <span style="color:#008000; ">0.125</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">0.5</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>

  hitType <span style="color:#808030; ">=</span> HIT_LETTER<span style="color:#800080; ">;</span>
  

  <span style="color:#800000; font-weight:bold; ">float</span> roomDist <span style="color:#800080; ">;</span>
  roomDist <span style="color:#808030; ">=</span> fminf<span style="color:#808030; ">(</span> <span style="color:#696969; ">// min(A,B) = Union with Constructive solid geometry</span>
                  <span style="color:#696969; ">//-min carves an empty space</span>
      <span style="color:#808030; ">-</span>fminf<span style="color:#808030; ">(</span>       <span style="color:#696969; ">// Lower room</span>
          BoxTest<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008000; ">.5</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">30</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
          <span style="color:#696969; ">// Upper room</span>
          BoxTest<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">17</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">20</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span>
      <span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
      BoxTest<span style="color:#808030; ">(</span> <span style="color:#696969; ">// Ceiling "planks" spaced 8 units apart.</span>
          Vec<span style="color:#808030; ">(</span>fmodf<span style="color:#808030; ">(</span>fabsf<span style="color:#808030; ">(</span>position<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> position<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> position<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
          Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">1.5</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">18.5</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> 
          Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">6.5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">20</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span>
      <span style="color:#808030; ">)</span>
  <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>roomDist <span style="color:#808030; ">&lt;</span> distance<span style="color:#808030; ">)</span>
    distance <span style="color:#808030; ">=</span> roomDist<span style="color:#808030; ">,</span> hitType <span style="color:#808030; ">=</span> HIT_WALL<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">float</span> sun <span style="color:#808030; ">=</span> <span style="color:#008000; ">19.9</span> <span style="color:#808030; ">-</span> position<span style="color:#808030; ">.</span>y<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Everything above 19.9 is light source.</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>sun <span style="color:#808030; ">&lt;</span> distance<span style="color:#808030; ">)</span>
    distance <span style="color:#808030; ">=</span> sun<span style="color:#808030; ">,</span> hitType <span style="color:#808030; ">=</span> HIT_SUN<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">return</span> distance<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">// Perform signed sphere marching</span>
<span style="color:#696969; ">// Returns hitType 0, 1, 2, or 3 and update hit position/normal</span>
__device__ <span style="color:#800000; font-weight:bold; ">int</span> RayMarching<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">const</span> Vec<span style="color:#808030; ">&amp;</span> origin<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">const</span> Vec<span style="color:#808030; ">&amp;</span> direction<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">&amp;</span> hitPos<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">&amp;</span> hitNorm<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> hitType <span style="color:#808030; ">=</span> HIT_NONE<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> noHitCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>

  <span style="color:#696969; ">// Signed distance marching</span>
  <span style="color:#800000; font-weight:bold; ">float</span> d<span style="color:#800080; ">;</span> <span style="color:#696969; ">// distance from closest object in world.</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> total_d <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> total_d <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">100</span><span style="color:#800080; ">;</span> total_d <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> d<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>d <span style="color:#808030; ">=</span> QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> total_d<span style="color:#808030; ">,</span> hitType<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&lt;</span> <span style="color:#008000; ">.01</span> <span style="color:#808030; ">|</span><span style="color:#808030; ">|</span> <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span>noHitCount <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">99</span><span style="color:#808030; ">)</span>
      <span style="color:#800000; font-weight:bold; ">return</span> hitNorm <span style="color:#808030; ">=</span>
                 <span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span>QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">.01</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">,</span>
                      QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">,</span>
                      QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
             hitType<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Weird return statement where a variable is also</span>
                      <span style="color:#696969; ">// updated.</span>
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

__device__ Vec Trace<span style="color:#808030; ">(</span>Vec origin<span style="color:#808030; ">,</span> Vec direction<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  Vec sampledPosition<span style="color:#800080; ">;</span>
  Vec normal<span style="color:#800080; ">;</span>
  Vec color <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  Vec attenuation <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  Vec lightDirection<span style="color:#808030; ">(</span><span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">0.6</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">0.6</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Directional light</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> bounceCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">3</span><span style="color:#800080; ">;</span> bounceCount<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">int</span> hitType <span style="color:#808030; ">=</span> RayMarching<span style="color:#808030; ">(</span>origin<span style="color:#808030; ">,</span> direction<span style="color:#808030; ">,</span> sampledPosition<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_NONE<span style="color:#808030; ">)</span>
      <span style="color:#800000; font-weight:bold; ">break</span><span style="color:#800080; ">;</span>                     <span style="color:#696969; ">// No hit. This is over, return color.</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_LETTER<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">// Specular bounce on a letter. No color acc.</span>
      direction <span style="color:#808030; ">=</span> direction <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>normal <span style="color:#808030; ">%</span> direction <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      origin <span style="color:#808030; ">=</span> sampledPosition <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.1</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
      attenuation <span style="color:#808030; ">=</span> attenuation <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.2</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Attenuation via distance traveled.</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_WALL<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">// Wall hit uses color yellow?</span>
      <span style="color:#800000; font-weight:bold; ">float</span> incidence <span style="color:#808030; ">=</span> normal <span style="color:#808030; ">%</span> lightDirection<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> p <span style="color:#808030; ">=</span> <span style="color:#008000; ">6.283185</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">*</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> s <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">-</span> c<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> g <span style="color:#808030; ">=</span> normal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#800080; ">:</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> u <span style="color:#808030; ">=</span> __fdividef<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>g <span style="color:#808030; ">+</span> normal<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> v <span style="color:#808030; ">=</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> u<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> cosp<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> sinp<span style="color:#800080; ">;</span>
      __sincosf<span style="color:#808030; ">(</span>p<span style="color:#808030; ">,</span> <span style="color:#808030; ">&amp;</span>sinp<span style="color:#808030; ">,</span> <span style="color:#808030; ">&amp;</span>cosp<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> 
      direction <span style="color:#808030; ">=</span>
          Vec<span style="color:#808030; ">(</span>v<span style="color:#808030; ">,</span> g <span style="color:#808030; ">+</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> u<span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>normal<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>cosp <span style="color:#808030; ">*</span> s<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span>
          Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">+</span> g <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> u<span style="color:#808030; ">,</span> g <span style="color:#808030; ">*</span> v<span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>g <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span>
              <span style="color:#808030; ">(</span>sinp <span style="color:#808030; ">*</span> s<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span>
          normal <span style="color:#808030; ">*</span> sqrtf<span style="color:#808030; ">(</span>c<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      origin <span style="color:#808030; ">=</span> sampledPosition <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.1</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
      attenuation <span style="color:#808030; ">=</span> attenuation <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.2</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>incidence <span style="color:#808030; ">&gt;</span> <span style="color:#008000; ">0.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">&amp;</span><span style="color:#808030; ">&amp;</span>
          RayMarching<span style="color:#808030; ">(</span>sampledPosition <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.1</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> lightDirection<span style="color:#808030; ">,</span>
                      sampledPosition<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span> <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_SUN<span style="color:#808030; ">)</span>
        color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> attenuation <span style="color:#808030; ">*</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">500</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">400</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">100</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> incidence<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_SUN<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">//</span>
      color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> attenuation <span style="color:#808030; ">*</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">50</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">80</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">100</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">break</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Sun Color</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> color<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>


__global__ <span style="color:#800000; font-weight:bold; ">void</span> GetColor<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">unsigned</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span>img<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">int</span> samplesCount<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span> blockIdx<span style="color:#808030; ">.</span>x<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> threadIdx<span style="color:#808030; ">.</span>x<span style="color:#800080; ">;</span>  

  curand_init<span style="color:#808030; ">(</span> blockIdx<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> threadIdx<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span> <span style="color:#808030; ">,</span> <span style="color:#808030; ">&amp;</span>states<span style="color:#808030; ">[</span>threadIdx<span style="color:#808030; ">.</span>x<span style="color:#808030; ">]</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">const</span> Vec position<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008000; ">22.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">5.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">25.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">const</span> Vec goal <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008000; ">3.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">4.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">0.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> position <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">const</span> Vec left <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span>goal<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>goal<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">/</span> w<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#696969; ">// Cross-product to get the up vector</span>
  <span style="color:#800000; font-weight:bold; ">const</span> Vec up<span style="color:#808030; ">(</span>goal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span>left<span style="color:#808030; ">.</span>z <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> goal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">*</span>left<span style="color:#808030; ">.</span>x <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span>
       goal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span>left<span style="color:#808030; ">.</span>y <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  Vec color<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> p <span style="color:#808030; ">=</span> samplesCount<span style="color:#800080; ">;</span> p<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> Trace<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> 
                          <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>goal <span style="color:#808030; ">+</span> left <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>x <span style="color:#808030; ">-</span> w <span style="color:#808030; ">/</span> <span style="color:#008000; ">2.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">+</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>y <span style="color:#808030; ">-</span> h <span style="color:#808030; ">/</span> <span style="color:#008000; ">2.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">+</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#696969; ">// Reinhard tone mapping</span>
  color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">/</span> samplesCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> <span style="color:#008000; ">14.0</span><span style="color:#006600; ">f</span> <span style="color:#808030; ">/</span> <span style="color:#008000; ">241.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
  Vec o <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> <span style="color:#008000; ">1.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
  color <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>color<span style="color:#808030; ">.</span>x <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> color<span style="color:#808030; ">.</span>y <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> color<span style="color:#808030; ">.</span>z <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">255.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
  img<span style="color:#808030; ">[</span><span style="color:#808030; ">(</span>y <span style="color:#808030; ">*</span> w <span style="color:#808030; ">+</span> x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">]</span>     <span style="color:#808030; ">=</span> color<span style="color:#808030; ">.</span>x<span style="color:#800080; ">;</span>
  img<span style="color:#808030; ">[</span><span style="color:#808030; ">(</span>y <span style="color:#808030; ">*</span> w <span style="color:#808030; ">+</span> x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#808030; ">.</span>y<span style="color:#800080; ">;</span>
  img<span style="color:#808030; ">[</span><span style="color:#808030; ">(</span>y <span style="color:#808030; ">*</span> w <span style="color:#808030; ">+</span> x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> BPP <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span>
  
<span style="color:#800080; ">}</span>

<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> gpuErrchk</span><span style="color:#808030; ">(</span><span style="color:#004a43; ">ans</span><span style="color:#808030; ">)</span><span style="color:#004a43; "> </span><span style="color:#808030; ">{</span><span style="color:#004a43; "> gpuAssert</span><span style="color:#808030; ">(</span><span style="color:#808030; ">(</span><span style="color:#004a43; ">ans</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span><span style="color:#004a43; "> __FILE__</span><span style="color:#808030; ">,</span><span style="color:#004a43; "> __LINE__</span><span style="color:#808030; ">)</span><span style="color:#808030; ">;</span><span style="color:#004a43; "> </span><span style="color:#808030; ">}</span>
<span style="color:#800000; font-weight:bold; ">inline</span> <span style="color:#800000; font-weight:bold; ">void</span> gpuAssert<span style="color:#808030; ">(</span>cudaError_t code<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">const</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span>file<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">int</span> line<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">bool</span> <span style="color:#603000; ">abort</span><span style="color:#808030; ">=</span><span style="color:#800000; font-weight:bold; ">true</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
   <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>code <span style="color:#808030; ">!</span><span style="color:#808030; ">=</span> cudaSuccess<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      <span style="color:#603000; ">fprintf</span><span style="color:#808030; ">(</span><span style="color:#603000; ">stderr</span><span style="color:#808030; ">,</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">GPUassert: </span><span style="color:#007997; ">%s</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%s</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%d</span><span style="color:#0f69ff; ">\n</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> cudaGetErrorString<span style="color:#808030; ">(</span>code<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> file<span style="color:#808030; ">,</span> line<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#603000; ">abort</span><span style="color:#808030; ">)</span> <span style="color:#603000; ">exit</span><span style="color:#808030; ">(</span>code<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
   <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span>

<span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#400000; ">main</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> argc<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span><span style="color:#808030; ">*</span>argv<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
<span style="color:#603000; ">DWORD</span> start_time <span style="color:#808030; ">=</span> <span style="color:#400000; ">GetTickCount</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">unsigned</span> <span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#808030; ">*</span>dev_bitmap<span style="color:#800080; ">;</span>
  cudaMalloc<span style="color:#808030; ">(</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span><span style="color:#808030; ">*</span><span style="color:#808030; ">)</span><span style="color:#808030; ">&amp;</span>dev_bitmap<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>w <span style="color:#808030; ">*</span> h <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  gpuErrchk<span style="color:#808030; ">(</span> cudaPeekAtLastError<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">int</span> samplesCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span> <span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">10</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>argc <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">1</span> <span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    samplesCount <span style="color:#808030; ">=</span> <span style="color:#603000; ">atoi</span><span style="color:#808030; ">(</span>argv<span style="color:#808030; ">[</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>  

  GetColor<span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span>w<span style="color:#808030; ">,</span>h<span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span><span style="color:#808030; ">(</span>dev_bitmap<span style="color:#808030; ">,</span> samplesCount<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> 
  gpuErrchk<span style="color:#808030; ">(</span> cudaDeviceSynchronize<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">*</span> bitmap <span style="color:#808030; ">=</span> <span style="color:#800000; font-weight:bold; ">new</span> <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">[</span>w <span style="color:#808030; ">*</span> h <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
  cudaMemcpy<span style="color:#808030; ">(</span> bitmap<span style="color:#808030; ">,</span> dev_bitmap<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span>w <span style="color:#808030; ">*</span> h <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> cudaMemcpyDeviceToHost <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  gpuErrchk<span style="color:#808030; ">(</span> cudaPeekAtLastError<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
 
  <span style="color:#603000; ">DWORD</span> elapsed_ms <span style="color:#808030; ">=</span> <span style="color:#400000; ">GetTickCount</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> start_time<span style="color:#800080; ">;</span>
  <span style="color:#603000; ">fprintf</span><span style="color:#808030; ">(</span><span style="color:#603000; ">stderr</span><span style="color:#808030; ">,</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">Time: </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; ">ms</span><span style="color:#0f69ff; ">\n</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> elapsed_ms<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

  <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">P6 </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; "> 255 </span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> w<span style="color:#808030; ">,</span> h<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">*</span> c <span style="color:#808030; ">=</span> bitmap<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> h<span style="color:#800080; ">;</span> y<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span> w<span style="color:#800080; ">;</span> x<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      c <span style="color:#808030; ">=</span> <span style="color:#808030; ">&amp;</span>bitmap<span style="color:#808030; ">[</span>y <span style="color:#808030; ">*</span> w <span style="color:#808030; ">*</span> BPP  <span style="color:#808030; ">+</span> x <span style="color:#808030; ">*</span> BPP<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
      <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> c<span style="color:#808030; ">[</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> c<span style="color:#808030; ">[</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> c<span style="color:#808030; ">[</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      c <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> BPP<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">delete</span> bitmap<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">return</span> EXIT_SUCCESS<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">// Andrew Kensler</span>
</pre>
