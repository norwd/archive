<a href="c.cpp" style="font-family: monospace;">Raw source</a>
<hr/> 



<pre style="color:#000000;background:#ffffff;"><span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdlib.h</span><span style="color:#800000; ">&gt;</span><span style="color:#004a43; "> </span><span style="color:#696969; ">// card &gt; pixar.ppm</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">stdio.h</span><span style="color:#800000; ">&gt;</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">math.h</span><span style="color:#800000; ">&gt;</span>

<span style="color:#800000; font-weight:bold; ">struct</span> Vec <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">float</span> x<span style="color:#808030; ">,</span> y<span style="color:#808030; ">,</span> z<span style="color:#800080; ">;</span>

    Vec<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> v <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> x <span style="color:#808030; ">=</span> y <span style="color:#808030; ">=</span> z <span style="color:#808030; ">=</span> v<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>

    Vec<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> a<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> b<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      x <span style="color:#808030; ">=</span> a<span style="color:#800080; ">;</span>
      y <span style="color:#808030; ">=</span> b<span style="color:#800080; ">;</span>
      z <span style="color:#808030; ">=</span> c<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>

    Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">+</span><span style="color:#808030; ">(</span>Vec r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> Vec<span style="color:#808030; ">(</span>x <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> y <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">+</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>

    Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">*</span><span style="color:#808030; ">(</span>Vec r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> Vec<span style="color:#808030; ">(</span>x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>

    <span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">%</span><span style="color:#808030; ">(</span>Vec r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> x <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span> z <span style="color:#808030; ">*</span> r<span style="color:#808030; ">.</span>z<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>

    <span style="color:#696969; ">// intnv square root</span>
    Vec <span style="color:#800000; font-weight:bold; ">operator</span><span style="color:#808030; ">!</span><span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">/</span> sqrtf<span style="color:#808030; ">(</span><span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span> <span style="color:#808030; ">%</span> <span style="color:#808030; ">*</span><span style="color:#800000; font-weight:bold; ">this</span><span style="color:#808030; ">)</span>
      <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>

<span style="color:#800000; font-weight:bold; ">float</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> l<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">float</span> r<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#800000; font-weight:bold; ">return</span> l <span style="color:#808030; ">&lt;</span> r <span style="color:#800080; ">?</span> l <span style="color:#800080; ">:</span> r<span style="color:#800080; ">;</span> <span style="color:#800080; ">}</span>

thread_local <span style="color:#800000; font-weight:bold; ">int</span> seed <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
<span style="color:#800000; font-weight:bold; ">float</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    seed <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span> <span style="color:#008c00; ">214013</span> <span style="color:#808030; ">*</span> seed <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2531011</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>seed <span style="color:#808030; ">&gt;</span><span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">16</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&amp;</span> <span style="color:#008000; ">0xFFFF</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">/</span> <span style="color:#008000; ">66635.0</span><span style="color:#006600; ">f</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">// Rectangle CSG equation. Returns minimum signed distance from</span>
<span style="color:#696969; ">// space carved by</span>
<span style="color:#696969; ">// lowerLeft vertex and opposite rectangle vertex upperRight.</span>
<span style="color:#800000; font-weight:bold; ">float</span> BoxTest<span style="color:#808030; ">(</span>Vec position<span style="color:#808030; ">,</span> Vec lowerLeft<span style="color:#808030; ">,</span> Vec upperRight<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  lowerLeft <span style="color:#808030; ">=</span> position <span style="color:#808030; ">+</span> lowerLeft <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  upperRight <span style="color:#808030; ">=</span> upperRight <span style="color:#808030; ">+</span> position <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>
          <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>
                  <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                  <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
          <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>lowerLeft<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> upperRight<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_NONE 0</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_LETTER 1</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_WALL 2</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> HIT_SUN 3</span>

<span style="color:#696969; ">// Sample the world using Signed Distance Fields.</span>
<span style="color:#800000; font-weight:bold; ">float</span> QueryDatabase<span style="color:#808030; ">(</span>Vec position<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#808030; ">&amp;</span>hitType<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">float</span> distance <span style="color:#808030; ">=</span> <span style="color:#008000; ">1e9</span><span style="color:#800080; ">;</span>
  Vec f <span style="color:#808030; ">=</span> position<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Flattened position (z=0)</span>
  f<span style="color:#808030; ">.</span>z <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">char</span> letters<span style="color:#808030; ">[</span><span style="color:#008c00; ">15</span><span style="color:#808030; ">*</span><span style="color:#008c00; ">4</span><span style="color:#808030; ">+</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span>               <span style="color:#696969; ">// 15 two points lines</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5O5_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5W9W</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">5_9_</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// P (without curve)</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">AOEO</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">COC_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">A_E_</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// I</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">IOQ_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">I_QO</span><span style="color:#800000; ">"</span>                <span style="color:#696969; ">// X</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">UOY_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">Y_]O</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">WW[W</span><span style="color:#800000; ">"</span>         <span style="color:#696969; ">// A</span>
          <span style="color:#800000; ">"</span><span style="color:#0000e6; ">aOa_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">aWeW</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">a_e_</span><span style="color:#800000; ">"</span> <span style="color:#800000; ">"</span><span style="color:#0000e6; ">cWiO</span><span style="color:#800000; ">"</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// R (without curve)</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">&lt;</span> <span style="color:#800000; font-weight:bold; ">sizeof</span><span style="color:#808030; ">(</span>letters<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> i <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec begin <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>letters<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">,</span> letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span><span style="color:#800080; ">;</span>
    Vec e <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">,</span> letters<span style="color:#808030; ">[</span>i <span style="color:#808030; ">+</span> <span style="color:#008c00; ">3</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">79</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008000; ">.5</span> <span style="color:#808030; ">+</span> begin <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    Vec o <span style="color:#808030; ">=</span> f <span style="color:#808030; ">+</span> <span style="color:#808030; ">(</span>begin <span style="color:#808030; ">+</span> e <span style="color:#808030; ">*</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>begin <span style="color:#808030; ">+</span> f <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">%</span> e <span style="color:#808030; ">/</span> <span style="color:#808030; ">(</span>e <span style="color:#808030; ">%</span> e<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                                      <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                                 <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span>
                <span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    distance <span style="color:#808030; ">=</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// compare squared distance.</span>
  <span style="color:#800080; ">}</span>
  distance <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Get real distance, not square distance.</span>

  <span style="color:#696969; ">// Two curves (for P and R in PixaR) with hard-coded locations.</span>
  Vec curves<span style="color:#808030; ">[</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> <span style="color:#800080; ">{</span>Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">11</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">11</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">6</span><span style="color:#808030; ">)</span><span style="color:#800080; ">}</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> i <span style="color:#808030; ">=</span> <span style="color:#008c00; ">2</span><span style="color:#800080; ">;</span> i<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    Vec o <span style="color:#808030; ">=</span> f <span style="color:#808030; ">+</span> curves<span style="color:#808030; ">[</span>i<span style="color:#808030; ">]</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
    distance <span style="color:#808030; ">=</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span>
                   o<span style="color:#808030; ">.</span>x <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> fabsf<span style="color:#808030; ">(</span>sqrtf<span style="color:#808030; ">(</span>o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span>
                           <span style="color:#800080; ">:</span> <span style="color:#808030; ">(</span>o<span style="color:#808030; ">.</span>y <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> o<span style="color:#808030; ">.</span>y <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span> <span style="color:#800080; ">:</span> <span style="color:#008c00; ">2</span><span style="color:#808030; ">,</span> sqrtf<span style="color:#808030; ">(</span>o <span style="color:#808030; ">%</span> o<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span>
               <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>
  distance <span style="color:#808030; ">=</span> powf<span style="color:#808030; ">(</span>powf<span style="color:#808030; ">(</span>distance<span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> powf<span style="color:#808030; ">(</span>position<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.125</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> <span style="color:#008000; ">.5</span><span style="color:#800080; ">;</span>
  hitType <span style="color:#808030; ">=</span> HIT_LETTER<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">float</span> roomDist <span style="color:#800080; ">;</span>
  roomDist <span style="color:#808030; ">=</span> <span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#696969; ">// min(A,B) = Union with Constructive solid geometry</span>
               <span style="color:#696969; ">//-min carves an empty space</span>
                <span style="color:#808030; ">-</span><span style="color:#603000; ">min</span><span style="color:#808030; ">(</span><span style="color:#696969; ">// Lower room</span>
                     BoxTest<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008000; ">.5</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">30</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">18</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">30</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                     <span style="color:#696969; ">// Upper room</span>
                     BoxTest<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">17</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">20</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span>
                <span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                BoxTest<span style="color:#808030; ">(</span> <span style="color:#696969; ">// Ceiling "planks" spaced 8 units apart.</span>
                  Vec<span style="color:#808030; ">(</span>fmodf<span style="color:#808030; ">(</span>fabsf<span style="color:#808030; ">(</span>position<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">8</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                      position<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span>
                      position<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                  Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">1.5</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">18.5</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span>
                  Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">6.5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">20</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span>
                <span style="color:#808030; ">)</span>
  <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>roomDist <span style="color:#808030; ">&lt;</span> distance<span style="color:#808030; ">)</span> distance <span style="color:#808030; ">=</span> roomDist<span style="color:#808030; ">,</span> hitType <span style="color:#808030; ">=</span> HIT_WALL<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">float</span> sun <span style="color:#808030; ">=</span> <span style="color:#008000; ">19.9</span> <span style="color:#808030; ">-</span> position<span style="color:#808030; ">.</span>y <span style="color:#800080; ">;</span> <span style="color:#696969; ">// Everything above 19.9 is light source.</span>
  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>sun <span style="color:#808030; ">&lt;</span> distance<span style="color:#808030; ">)</span>distance <span style="color:#808030; ">=</span> sun<span style="color:#808030; ">,</span> hitType <span style="color:#808030; ">=</span> HIT_SUN<span style="color:#800080; ">;</span>

  <span style="color:#800000; font-weight:bold; ">return</span> distance<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">// Perform signed sphere marching</span>
<span style="color:#696969; ">// Returns hitType 0, 1, 2, or 3 and update hit position/normal</span>
<span style="color:#800000; font-weight:bold; ">int</span> RayMarching<span style="color:#808030; ">(</span>Vec origin<span style="color:#808030; ">,</span> Vec direction<span style="color:#808030; ">,</span> Vec <span style="color:#808030; ">&amp;</span>hitPos<span style="color:#808030; ">,</span> Vec <span style="color:#808030; ">&amp;</span>hitNorm<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">int</span> hitType <span style="color:#808030; ">=</span> HIT_NONE<span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">int</span> noHitCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">float</span> d<span style="color:#800080; ">;</span> <span style="color:#696969; ">// distance from closest object in world.</span>

  <span style="color:#696969; ">// Signed distance marching</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">float</span> total_d<span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> total_d <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">100</span><span style="color:#800080; ">;</span> total_d <span style="color:#808030; ">+</span><span style="color:#808030; ">=</span> d<span style="color:#808030; ">)</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span><span style="color:#808030; ">(</span>d <span style="color:#808030; ">=</span> QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">=</span> origin <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> total_d<span style="color:#808030; ">,</span> hitType<span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">&lt;</span> <span style="color:#008000; ">.01</span>
            <span style="color:#808030; ">|</span><span style="color:#808030; ">|</span> <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span>noHitCount <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">99</span><span style="color:#808030; ">)</span>
      <span style="color:#800000; font-weight:bold; ">return</span> hitNorm <span style="color:#808030; ">=</span>
         <span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span>QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">.01</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">,</span>
              QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">,</span>
              QueryDatabase<span style="color:#808030; ">(</span>hitPos <span style="color:#808030; ">+</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.01</span><span style="color:#808030; ">)</span><span style="color:#808030; ">,</span> noHitCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">-</span> d<span style="color:#808030; ">)</span>
         <span style="color:#808030; ">,</span> hitType<span style="color:#800080; ">;</span> <span style="color:#696969; ">// Weird return statement where a variable is also updated.</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

Vec Trace<span style="color:#808030; ">(</span>Vec origin<span style="color:#808030; ">,</span> Vec direction<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  Vec sampledPosition<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">,</span> color<span style="color:#808030; ">,</span> attenuation <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
  Vec lightDirection<span style="color:#808030; ">(</span><span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span><span style="color:#008000; ">.6</span><span style="color:#808030; ">,</span> <span style="color:#008000; ">.6</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Directional light</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> bounceCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">3</span><span style="color:#800080; ">;</span> bounceCount<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">int</span> hitType <span style="color:#808030; ">=</span> RayMarching<span style="color:#808030; ">(</span>origin<span style="color:#808030; ">,</span> direction<span style="color:#808030; ">,</span> sampledPosition<span style="color:#808030; ">,</span> normal<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_NONE<span style="color:#808030; ">)</span> <span style="color:#800000; font-weight:bold; ">break</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// No hit. This is over, return color.</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_LETTER<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">// Specular bounce on a letter. No color acc.</span>
      direction <span style="color:#808030; ">=</span> direction <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span> normal <span style="color:#808030; ">%</span> direction <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">2</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      origin <span style="color:#808030; ">=</span> sampledPosition <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.1</span><span style="color:#800080; ">;</span>
      attenuation <span style="color:#808030; ">=</span> attenuation <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.2</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Attenuation via distance traveled.</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_WALL<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">// Wall hit uses color yellow?</span>
      <span style="color:#800000; font-weight:bold; ">float</span> incidence <span style="color:#808030; ">=</span> normal <span style="color:#808030; ">%</span> lightDirection<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> p <span style="color:#808030; ">=</span> <span style="color:#008000; ">6.283185</span> <span style="color:#808030; ">*</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> c <span style="color:#808030; ">=</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> s <span style="color:#808030; ">=</span> sqrtf<span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">-</span> c<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> g <span style="color:#808030; ">=</span> normal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">?</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#800080; ">:</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> u <span style="color:#808030; ">=</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">/</span> <span style="color:#808030; ">(</span>g <span style="color:#808030; ">+</span> normal<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">float</span> v <span style="color:#808030; ">=</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> u<span style="color:#800080; ">;</span>
      direction <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>v<span style="color:#808030; ">,</span>
                      g <span style="color:#808030; ">+</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> u<span style="color:#808030; ">,</span>
                      <span style="color:#808030; ">-</span>normal<span style="color:#808030; ">.</span>y<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>cosf<span style="color:#808030; ">(</span>p<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> s<span style="color:#808030; ">)</span>
                  <span style="color:#808030; ">+</span>
                  Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span> <span style="color:#808030; ">+</span> g <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> u<span style="color:#808030; ">,</span>
                      g <span style="color:#808030; ">*</span> v<span style="color:#808030; ">,</span>
                      <span style="color:#808030; ">-</span>g <span style="color:#808030; ">*</span> normal<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>sinf<span style="color:#808030; ">(</span>p<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> s<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> sqrtf<span style="color:#808030; ">(</span>c<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      origin <span style="color:#808030; ">=</span> sampledPosition <span style="color:#808030; ">+</span> direction <span style="color:#808030; ">*</span> <span style="color:#008000; ">.1</span><span style="color:#800080; ">;</span>
      attenuation <span style="color:#808030; ">=</span> attenuation <span style="color:#808030; ">*</span> <span style="color:#008000; ">0.2</span><span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>incidence <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">0</span> <span style="color:#808030; ">&amp;</span><span style="color:#808030; ">&amp;</span>
          RayMarching<span style="color:#808030; ">(</span>sampledPosition <span style="color:#808030; ">+</span> normal <span style="color:#808030; ">*</span> <span style="color:#008000; ">.1</span><span style="color:#808030; ">,</span>
                      lightDirection<span style="color:#808030; ">,</span>
                      sampledPosition<span style="color:#808030; ">,</span>
                      normal<span style="color:#808030; ">)</span> <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_SUN<span style="color:#808030; ">)</span>
        color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> attenuation <span style="color:#808030; ">*</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">500</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">400</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">100</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> incidence<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>hitType <span style="color:#808030; ">=</span><span style="color:#808030; ">=</span> HIT_SUN<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> <span style="color:#696969; ">//</span>
      color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> attenuation <span style="color:#808030; ">*</span> Vec<span style="color:#808030; ">(</span><span style="color:#008c00; ">50</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">80</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">100</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span> <span style="color:#800000; font-weight:bold; ">break</span><span style="color:#800080; ">;</span> <span style="color:#696969; ">// Sun Color</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> color<span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#800000; font-weight:bold; ">const</span> <span style="color:#800000; font-weight:bold; ">int</span> w <span style="color:#808030; ">=</span> <span style="color:#008c00; ">960</span><span style="color:#800080; ">;</span>
<span style="color:#800000; font-weight:bold; ">const</span> <span style="color:#800000; font-weight:bold; ">int</span> h <span style="color:#808030; ">=</span> <span style="color:#008c00; ">540</span><span style="color:#800080; ">;</span>
<span style="color:#800000; font-weight:bold; ">int</span> samplesCount <span style="color:#808030; ">=</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
Vec position<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">22</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">5</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">25</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
Vec goal <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>Vec<span style="color:#808030; ">(</span><span style="color:#808030; ">-</span><span style="color:#008c00; ">3</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> position <span style="color:#808030; ">*</span> <span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
Vec left <span style="color:#808030; ">=</span> <span style="color:#808030; ">!</span>Vec<span style="color:#808030; ">(</span>goal<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span> <span style="color:#008c00; ">0</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">-</span>goal<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">.</span> <span style="color:#808030; ">/</span> w<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

<span style="color:#696969; ">// Cross-product to get the up vector</span>
Vec up<span style="color:#808030; ">(</span>goal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>z <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span>
      goal<span style="color:#808030; ">.</span>z <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>x <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>z<span style="color:#808030; ">,</span>
      goal<span style="color:#808030; ">.</span>x <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>y <span style="color:#808030; ">-</span> goal<span style="color:#808030; ">.</span>y <span style="color:#808030; ">*</span> left<span style="color:#808030; ">.</span>x<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">include </span><span style="color:#800000; ">&lt;</span><span style="color:#40015a; ">pthread.h</span><span style="color:#800000; ">&gt;</span>
pthread_t threadIds<span style="color:#808030; ">[</span>h<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>
Vec img<span style="color:#808030; ">[</span>w<span style="color:#808030; ">*</span>h<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>

<span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span> plotPixel<span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span> <span style="color:#400000; ">arg</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">(</span><span style="color:#603000; ">size_t</span><span style="color:#808030; ">)</span><span style="color:#400000; ">arg</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">for</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x<span style="color:#808030; ">=</span>w<span style="color:#800080; ">;</span> x<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>

      Vec color<span style="color:#800080; ">;</span>
      <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> p <span style="color:#808030; ">=</span> samplesCount<span style="color:#800080; ">;</span> p<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span>
        color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> Trace<span style="color:#808030; ">(</span>position<span style="color:#808030; ">,</span> <span style="color:#808030; ">!</span><span style="color:#808030; ">(</span>goal <span style="color:#808030; ">+</span> left <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>x <span style="color:#808030; ">-</span> w <span style="color:#808030; ">/</span> <span style="color:#008c00; ">2</span> <span style="color:#808030; ">+</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> up <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span>y <span style="color:#808030; ">-</span> h <span style="color:#808030; ">/</span> <span style="color:#008c00; ">2</span> <span style="color:#808030; ">+</span> randomVal<span style="color:#808030; ">(</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>

      <span style="color:#696969; ">// Reinhard tone mapping</span>
      color <span style="color:#808030; ">=</span> color <span style="color:#808030; ">*</span> <span style="color:#808030; ">(</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">.</span> <span style="color:#808030; ">/</span> samplesCount<span style="color:#808030; ">)</span> <span style="color:#808030; ">+</span> <span style="color:#008c00; ">14</span><span style="color:#808030; ">.</span> <span style="color:#808030; ">/</span> <span style="color:#008c00; ">241</span><span style="color:#800080; ">;</span>
      Vec o <span style="color:#808030; ">=</span> color <span style="color:#808030; ">+</span> <span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span>
      color <span style="color:#808030; ">=</span> Vec<span style="color:#808030; ">(</span>color<span style="color:#808030; ">.</span>x <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>x<span style="color:#808030; ">,</span> color<span style="color:#808030; ">.</span>y <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>y<span style="color:#808030; ">,</span> color<span style="color:#808030; ">.</span>z <span style="color:#808030; ">/</span> o<span style="color:#808030; ">.</span>z<span style="color:#808030; ">)</span> <span style="color:#808030; ">*</span> <span style="color:#008c00; ">255</span><span style="color:#800080; ">;</span>

      img<span style="color:#808030; ">[</span>y <span style="color:#808030; ">*</span> w <span style="color:#808030; ">+</span> x<span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> color<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
    <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#7d0045; ">NULL</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#800000; font-weight:bold; ">int</span> <span style="color:#400000; ">main</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> argc<span style="color:#808030; ">,</span> <span style="color:#800000; font-weight:bold; ">char</span><span style="color:#808030; ">*</span><span style="color:#808030; ">*</span> argv<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>

  <span style="color:#800000; font-weight:bold; ">if</span> <span style="color:#808030; ">(</span>argc <span style="color:#808030; ">&gt;</span> <span style="color:#008c00; ">1</span> <span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    samplesCount <span style="color:#808030; ">=</span> <span style="color:#603000; ">atoi</span><span style="color:#808030; ">(</span>argv<span style="color:#808030; ">[</span><span style="color:#008c00; ">1</span><span style="color:#808030; ">]</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>    

  <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#0000e6; ">P6 </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; "> </span><span style="color:#007997; ">%d</span><span style="color:#0000e6; "> 255 </span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> w<span style="color:#808030; ">,</span> h<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> h<span style="color:#800080; ">;</span> y<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#800080; ">;</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span> 
  pthread_create<span style="color:#808030; ">(</span><span style="color:#808030; ">&amp;</span>threadIds<span style="color:#808030; ">[</span>y<span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> <span style="color:#7d0045; ">NULL</span><span style="color:#808030; ">,</span> plotPixel<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">void</span><span style="color:#808030; ">*</span><span style="color:#808030; ">)</span>y<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> y<span style="color:#808030; ">&lt;</span>h<span style="color:#800080; ">;</span>y<span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    pthread_join<span style="color:#808030; ">(</span>threadIds<span style="color:#808030; ">[</span>y<span style="color:#808030; ">]</span><span style="color:#808030; ">,</span> <span style="color:#7d0045; ">NULL</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  <span style="color:#800080; ">}</span>

  <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span> h<span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span> y <span style="color:#808030; ">&gt;</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span> <span style="color:#800080; ">;</span> y<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">for</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span> w<span style="color:#808030; ">-</span><span style="color:#008c00; ">1</span><span style="color:#800080; ">;</span> x <span style="color:#808030; ">&gt;</span><span style="color:#808030; ">=</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> x<span style="color:#808030; ">-</span><span style="color:#808030; ">-</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
       Vec<span style="color:#808030; ">*</span> p<span style="color:#800080; ">;</span>
       p <span style="color:#808030; ">=</span> <span style="color:#808030; ">&amp;</span>img<span style="color:#808030; ">[</span>w <span style="color:#808030; ">*</span> y <span style="color:#808030; ">+</span> x<span style="color:#808030; ">]</span><span style="color:#800080; ">;</span>  
       <span style="color:#603000; ">printf</span><span style="color:#808030; ">(</span><span style="color:#800000; ">"</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#007997; ">%c</span><span style="color:#800000; ">"</span><span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span>p<span style="color:#808030; ">-</span><span style="color:#808030; ">&gt;</span>x<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span>p<span style="color:#808030; ">-</span><span style="color:#808030; ">&gt;</span>y<span style="color:#808030; ">,</span> <span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span><span style="color:#808030; ">)</span>p<span style="color:#808030; ">-</span><span style="color:#808030; ">&gt;</span>z<span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>                
  <span style="color:#800080; ">}</span>
  <span style="color:#800000; font-weight:bold; ">return</span> <span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>

<span style="color:#696969; ">// Andrew Kensler</span>
</pre>
