<html>
<head>
  <link rel="alternate" type="application/rss+xml"  title="RSS Feed for fabiensanglard.net" href="../rss.xml" />
  <style type="text/css">

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono.woff2');
      font-display: block;
    }

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono-Bold.woff2');
      font-weight: bold;
      font-display: block;
    }

    * {
       font-size: 16px;
    }

    html {
      font-family: fabfont,  monospace;
      max-width: 900px;  /* For Desktop PC (see @media for Tablets/Phones) */
      padding-left: 2%;
      padding-right: 3%;
      margin: 0 auto;
      background: #F5F5F0;
  	} 
    


  	a {
      color: black;
      font-weight: bold;
    }

    img {
      border: none; 
    }

    p {
      margin-top: 0px;
      text-align: justify;
    }
    sup {
      vertical-align: 0.3em;
      font-size: 0.65em;
    }   

    pre {
      font-family: fabfont, monospace;
      background-color: white; 
      border: 1px solid Black; 
      padding-left: 2%;
      padding-top: 1ch;
      padding-bottom: 1ch;
      /* Only take care of X overflow since this is the only part that can be too wide.
         The Y axis will never overflow.
      */
      overflow: hidden;
    }

    div.heading {
      font-weight: bold;      
      text-transform: uppercase;
      margin-top: 4ch;
    }

    /** {
      font-size: 16px;
    }*/
    @media (max-width: 500px) { /* For small screen decices */
      * {
        font-size: 12px; 
      }
    }   
    .title {
      text-decoration: none;
    }

    img.pixel, canvas.pixel {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

  code {
    /*font-size: 110%;*/
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
  }

  .trivia {
    border-left: 1px black solid;
    padding-left: 1ch;
  }

  .trivia::before {
  font-weight: bold;
  text-decoration: underline;
  padding-right: 1ch;
  content: "Trivia:";

  </style>
  <title>The polygons of Another World: IBM PC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=12.0, minimum-scale=1.0, user-scalable=yes">
</head>  
  <body><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="../index.html" class="title"><b>FABIEN SANGLARD'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<!-- <a class="title" href="/about/index.html">ABOUT</a> &nbsp;<a class="title" href="/contact/index.html">EMAIL</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">DONATE</a></div></div> -->
<a class="title" href="../about/index.html">ABOUT</a> &nbsp;<a class="title" href="../contact/index.html">CONTACT</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">GIVE</a></div></div>

</center><br><br>
<div style="margin-bottom: 2ch;text-transform: none;">
January 4, 2020</div>
<div class='heading'>The polygons of Another World: IBM PC</div><hr/>
<p>
  This article is part of a study about the ports of Another World. It is highly recommended to read <a href="../another_world_polygons/index.html">Another World 101</a> before reading this.
</p>    




<div class='heading'>THE IBM PC</div><hr/><p> 
     
<img loading="lazy" src="IBM_logo.svg" width="1000" height="400" style="width: 40%; height: auto; float:right;margin-bottom: 1ch; margin-left: 2ch;"/>    
    For three decades, IBM had been comfortable dominating the mainframe market. When 1979 saw sales of micro-computers reach $150 million, the "Colossus of Armonk" decided to release one of its own. With several competitors such as Hewlett-Packard (HP), Texas Instruments (TI), Tandy, and Data General already established, IBM did things differently in order to stand out.

    <br/><br/>
    Instead of proceeding vertically as they had done by the past, with most components and software developed in-house, IBM built its micro-computer horizontally. They purchased elements such as the CPU from Intel and shipped with a PC DOS 1.0 operating system from Microsoft.

<br/><br/>
     They took the approach even further by making available specs and schematics of the machine. For consumers used to wrestle with manufacturers for technical details, it was a whole new world.
<blockquote style="padding-top: 2ch; padding-bottom: 2ch; margin-bottom: 2ch;">
 The US$36 IBM PC Technical Reference Manual included complete circuit schematics, commented ROM BIOS source code, and other engineering and programming information for all of IBM's PC-related hardware, plus instructions on designing third-party peripherals.<br/>
 <br/>
<div>- Wikipedia (IBM_Personal_Computer#History)</div>

</blockquote>
<p>
The first IBM Personal Computer was released on August 12, 1981 with the introduction of the 5150. It ran on an Intel 8088 (4.77MHz) with 16KiB RAM and an MDA graphic card which could only display text. It was a smashing success with 40,000 units ordered on the day of the announcement. For a while IBM remained the sole vendor of what was called "the PC". 
    <br/><br/>
When the popularity of IBM PCs crossed a threshold, the openness that had contributed to success became a liability. In March 1983 Compaq introduced an "IBM PC compatible" called the "Compaq Portable". Soon after the PC market was flooded with PC clones. IBM attempted to fork into a new standard using a copyrighted MCA bus. When this effort failed, IBM effectively lost control and quickly gained an overpriced reputation.<br/>


<picture>
  <source srcset="pc1.webp" type="image/webp">
  <img loading="lazy" src="pc1.png" width="1082" height="928" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/></picture>
<span style="text-align: center; display: block; margin-bottom: 2ch;"><i>The "overpriced" 1991 PS/1. Notice the huge Disney Sound Source extender.</i></span>
</p>    

<div class='heading'>Architecture</div><hr/><p>
   IBM's PCs were built around the concept of "big iron" with a monstrous CPU, a lot of RAM, and anything else a customer wanted to buy as an add-on card. In 1991 these add-on included the graphic card which could be anything from TGA, EGA, up to the latest VGA. The same went for the audio part with no less than four types of incompatible outputs (Beeper, AdLib, SoundBlaster, and Disney Sound Source).

   <br/><br/>
   To release a software for an "IBM PC or Compatible", developers could only display a list of "minimum requirements" and "recommended configuration" on the game box. The supported CPU, RAM, graphics adapter and audio cards were all listed there.
   <br/><br/>
A "typical" 1991 PC would have been something based on an Intel 386 CPU running at 16Mhz with 2MiB of RAM and an AdLib audio card. Like in the Atari ST, there was a DMA controller which could not be used to Blit since it was dedicated to floppy/HDD data transfer.<br/>
<img loading="lazy" src="pc_arch.svg" width="210.91072mm" height="64.100334mm" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small></small></i></span>
  
</p>


<div class='heading'>Video Systems</div><hr/><p>    
  From the first PC in 1981 to 1991, five major graphic standard were released. MDA and CGA were mostly extinct but there was still a large base of old TGA/EGA which had not upgraded yet to VGA.
<pre>
    Acronym             Full Name                   Release Year
    --------------------------------------------------------------
      MDA       Monochrome Display Adapter              1981
      CGA       Color Graphics Adapter                  1981
      TGA       Tandy Graphics Adapter                  1984
      EGA       Enhanced Graphics Adapter               1985
      VGA       Video Graphics Array                    1987
</pre>
<p>


   The older generations TGA/EGA used an abysmal 2-bit channel (6 bits/color) color system.<br/>
    <br/>
    <br/>
   <table style="margin-bottom: 2ch;margin-top: 2ch; width: 100%; height: auto;">
  <tr>
    <td style="width: 50%;text-align: left;">
     <picture>
       <source srcset="clear_2bit.webp" type="image/webp">
       <img loading="lazy" src="clear_2bit.png" width="800" height="941" style="width: 90%; height: auto; "/>     </picture>
 </td>
    <td style="width: 50%; text-align: right;">
    <picture>
        <source srcset="dark_2bit.webp" type="image/webp">
        <img loading="lazy" src="dark_2bit.png" width="600" height="706" style="width: 90%; height: auto; "/>    </picture>
      </td>
</tr>
</table>
<span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>2-bit per pixel color space of TGA/EGA</small></i></span><br/>

    The latest VGA generation used a much more impressive 6-bit channel (18 bits/pixel) system.<br/>
   <table style="margin-bottom: 2ch;margin-top: 2ch; width: 100%; height: auto;">
  <tr>
    <td style="width: 50%;text-align: left;">
 <picture>
        <source srcset="clear_6bit.webp" type="image/webp">
       <img loading="lazy" src="clear_6bit.png" width="800" height="941" style="width: 90%; height: auto; "/>    </picture>
 </td>
    <td style="width: 50%; text-align: right;">
    <picture>
        <source srcset="dark_6bit.webp" type="image/webp">
       <img loading="lazy" src="dark_6bit.png" width="1200" height="1412" style="width: 90%; height: auto; "/>    </picture>
      </td>
</tr>
</table>
<span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>The 18-bit color space of VGA</small></i></span>

<p>  
Configuring these cards was a mess of 300 registers all interacting together. Thankfully the PC BIOS provided a routine to configure everything. At the time, depending on the graphic card, 19 modes were available.
</p>

<pre>
Mode        Type        Resolution     Colors        RAM/VRAM Mapping     VRAM (KiB)
--------------------------------------------------------------------------------------
0h,1h        MDA         360 x 400          16            B8000              16
2h,3h        MDA         720 x 400          16            B8000              16
4h,5h        CGA         320 x 200           4            B8000              16
6h           CGA         640 x 200           2            B8000              16
7h           MDA         720 x 400           2            B0000              16
8h           TGA         160 x 200                        B0000              64
<span style="color:red;">9h           TGA         320 x 200          16            B0000              64</span>
Ah           TGA         640 x 200          16            B0000              64
Bh           ---         ---------          --            -----              --
Ch           ---         ---------          --            -----              --
<span style="color:red;">Dh           EGA         320 x 200          16            A0000             128</span>
Eh           EGA         640 x 200          16            A0000             128
Fh           EGA         640 x 350           2            A0000             128
10h          EGA         640 x 350          16            A0000             128
11h          VGA         640 x 480           2            A0000             256
12h          VGA         640 x 480          16            A0000             256 
<span style="color:red;">13h          VGA         320 x 200         256            A0000             256</span>
</pre>
<p>
Notice the  three 320x200 modes with at least 16 colors which match Another World VM requirements. As we will see this is not quite what ended up being used.


<div class='heading'>Tandy Graphics Adapter </div><hr/><p>
<img loading="lazy" src="9h_bitplanes.svg" width="134.20277mm" height="95.397217mm" style="width: 40%; height: auto; float:right;margin-bottom: 1ch; margin-left: 2ch;border: 1px black solid;"/>  Surprisingly, the graphics mode labeled TGA were not introduced by Tandy Corporation but by IBM. When the big iron company released its 1984 "PCjr" aimed at the Apple II/Commodore 64 market they took the opportunity to improve on their aging CGA.  Later that year, Tandy Corporation released the "Tandy 1000" at a lower cost with easier expandability, and wider PC compatibility. If at first Tandy "embraced" IBM's graphic sub-system, better sales enabled them to "improve"<a name="back_1" style="text-decoration: none;" href="index.html#footnote_1"><sup>[1]</sup></a> and ultimately "extinguish" the PCjr name.

  <br/><br/>
  Each version of the MDA/CGA/EGA/VGA was backward compatible but the TGA has three exclusive modes named 8h, 9h, and Ah. The most interesting one for Another World is of course the 9h 320x200 16 colors. This mode was only available with a special 128 KiB VRAM (8x16KiB) extension since it is a "high bandwidth modes" requiring four-way interleaved memory<a name="back_2" style="text-decoration: none;" href="index.html#footnote_2"><sup>[2]</sup></a>.

  <br/><br/>The graphic layout of mode 9h is very much like the Atari ST we reviewed in the last article.

<br/><br/>
   The framebuffers are hosted in RAM since these machines had no VRAM. Pixel are laid out linearly as nibbles (half-byte) encoding 4-bit color indexes<a name="back_3" style="text-decoration: none;" href="index.html#footnote_3"><sup>[3]</sup></a>.
</p>






<div class='heading'>Enhanced Graphics Adapter / Video Graphics Array</div><hr/><p style="margin-bottom: 1ch;">
<img loading="lazy" src="Dh_bitplanes.svg" width="134.20277mm" height="95.397217mm" style="width: 40%; height: auto; float:right;margin-bottom: 1ch; margin-left: 2ch;border: 1px black solid;"/>The EGA and VGA are very similar. They can both be setup to 320x200 in 16 colors mode via mode 9h. There is VRAM here which is accessed directly by the CPU via a 64 KiB memory mapped RAM window.

<br/><br/> The framebuffer is organized like the Amiga we studied in the first article except that each bitplane is in a dedicated memory bank. There are four banks and. In mode 9h a bit from each four bank is combined into a nibble which result in a 4-bits color index.
  <br/><br/>
  VGA cards have a lot more VRAM (256KiB as 4x64KiB) than EGA cards (128KiB as 4x32KiB) which is irrelevant for Another World. VGA has deeper colors (6-bit/channel vs 2-bit/channel) which is very relevant.<br/>

<img loading="lazy" src="vga_mapping.svg" width="944.56488" height="377.10767" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 1ch;"><i><small>EGA/VGA 64 KiB memory mapping into VRAM banks</small></i></span> 

<div class='heading'>Deceivingly powerful</div><hr/><p style="margin-bottom: 1ch;">
  In terms of processing power a PC was far superior to the Amiga and Atari ST we visited last times. The problem for gaming was the video which was extremely slow.
  <br/><br/>
The memory mapped system was never designed for animation. It was designed with spreadsheet and word processing in mind. Pushing all these pixels over the bus took a long time. Moreover, working with bitplane was cumbersome, especially without a co-processor like the Amiga's Blitter. Take the example of a simple routine to clear the screen in mode 9h.<br/><br/>
 <pre style="color:#000000;background:#ffffff; margin-top: 1ch;"><span style="color:#800000; font-weight:bold; ">char</span> <span style="color:#800000; font-weight:bold; ">far</span> <span style="color:#808030; ">*</span> VGA <span style="color:#808030; ">=</span> <span style="color:#808030; ">(</span> byte <span style="color:#800000; font-weight:bold; ">far</span> <span style="color:#808030; ">*</span><span style="color:#808030; ">)</span> 0xA0000000L <span style="color:#800080; ">;</span>  
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> SC_MAPMASK  0x02</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> SC_INDEX    0x03c4</span>
<span style="color:#004a43; ">#</span><span style="color:#004a43; ">define</span><span style="color:#004a43; "> SC_DATA     0x03c5</span>

<span style="color:#800000; font-weight:bold; ">void</span> selectBank<span style="color:#808030; ">(</span>uint_8 bank<span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
  outp<span style="color:#808030; ">(</span>SC_INDEX <span style="color:#808030; ">,</span> SC_MAPMASK <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
  outp<span style="color:#808030; ">(</span>SC_DATA <span style="color:#808030; ">,</span> <span style="color:#008c00; ">1</span> <span style="color:#808030; ">&lt;</span><span style="color:#808030; ">&lt;</span> bank <span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
<span style="color:#800080; ">}</span>  

<span style="color:#800000; font-weight:bold; ">void</span> ClearScreen<span style="color:#808030; ">()</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">for</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span> <span style="color:#800080; ">;</span> y <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">200</span> <span style="color:#800080; ">;</span> y <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    <span style="color:#800000; font-weight:bold; ">for</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> x <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">160</span> <span style="color:#800080; ">;</span> x <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      selectBank<span style="color:#808030; ">(</span>x <span style="color:#808030; ">%</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
      VGA<span style="color:#808030; ">[</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> <span style="color:#008c00; ">200</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> 0<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span>
</pre>

<p style="margin-bottom: 1ch;">
Even on the best PC of 1991 this code sample could not go past 5fps<a name="back_4" style="text-decoration: none;" href="index.html#footnote_4"><sup>[4]</sup></a>. This is a pathologic example since the screen is cleared left to right. However even when clearing vertically to avoid bank switching, this code would still only run at 10fps<a name="back_5" style="text-decoration: none;" href="index.html#footnote_5"><sup>[5]</sup></a>.

<pre style="color:#000000;background:#ffffff;"><span style="color:#800000; font-weight:bold; ">void</span> ClearScreen<span style="color:#808030; ">()</span> <span style="color:#800080; ">{</span>
  <span style="color:#800000; font-weight:bold; ">for</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> x <span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span><span style="color:#800080; ">;</span> x <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">160</span> <span style="color:#800080; ">;</span> x <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
    selectBank <span style="color:#808030; ">(</span>x <span style="color:#808030; ">%</span> <span style="color:#008c00; ">4</span><span style="color:#808030; ">)</span><span style="color:#800080; ">;</span>
    <span style="color:#800000; font-weight:bold; ">for</span><span style="color:#808030; ">(</span><span style="color:#800000; font-weight:bold; ">int</span> y <span style="color:#808030; ">=</span><span style="color:#008c00; ">0</span> <span style="color:#800080; ">;</span> y <span style="color:#808030; ">&lt;</span> <span style="color:#008c00; ">200</span> <span style="color:#800080; ">;</span> y <span style="color:#808030; ">+</span><span style="color:#808030; ">+</span><span style="color:#808030; ">)</span> <span style="color:#800080; ">{</span>
      VGA<span style="color:#808030; ">[</span>x <span style="color:#808030; ">+</span> y <span style="color:#808030; ">*</span> <span style="color:#008c00; ">200</span><span style="color:#808030; ">]</span> <span style="color:#808030; ">=</span> 0<span style="color:#800080; ">;</span>
    <span style="color:#800080; ">}</span>
  <span style="color:#800080; ">}</span>
<span style="color:#800080; ">}</span>
</pre>

<p>
The way most game worked around it was to avoid bank switching as much as possible. Wolfenstein 3D for example drew everything, from wall to sprites, including the HUD vertically for this very reason and even then only 72% of the screen was refreshed each frame to reach 11fps on a 386SX 16Mhz.
</p>

<div class='heading'>Another World on PC</div><hr/><p>
  With the limitations of the TGA/EGA/VGA in mind, porting Another World to PC looked like a daunting task. Not only you had to deal with the fragmentation, you also had to build an engine impossibly fast to met the requirements.

  <br/><br/>That challenge landed on Daniel Morais, then contracting at Delphine Software.<br/>
  
  <blockquote>
  Eric Chahi mandated all ports to have a framerate consistent with the Atari and Amiga version. Even on a lightweight PC with a 286 CPU, the game had to be able to run at 24 frames per second.<br/>
<br/>
<div>- Daniel Morais</div>

</blockquote>

</p>






<div class='heading'>Solving Fragmentation</div><hr/><p>
  To deal with the fragmentation of the graphics and sound systems, Daniel wrote an abstraction layer based on function pointers. 

  <blockquote>
    It would have been so much easier to write the PC DOS port using C. But Eric had written both the Atari ST and Amiga version in 68000 asm. I took it as a dare and challenged myself to do the same. In the end, the VM was 100% written in x86 asm.
<br/><br/>
<div>- Daniel Morais</div>

</blockquote>
<p style="margin-bottom: 1ch;">
  There was no PnP in 1991. To configure the game, users had to run CONFIG.EXE, a text-based tool, to detail their peripherals. 
 <table style="margin-bottom: 0ch;width: 100%; height: auto;">
  <tr>
    <td style="width: 50%;text-align: left;">
      <img loading="lazy" src="config.exe1.gif" class="pixel" width="466" height="400" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>    </td>
    <td style="width: 50%; text-align: right;">
      <img loading="lazy" src="config.exe2.gif" class="pixel" width="466" height="400" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>   </td>
</tr>
</table>
<p>
Parameters are saved in file CONFIG.DAT. When ANOTHER.EXE starts up, it reads the file and assign the function pointers based on the graphics and sound cards to drive.
</p>


   

<div class='heading'>Running with TGA</div><hr/><p>
  On a TGA graphic card there was no choice. Mode 9h provided 320x200 with 16 6-bit colors. Converting the palettes from 4-bit colors to 2-bit color automatically with LSR resulted in color aliasing. The solution was to convert all palettes by hand.
<br/><br/>
   The visual result is "special". Keep in mind that the issue at heart here is not the number of colors (TGA has 16) but the color depth.
  <br/>
  <br/>

  <img loading="lazy" src="ega_elevator.png" class="pixel" width="320" height="200" style="width: 100%; height: auto; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>The elevator (TGA/EGA)</small></i></span>

  <img loading="lazy" src="ega_office.png" class="pixel" width="320" height="200" style="width: 100%; height: auto; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>The office (TGA/EGA)</small></i></span>


  <img loading="lazy" src="ega_walk.png" class="pixel" width="320" height="200" style="width: 100%; height: auto; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>The exploration (TGA/EGA)</small></i></span>

  <img loading="lazy" src="ega_lester.png" class="pixel" width="320" height="200" style="width: 100%; height: auto; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>The encounter (TGA/EGA)</small></i></span>

  <img loading="lazy" src="ega_beast.png" class="pixel" width="320" height="200" style="width: 100%; height: auto; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>The beast (TGA/EGA)</small></i></span>
The result may not be to everybody's liking but i don't think much more could have been done with 6-bit colors. The  data layout being similar to the Atari ST we just studied, TGA will not be discussed further.
</p>
  
  <div class='heading'>Running with EGA</div><hr/><p>

  On an EGA graphic card the best mode to use was mode Dh. The same palettes designed for TGA are used since EGA color are also encoded on 6-bit. The rest works like the VGA.
</p>

<div class='heading'>Running with VGA</div><hr/><p>

  Things gets interesting on a VGA graphic card. At first sight it appeared mode 13h would have given the best visuals at the cost of wasting 4-bit per pixel. But Daniel found out that VGA card did not behave like EGA card in mode Dh. Palette upload did not expect 6-bit color but 18-bit color like in mode 13h. This allowed these cards to also run in mode Dh without wasting space but with the same visuals as the Amiga.
  <br/><br/>
   For this reason the game also shipped with the Amiga palettes (along with the TGA/EGA palettes). In this configuration, colors are up-sampled from 4-bit to 6-bit for each channel at runtime.<br/>

  <script type="text/javascript">
  function setScreenshot(e) {
    document.getElementById('pc_version.png').src='another_' + e.value + '.gif';
  }
</script>
  <img loading="lazy" src="another_vga.gif" class="pixel" width="320" height="200" id="pc_version.png" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 0;border: 1px black solid;"/>
<p style="margin-top: 0px;">
  <form >
    <div style="width: 100%; display: inline-block; margin-top: 0px;text-transform: none;">
      <center> The same scene in 
  <label><input type="radio" name="pc_version" value="ega" onclick="setScreenshot(this);">TGA</label>        
  <label><input type="radio" name="pc_version" value="ega" onclick="setScreenshot(this);">EGA</label>
  <label><input type="radio" name="pc_version" value="vga" onclick="setScreenshot(this);" checked="checked" >VGA</label>.
  </center>
</div>
</form>
</p>


<div class='heading'>TLDR; TGA/EGA/VGA</div><hr/><p>
  The game shipped with two sets of palettes. One 6-bit/color set for the TGA/EGA and the Amiga set for the VGA. In TGA, the game uses mode 9h. In EGA/VGA, the game runs in mode Dh.
</p>

<div class='heading'>Solving DRAWN and FILL</div><hr/><p>
  Drawing polygons is done, like on the Atari ST, entirely in software. A simple double Bresenham algorithm generates horizontal lines start and end screen space coordinates. Next came the problem to fill these lines fast enough.

  <blockquote>
  Luckily there was this fabulous computer book store in Paris called "Le monde en tique" with a supply of programming books you could not find anywhere else in France. I found one explaining in details the EGA/VGA latches and that helped a lot.
  <br/><br/>
<div>- Daniel Morais</div>

</blockquote>
<p>

   The trick was to leverage the fact that polygons are made of a single color and play with the bank selection. Instead of writing in one bank after an other, the bank mask can be configured to write to all banks at the same time.<br/>
  
  <img loading="lazy" src="vga_multi_write.svg" width="944.56488" height="377.10767" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>Writing 1 byte in RAM writes 4 bytes in VRAM</small></i></span>
  
  Performances depends on alignment but in the best case this trick transform a 1 bytes write into a 4 bytes write. This resulted in eight consecutive horizontal pixels set with a single byte written.
    <blockquote>
    I don't remember the exact figure but I remember drawing polygons was BLAZING FAST. With that 8x speed up, the framerate ended up well above the 24 fps goal we had set for ourselves.
<br/><br/>
<div>- Daniel Morais</div>

</blockquote>
</p>



<div class='heading'>Solving COPY</div><hr/><p>
  The last piece of the puzzle was to find a way to execute the COPY FB opcode fast enough. Again, at first it looked like this was going to knee-cap the port. Since the framebuffer were written in VRAM thanks to the bank selector trick, the only way to copy was apparently to bring back the framebuffer from VRAM to RAM for storage and write it back to VRAM on demand.

  <br/><br/>
  <img loading="lazy" src="vga_latch.svg" width="946.10889" height="165.4093" style="width: 60%; height: auto; float:right;margin-left: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>  The trick to solve this problem was widely documented by Michael Abrash in his article "Mode X Marks the Latch". Designers of the EGA/VGA were not complete sadists. To deal with bitplanes granularity and allow single bit to be plotted in bytes, each bank features a one byte latch. By "remembering" the last read byte, bit plotting is considerably facilitated.
  
  <br/><br/>
  The trick here is to re-purpose the latches. Instead of using them to plot a bit, there are used to read and write four bytes at a time.<Br/>

  <img loading="lazy" src="vga_copy.svg" width="1156.952" height="394.40451" style="width: 100%; height: auto; margin-top: 2ch; margin-bottom: 1ch;border: 1px black solid;"/>  <span style="text-align: center; display: block; margin-bottom: 1ch;"><i><small>EGA/VGA Latches and Bit Mask</small></i></span>
  
  By choosing to store the BKGD in VRAM along with the double buffers the COPY FB opcode was implemented with a 4x speed up.
</p>


<div class='heading'>Surprisingly difficult audio</div><hr/><p style="margin-bottom: 2ch;">
  In this series, the audio part was not discussed much since it was a "solved problem" on most platforms. Apparently with the PC DOS port this assumption did not hold true.<br/>
    <blockquote>
    The EGA/VGA part was not really complicated to write because it was mostly coding line filing of a single color or copying entire framebuffers from VRAM to VRAM. Once you knew how the EGA/VGA worked it was pretty easy.
<br/><br/>
    Where it became difficult was when I coded the audio part. The Amiga music had been composed with a tool a la Sound Tracker with audio samples played on four channels. On Amiga and ST it was a piece of cake since these machines had everything needed. But on PC it was a whole different story. These machine had a default "buzzer" and the lucky ones had an AdLib capable of FM playback. None had PCM capability like the Sound Blaster and the Gravis UltraSound later provided. 
<br/><br/>
To solve this issue, I had to modify the IRQ Timer (from 80 or 100 Hz to up to 8000Hz my memory is fuzzy about it). Which means the main program was interrupted 8,000 times per second to do something else. This something else absolutely had to be as short as possible otherwise the PC would crash. The goal was to make the PC Buzzer or AdLib vibrate at the desired frequency to simulated a PCM sample.
<br/><br/>
The result was far from the original but if you frown your ears you could kinda believe it. In any case it was better than no sound at all.
<br/><br/>
<div>- Daniel Morais</div>
</blockquote>

<p>
    <b><u>Trivia:</u></b> For the PC version, the distributor Interplay complained about the length of the game (which could be completed in a mere 20mn with some experience). To increase the duration, new levels were added to push the total from twelve to fifteen<a name="back_6" style="text-decoration: none;" href="index.html#footnote_6"><sup>[6]</sup></a>.
</p>

<div class='heading'>Verdict</div><hr/><p>
Daniel delivered a splendid port to Delphine Software. Running in the same resolution as the Atari ST and the Amiga (320x200 and 16 colors) he even managed to lower the minimum configuration to a 286 10Mhz CPU with 640 KiB RAM on ANY TGA, EGA, or VGA graphic card<a name="back_7" style="text-decoration: none;" href="index.html#footnote_7"><sup>[7]</sup></a>.
</p>

<div class='heading'>Next</div><hr/><p>
Another World on <a href="../another_world_polygons_Genesis/index.html">SEGA Genesis/MegaDrive</a>.
</p>
<style type='text/css'>td.ref {  padding-bottom: 0ch; width:0;}</style><div class='heading'>References</div><hr/><p id='paperbox' style='text-align:left;'><table><tbody style='vertical-align: top;'><tr><td class='ref' style='width:1ch;'><a name="footnote_1"></a><a href="index.html#back_1">^</a></td><td  class='ref' style='width:4ch;'> [1]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://en.wikipedia.org/wiki/Tandy_Graphics_Adapter#Incompatibilities">Tandy Graphics Adapter Incompatibilities</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_2"></a><a href="index.html#back_2">^</a></td><td  class='ref' style='width:4ch;'> [2]</td><td style='width:100%;text-align:left;' class='ref'><a href="http://www.oldskool.org/guides/tvdog/1000TL.html">TGA has 3 rows of 8 64kx4 DRAM. The four is the 128k upgrade.</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_3"></a><a href="index.html#back_3">^</a></td><td  class='ref' style='width:4ch;'> [3]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://archive.org/details/IBMPCJrTechnicalReference_201705/page/n83">IBM PCjr Technical Reference</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_4"></a><a href="index.html#back_4">^</a></td><td  class='ref' style='width:4ch;'> [4]</td><td style='width:100%;text-align:left;' class='ref'><a href="../gebb/index.html">Game Engine Black Book: Wolfenstein 3D clearScreen</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_5"></a><a href="index.html#back_5">^</a></td><td  class='ref' style='width:4ch;'> [5]</td><td style='width:100%;text-align:left;' class='ref'><a href="../gebb/index.html">Game Engine Black Book: Wolfenstein 3D p 127</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_6"></a><a href="index.html#back_6">^</a></td><td  class='ref' style='width:4ch;'> [6]</td><td style='width:100%;text-align:left;' class='ref'><a href="http://nerdlypleasures.blogspot.com/2013/01/another-world-aka-out-of-this-world.html">Another World, a.k.a. Out of this World - Versions of a Classic</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_7"></a><a href="index.html#back_7">^</a></td><td  class='ref' style='width:4ch;'> [7]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://www.mobygames.com/game/dos/out-of-this-world/cover-art/gameCoverId,783/">Mobygames, Another World DOS Box</a></td></tr></tbody></table></p> <hr>
 <center>*