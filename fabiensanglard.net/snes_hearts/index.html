<html>
<head>
  <link rel="alternate" type="application/rss+xml"  title="RSS Feed for fabiensanglard.net" href="https://fabiensanglard.net/rss.xml" />
  <style type="text/css">

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono.woff2');
      font-display: block;
    }

    @font-face {
      font-family: 'fabfont';
      src: url('../font/DejaVuSansMono-Bold.woff2');
      font-weight: bold;
      font-display: block;
    }

    * {
       font-size: 16px;
    }

    html {
      font-family: fabfont,  monospace;
      max-width: 900px;  /* For Desktop PC (see @media for Tablets/Phones) */
      padding-left: 2%;
      padding-right: 3%;
      margin: 0 auto;
      background: #F5F5F0;
  	} 
    


  	a {
      color: black;
      font-weight: bold;
    }

    img {
      border: none; 
    }

    p {
      margin-top: 0px;
      text-align: justify;
    }
    sup {
      vertical-align: 0.3em;
      font-size: 0.65em;
    }   

    pre {
      font-family: fabfont, monospace;
      background-color: white; 
      border: 1px solid Black; 
      padding-left: 2%;
      padding-top: 1ch;
      padding-bottom: 1ch;
      /* Only take care of X overflow since this is the only part that can be too wide.
         The Y axis will never overflow.
      */
      overflow: hidden;
    }

    div.heading {
      font-weight: bold;      
      text-transform: uppercase;
      margin-top: 4ch;
    }

    /** {
      font-size: 16px;
    }*/
    @media (max-width: 500px) { /* For small screen decices */
      * {
        font-size: 12px; 
      }
    }   
    .title {
      text-decoration: none;
    }

    img.pixel, canvas.pixel {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

  code {
    /*font-size: 110%;*/
    font-weight: bold;
    background-color: #e1e1e1;
    border-radius: 0.5ch;
    padding-left: 0.3ch;
    padding-right: 0.3ch;
  }

  .trivia {
    border-left: 1px black solid;
    padding-left: 1ch;
  }

  .trivia::before {
  font-weight: bold;
  text-decoration: underline;
  padding-right: 1ch;
  content: "Trivia:";

  </style>
  <title>The hearts of the Super Nintendo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=12.0, minimum-scale=1.0, user-scalable=yes">
</head>  
  <body><br><center>
    <div style="display: inline-block; vertical-align:middle;">
<a href="https://fabiensanglard.net/" class="title"><b>FABIEN SANGLARD'S WEBSITE</b><br>
</a><hr/><div style="text-align: justify;display: inline-block; width: 100%;">
<!-- <a class="title" href="/about/index.html">ABOUT</a> &nbsp;<a class="title" href="/contact/index.html">EMAIL</a> &nbsp;<a class="title" href="../rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">DONATE</a></div></div> -->
<a class="title" href="https://fabiensanglard.net/about/index.html">ABOUT</a> &nbsp;<a class="title" href="https://fabiensanglard.net/contact/index.html">CONTACT</a> &nbsp;<a class="title" href="https://fabiensanglard.net/rss.xml">RSS</a> &nbsp;<a class="title" href="https://paypal.me/fabiensanglard">GIVE</a></div></div>

</center><br><br>
<div style="margin-bottom: 2ch;text-transform: none;">
Apr 1, 2024</div>
<div class='heading'>The hearts of the Super Nintendo</div><hr/>
<style>
  img {
    border: solid 1px black;
  }
    blockquote { 
    background-color: #f3f3f3;
    border: dashed 1px grey; 
    width: 97.5%; 
    font-style: italic; 
    text-align: justify;

    padding: 1ch; 
    padding-top: 2ch; 
    padding-bottom: 2ch;     
    
    margin : 0ch; 
    margin-bottom: 2ch; 
    margin-top: 0ch;
  }

  blockquote div {
    text-transform: none;
    text-align: right;
    width: 100%;
  }

</style>

<p>When I start studying a vintage system, the first thing I like to do is understand how its components work together at the hardware level<a name="back_1" style="text-decoration: none;" href="index.html#footnote_1"><sup>[1]</sup></a>.
</p>


<p>Every computer has at least one heart which dictates the tempo to all the other chips. The <b>C</b>lo<b>CK</b> output pin is connected to a copper line which spreads to most components, into their <code>CLK</code> input pin.</p>

<p>If you are mostly a software person like me, you may have never noticed it but all kinds of processors have a <code>CLK</code> input pin. From CPUs (Motorola 68000<a name="back_2" style="text-decoration: none;" href="index.html#footnote_2"><sup>[2]</sup></a>, Intel Pentium<a name="back_3" style="text-decoration: none;" href="index.html#footnote_3"><sup>[3]</sup></a>, MOS 6502<a name="back_4" style="text-decoration: none;" href="index.html#footnote_4"><sup>[4]</sup></a>), to custom graphic chips (Midway's DMA2<a name="back_5" style="text-decoration: none;" href="index.html#footnote_5"><sup>[5]</sup></a>, Capcom CPS-A<a name="back_6" style="text-decoration: none;" href="index.html#footnote_6"><sup>[6]</sup></a>/CPS-B<a name="back_7" style="text-decoration: none;" href="index.html#footnote_7"><sup>[7]</sup></a>, Sega's Genesis VDP<a name="back_8" style="text-decoration: none;" href="index.html#footnote_8"><sup>[8]</sup></a>) to audio chips (Yamaha 2151<a name="back_9" style="text-decoration: none;" href="index.html#footnote_9"><sup>[9]</sup></a>, OKI msm6295<a name="back_10" style="text-decoration: none;" href="index.html#footnote_10"><sup>[10]</sup></a>), they all have one.</p>


<div class='heading'>How is the CLK generated?</div><hr/><p>The <code>CLK</code> can be generated by two types of components. One is a <a href="https://en.wikipedia.org/wiki/Crystal_oscillator#:~:text=The%20crystal%20oscillator%20circuit%20sustains,and%20size%20of%20the%20crystal">crystal oscillator</a> which usually looks like a flattened capsule. The others are named <a href="https://en.wikipedia.org/wiki/Ceramic_resonator">ceramic resonators</a>. These are <a href="ceramic_resonator_sideview.webp">vertical</a> capacitor which look less high-tech than the crystals (and they also happen to drift over time).
</p>

<table>
  <tr>
    <td width="50%"><img loading="lazy" src="crystal.webp" width="714" height="476" style="width: 100%; height: auto; "/></td>
    <td width="41.15%"><img loading="lazy" src="resonator.webp" width="450" height="365" style="width: 100%; height: auto; "/></td>
  </tr>
  <tr>
    <td style="text-align: center;">An oscillator</td>
    <td style="text-align: center;">A resonator</td>
    </tr>
</table>


<div class='heading'>Let's open it already!</div><hr/><p>With this in mind, let's peek inside a Super Nintendo. Can you find the <code>CLK</code> generators on a SNES motherboard? Clue: There are two.</p>

<img loading="lazy" src="Nintendo_SNS-CPU-GPM-02_SNES_Motherboard.webp" width="3095" height="3447" id="mobo" style="width: 100%; height: auto; margin-bottom:2ch;"/><span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>
<a href="https://consolemods.org/wiki/SNES:SNES_Model_Differences">Source</a>. Click the image to find the CLK generators.
</small></i></span>

<script>
var img = document.getElementById("mobo");  
img.onclick = function(){
  if (img.src.endsWith(".webp")) {
    img.src = "Nintendo_SNS-CPU-GPM-02_SNES_Motherboard.svg";
  } else {
    img.src = "Nintendo_SNS-CPU-GPM-02_SNES_Motherboard.webp";
  }
};


</script>

<div class='heading'>Two hearts</div><hr/><p>In the X2 slot, the blue thingy is a <code>24.576</code> MHz ceramic resonator. It is located on the side where the audio chips are so it sets the pace of the <b>A</b>udio <b>P</b>rocessing <b>U</b>nit.</p>

<p>In the X1 slot, the yellow one is labeled <code>D21L3</code>. It is a <code>21.300</code> MHz oscillator. It is located near (and sets the pace of) the CPU and the <b>P</b>icture <b>P</b>rocessing <b>U</b>nit.</p>


<div class='heading'>Documentation discrepancies</div><hr/><p>Looking at the Super Nintendo developer guide<a name="back_11" style="text-decoration: none;" href="index.html#footnote_11"><sup>[11]</sup></a> reveals it does not match our observations.</p>

<img loading="lazy" src="arch.webp" width="1588" height="1192" style="width: 100%; height: auto; margin-bottom:2ch;"/>
<p>
The diagram shows not two but three oscillators (there is one feeding the CIC chip, responsible for copy-protection). We are missing one!</p>

<p> Moreover, the frequency for the CPU/PPU is documented as <code>21.47727</code>MHz but we found a <code>21.300</code>Mhz oscillator (this is a PAL motherboard, an NTSC one would have featured a <code>21.500</code>Mhz oscillator).</p>

<p>What is going on here?</p>


<div class='heading'>CPU/PPU: From <code>21.500</code>MHz to <code>21.47727</code>MHz</div><hr/><p>If we look at the motherboard again, we will notice a red component in the lower left, just next to the oscillator. This red thingy is a variable capacitor (some people also call it a trimmer capacitor) which turns the <code>21.500</code> MHz frequency into <code>21.47727</code> MHz.</p>

<p>Why did the designers make it adjustable? The likely answer is that Nintendo feared the oscillator would deteriorate over time, and technicians would be able to tune it. They may not have been wrong since a common issue for the Super Nintendo console is to render in black and white. The solution is often to adjust the capacitor (or replace the oscillator)<a name="back_12" style="text-decoration: none;" href="index.html#footnote_12"><sup>[12]</sup></a>.
</p>

<div class='heading'>Dividers</div><hr/><p>There are only two "master" clocks in the console but none of the processors use them. What happens is that these masters go into dividers to create new clocks. The Ricoh 5A22 CPU for example, runs at 1/6 of the master clock, which results in <code>3.579545</code>MHz. Luckily, the SNES community (and <a href="<a href="https://problemkaputt.de/fullsnes.htm#snestimingoscillators">nocash</a> in particular) has documented all these dividers<a name="back_13" style="text-decoration: none;" href="index.html#footnote_13"><sup>[13]</sup></a>.</p>

<pre>NTSC Timings
  NTSC crystal      <font color="red">21.4772700</font>MHz (X1)
  NTSC color clock  3.57954500MHz (<font color="red">21.4772700</font>MHz/6)  (generated by PPU2 chip)
  NTSC master clock 21.4772700MHz (<font color="red">21.4772700</font>MHz/1)  (without multiplier/divider)
  NTSC dot clock    5.36931750MHz (<font color="red">21.4772700</font>MHz/4)  (generated by PPU chip)
  NTSC cpu clock    3.57954500MHz (<font color="red">21.4772700</font>MHz/6)  (without waitstates)
  NTSC cpu clock    2.68465875MHz (<font color="red">21.4772700</font>MHz/8)  (short waitstates)
  NTSC cpu clock    1.78977250MHz (<font color="red">21.4772700</font>MHz/12) (joypad waitstates)
  NTSC frame rate   60.09880627Hz (<font color="red">21.4772700</font>MHz/(262*1364-4/2))
 
APU Timings
  APU oscillator    <font color="blue">24.576</font>MHz (X2)
  DSP sample rate   32000Hz   (<font color="blue">24.576</font>MHz/24/32)
  SPC700 cpu clock  1.024MHz  (<font color="blue">24.576</font>MHz/24)
  SPC700 timer 0+1  8000Hz    (<font color="blue">24.576</font>MHz/24/128)
  SPC700 timer 2    64000Hz   (<font color="blue">24.576</font>MHz/24/16)
  CIC clock         3.072MHz  (<font color="blue">24.576</font>MHz/8)
  Expansion Port    8.192MHz  (<font color="blue">24.576</font>MHz/3)  
</pre>

<p>In total there are fifteen clocks in the Super Nintendo. Hopefully this solves the mystery of the "missing" oscillator from the documentation.</p>

<div class='heading'>Enhancement chips</div><hr/><p>The <code>SYS-CLK</code> (21.47727MHz) line is fed into the cartridge port. This signal is normally not needed by the components in the cartridge. These are made of ROM containing the game instructions and assets which don't need a clock signal. So why route it there?</p>

<p>The answer is that it allows cartridges to embed processors of their own, called enhancement chips<a name="back_14" style="text-decoration: none;" href="index.html#footnote_14"><sup>[14]</sup></a>. The most famous of these games is StarFox which features a "mario" SuperFX processor. The MARIO version has an internal divider which halves the clock to <code>10.738635</code>MHz. Later, GSU-1, versions ran at the full <code>21.47727</code>MHz clock.</p>



<img loading="lazy" src="SPAL-FO-1-pcb-front-9322.webp" width="800" height="601" style="width: 100%; height: auto; margin-bottom:2ch;"/><span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>
Starfox PCB (source <a href="https://snescentral.com/pcb.php?id=0636&num=12&side=front">snescentral</a>).
</small></i></span>

<p class="trivia">There is a second CLK line fed into the cartridge. It is <code>CIC-CLK</code> (3.072MHz) which is fed in the CIC chip located in the cartridge<a name="back_15" style="text-decoration: none;" href="index.html#footnote_15"><sup>[15]</sup></a>.</p> 


<p>However <code>SYS-CLK</code> (21.47727MHz) was not always suitable. Some games, like Megaman X2 used a CX4 enhancement chip for graphic effects. If we open a MM2 PCB, we find a <code>20</code> MHz oscillator (X1 slot) which feeds the CX4 <code>CLK</code> pin.
</p>

<img loading="lazy" src="SHVC-2DC0N-01-pcb-front.webp" width="700" height="508" style="width: 100%; height: auto; margin-bottom:2ch;"/><span style="text-align: center; display: block; margin-bottom: 2ch;"><i><small>
Megaman X2 PCB. Notice the 20Mhz oscillator (source <a href="https://snescentral.com/pcbboards.php?chip=SHVC-2DC0N-01">snescentral</a>).
</small></i></span>
<style type='text/css'>td.ref {  padding-bottom: 0ch; width:0;}</style><div class='heading'>References</div><hr/><p id='paperbox' style='text-align:left;'><table><tbody style='vertical-align: top;'><tr><td class='ref' style='width:1ch;'><a name="footnote_1"></a><a href="index.html#back_1">^</a></td><td  class='ref' style='width:4ch;'> [ 1]</td><td style='width:100%;text-align:left;' class='ref'>Of course it is not something you can do with modern system and their microscopic SOCs. But for 90's hardware such as the Super Nintendo, it is no problem..</td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_2"></a><a href="index.html#back_2">^</a></td><td  class='ref' style='width:4ch;'> [ 2]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://wiki.console5.com/wiki/File:MC68000-MC68HC000-MC68010-68-QP-Pinout.png">68000 pinout</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_3"></a><a href="index.html#back_3">^</a></td><td  class='ref' style='width:4ch;'> [ 3]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://datasheets.chipdb.org/Intel/x86/Pentium/24199710.PDF">Pentium pinout</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_4"></a><a href="index.html#back_4">^</a></td><td  class='ref' style='width:4ch;'> [ 4]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://user.xmission.com/~trevin/atari/6502_pinout.html">6502 pinout</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_5"></a><a href="index.html#back_5">^</a></td><td  class='ref' style='width:4ch;'> [ 5]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://www.arcade-museum.com/manuals-videogames/N/NBA_Jam_Kit_Operations_Manual_1643123101_April_1993.pdf">NBA Jam Kit</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_6"></a><a href="index.html#back_6">^</a></td><td  class='ref' style='width:4ch;'> [ 6]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://petitl.fr/cps2/DL-0311/">CPS-A schematics</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_7"></a><a href="index.html#back_7">^</a></td><td  class='ref' style='width:4ch;'> [ 7]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://petitl.fr/cps2/DL-0921/">CPS-B schematics</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_8"></a><a href="index.html#back_8">^</a></td><td  class='ref' style='width:4ch;'> [ 8]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://md.railgun.works/index.php?title=VDP">Genesis VDP schematics</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_9"></a><a href="index.html#back_9">^</a></td><td  class='ref' style='width:4ch;'> [ 9]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://fabiensanglard.net/sf2_sound_system/">STREET FIGHTER II, SOUND SYSTEM INTERNALS</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_10"></a><a href="index.html#back_10">^</a></td><td  class='ref' style='width:4ch;'> [10]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://fabiensanglard.net/sf2_sound_system/MSM6295.pdf">msm6295 datasheet</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_11"></a><a href="index.html#back_11">^</a></td><td  class='ref' style='width:4ch;'> [11]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://archive.org/details/SNESDevManual/book1/page/n97/mode/2up">SNES Development Manual, fig 2-22-1</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_12"></a><a href="index.html#back_12">^</a></td><td  class='ref' style='width:4ch;'> [12]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://www.instructables.com/Fixing-a-Super-Nintendo-That-Wont-Output-Color/">Fixing a Super Nintendo That Wonâ€™t Output Color</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_13"></a><a href="index.html#back_13">^</a></td><td  class='ref' style='width:4ch;'> [13]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://problemkaputt.de/fullsnes.htm#snestimingoscillators">SNES Timing Oscillators</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_14"></a><a href="index.html#back_14">^</a></td><td  class='ref' style='width:4ch;'> [14]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://www.youtube.com/watch?v=Q1UyQDqHBfA">SNES Enhancement Chips (Super FX, DSP1, S-DD1, SA-1 etc.)</a></td></tr><tr><td class='ref' style='width:1ch;'><a name="footnote_15"></a><a href="index.html#back_15">^</a></td><td  class='ref' style='width:4ch;'> [15]</td><td style='width:100%;text-align:left;' class='ref'><a href="https://fabiensanglard.net/10nes">10NES, the Super Nintendo copy protection</a></td></tr></tbody></table></p> <hr>
 <center>*