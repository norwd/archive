<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
	<title>Ètxelon - Consulta de pagaments</title>
	<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
	<META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
</head>

<body>

<h1 align=center>Ètxelon</h1>
<h2>Total de pagaments</h2>

<?php
	include("getdb.inc");
	$connexio = mysql_connect($mysql_server, $mysql_user, $mysql_password);
	mysql_select_db($mysql_db, $connexio);


	// Crides a funcions per obtenir parametres
	$habitants = obtenir_habitants($connexio);
	$num_habitants = count($habitants);
?>

<TABLE BORDER=1>
<TR>
	<TH ROWSPAN=2>Data
	<TH COLSPAN=<?php echo $num_habitants?>>Pagat
	<TH COLSPAN=<?php echo $num_habitants?>>Cobrat
	<TH ROWSPAN=2>Comentari
	<TH ROWSPAN=2>Eliminar
<TR>
<?php
		foreach($habitants as $i)
			echo "\t<TH>" . strtohtml($i["nom"]) . "\n";
		foreach($habitants as $i)
			echo "\t<TH>" . strtohtml($i["nom"]) . "\n";
?>

<?php
	$query = "SELECT UNIX_TIMESTAMP(data),comentari FROM pagaments ORDER BY data DESC";
	$resultat = mysql_query($query, $connexio);

	// Per cada pagament ...
	$num_pagaments = 0;
	while ($fila = mysql_fetch_row($resultat))
	{
		$data = $fila[0];
		$date_shown = date("d/m/Y H:i",$data);
		printf("<tr>\n\t<td><A HREF=\"view-pagament?id=%s\">%s</A>\n",
			$data, $date_shown);

		/*
		// Obtenim lo que toca pagar a cadascú
		$query = "SELECT pagadors.persona,pagadors.pagat,pagadors.cobrat FROM pagadors,gent WHERE pagadors.data = FROM_UNIXTIME($data) AND pagadors.persona = gent.id AND gent.habitant = 1 ORDER BY gent.nom;";
		$resultat2 = mysql_query($query, $connexio);
		
		while ($fila2 = mysql_fetch_row($resultat2))
		{
			$pagadors[$fila2[0]] = array( "pagat" => $fila2[1]);
		}
		*/
		$pagadors = obtenir_pagadors($data, $connexio);
		foreach($habitants as $i)
		{
			if (isset($pagadors[$i["id"]]))
				printf("\t<td align=right>%s\n", pricetohtml($pagadors[$i["id"]]["pagat"]));
			else
				printf("\t<td align=right>%s\n", pricetohtml(0));
		}
		foreach($habitants as $i)
		{
			if (isset($pagadors[$i["id"]]))
				printf("\t<td align=right>%s\n", pricetohtml($pagadors[$i["id"]]["cobrat"]));
			else
				printf("\t<td align=right>%s\n", pricetohtml(0));
		}
		// Comentari
		printf("\t<td>%s\n", strtohtml($fila[1]));
		// Eliminar
		printf("\t<td align=center><A HREF=\"delete-pagament?id=%s\">Eliminar</A>\n", $data);
		$num_pagaments++;
	}

?>
</TABLE>

<P>Hi ha un total de <?php echo $num_pagaments ?> pagaments. </P>

<HR WIDTH="70%">
<BR>
<A HREF="index">Tornar al menú d'inici</A>

</body>
</html>

